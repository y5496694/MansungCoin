<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë§ŒìŠ¹ ê²½ì œ êµì‹¤</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Visualization & Content Choices:
        - Wallet: KRW Balance (Stat), Asset Summary (Stat), Asset Allocation (Chart.js Donut). Data from Firestore.
        - Transfers: Form. Transactions logged to Firestore.
        - Stock Market: Tabs per stock. Price/Change/Volume (Stats from Firestore), User's AvgBuyPrice & ROI, Price History (Chart.js Line with time filters), Buy/Sell Forms (updates Firestore). AI Stock Analysis (Gemini API).
        - SHOP: Users can view items listed by admin. Purchase involves manual bank transfer based on displayed info. Admin can manage shop items.
        - AUCTION: Users can bid on items. Admin can create and manage auctions. Bids deduct balance, refunds on outbid/loss/cancellation. Deadline based.
        - Good Deeds: Submission Form (once per day check), Status List (data from Firestore). AI Deed Story Expansion (Gemini API).
        - Transactions: Table/List with filters (data from Firestore).
        - Settings: User name change, Password change (requires re-authentication).
        - Board: Notice (Admin write, User read), Freeboard (User write/read/edit-own/delete-own). Posts stored in Firestore.
        - Admin: Student list with edit name/reset password/view details/reset stock buttons, stock fluctuation settings, stock price manual update, SHOP ITEM MANAGEMENT, AUCTION MANAGEMENT.
        - Ranking: ROI and Total Asset ranking implemented.
        - All interactions via vanilla JS. Data stored in Firestore. NO SVG/Mermaid. -->
    <style>
        body { font-family: 'Inter', sans-serif; }
        .font-display { font-family: 'GmarketSansMedium', sans-serif; /* ì˜ˆì‹œ í°íŠ¸, ì‹¤ì œ ì‚¬ìš© ì‹œ ì›¹í°íŠ¸ ë¡œë“œ í•„ìš” */ }
        @media (max-width: 768px) {
            .sidebar { transform: translateX(-100%); transition: transform 0.3s ease-in-out; }
            .sidebar.open { transform: translateX(0); }
            .main-content { margin-left: 0; }
            .sidebar-toggle { display: block; }
        }
        @media (min-width: 769px) {
            .sidebar { transform: translateX(0); }
            .main-content { margin-left: 16rem; /* ì‚¬ì´ë“œë°” ë„ˆë¹„ë§Œí¼ */ }
            .sidebar-toggle { display: none; }
        }
        .chart-container { position: relative; width: 100%; max-width: 600px; margin-left: auto; margin-right: auto; height: 300px; max-height: 400px; }
        @media (min-width: 768px) { .chart-container { height: 350px; } }
        .tab-button.active, .board-tab-button.active, .ranking-tab-button.active, .auction-tab-button.active {
            border-bottom-color: #0d9488; /* teal-600 */
            color: #0d9488;
            font-weight: 600;
        }
        .time-filter-btn.active { background-color: #0d9488; color: white; }
        .modal, .ai-modal, .admin-modal, .post-modal, .shop-modal, .auction-modal { /* Added .auction-modal */
            display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); 
        }
        .modal-content, .ai-modal-content, .admin-modal-content, .post-modal-content, .shop-modal-content, .auction-modal-content { /* Added .auction-modal-content */
            background-color: #fefefe; margin: 10% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 600px; border-radius: 0.5rem; position: relative;
        }
        .post-modal-content { max-width: 700px; } 
        .close-button { color: #aaa; position: absolute; top: 10px; right: 15px; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close-button:hover, .close-button:focus { color: black; text-decoration: none; }
        .loading-spinner { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 10px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .post-content { white-space: pre-wrap; } 
        .shop-item-card, .auction-item-card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .shop-item-card:hover, .auction-item-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .countdown-timer { font-weight: bold; }
        .countdown-ended { color: #dc2626; /* red-600 */ } /* For ended timers */
        .countdown-soon { color: #f59e0b; /* amber-500 */ } /* For timers ending soon */
    </style>
</head>
<body class="bg-stone-100 text-stone-800">
    <div class="flex h-screen">
        <button id="sidebarToggle" class="sidebar-toggle fixed top-4 left-4 z-30 p-2 bg-teal-600 text-white rounded-md md:hidden">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
            </svg>
        </button>

        <aside id="sidebar" class="sidebar fixed inset-y-0 left-0 z-20 w-64 bg-teal-700 text-white p-6 space-y-2 shadow-lg md:translate-x-0 overflow-y-auto">
            <h1 class="text-3xl font-bold font-display">ë§ŒìŠ¹ ê²½ì œ êµì‹¤</h1>
            <nav class="space-y-1">
                <a href="#" data-section="dashboard" class="nav-link active-nav-link flex items-center space-x-2 px-3 py-2 rounded-md hover:bg-teal-600 transition-colors"><span>ğŸ </span><span>ë‚´ ì§€ê°‘</span></a>
                <a href="#" data-section="transfer" class="nav-link flex items-center space-x-2 px-3 py-2 rounded-md hover:bg-teal-600 transition-colors"><span>ğŸ’¸</span><span>ê³„ì¢Œ ì´ì²´</span></a>
                <a href="#" data-section="market" class="nav-link flex items-center space-x-2 px-3 py-2 rounded-md hover:bg-teal-600 transition-colors"><span>ğŸ“ˆ</span><span>ì£¼ì‹ ì‹œì¥</span></a>
                <a href="#" data-section="shopPage" class="nav-link flex items-center space-x-2 px-3 py-2 rounded-md hover:bg-teal-600 transition-colors"><span>ğŸ›ï¸</span><span>ìƒì </span></a>
                <a href="#" data-section="auctionPage" class="nav-link flex items-center space-x-2 px-3 py-2 rounded-md hover:bg-teal-600 transition-colors"><span>ğŸ›ï¸</span><span>ê²½ë§¤</span></a>
                <a href="#" data-section="board" class="nav-link flex items-center space-x-2 px-3 py-2 rounded-md hover:bg-teal-600 transition-colors"><span>ğŸ“¢</span><span>ê²Œì‹œíŒ</span></a>
                <a href="#" data-section="deeds" class="nav-link flex items-center space-x-2 px-3 py-2 rounded-md hover:bg-teal-600 transition-colors"><span>ğŸŒŸ</span><span>ë‚˜ì˜ ì„ í–‰</span></a>
                <a href="#" data-section="transactions" class="nav-link flex items-center space-x-2 px-3 py-2 rounded-md hover:bg-teal-600 transition-colors"><span>ğŸ§¾</span><span>ê±°ë˜ ë‚´ì—­</span></a>
                <a href="#" data-section="ranking" class="nav-link flex items-center space-x-2 px-3 py-2 rounded-md hover:bg-teal-600 transition-colors"><span>ğŸ†</span><span>ë­í‚¹</span></a>
                <hr class="border-teal-500">
                <a href="#" data-section="settings" class="nav-link flex items-center space-x-2 px-3 py-2 rounded-md hover:bg-teal-600 transition-colors"><span>ğŸ”§</span><span>í™˜ê²½ ì„¤ì •</span></a>
                <hr id="adminDivider" class="border-teal-500 hidden">
                <a href="#" id="adminNavLink" data-section="admin" class="nav-link flex items-center space-x-2 px-3 py-2 rounded-md hover:bg-teal-600 transition-colors hidden"><span>âš™ï¸</span><span>ê´€ë¦¬ì</span></a>
                <a href="#" id="loginLink" data-section="login" class="nav-link flex items-center space-x-2 px-3 py-2 rounded-md hover:bg-teal-600 transition-colors"><span>ğŸ”‘</span><span id="loginLinkText">ë¡œê·¸ì¸</span></a>
            </nav>
            <div class="absolute bottom-4 left-4 text-sm"><p>ë¡œê·¸ì¸: <span id="loggedInUserDisplay">ë¡œê·¸ì¸ í•„ìš”</span></p></div>
        </aside>

        <main id="mainContent" class="main-content flex-1 p-6 md:p-10 overflow-y-auto">
            <section id="login" class="hidden space-y-6 max-w-md mx-auto bg-white p-8 rounded-xl shadow-lg">
                <h2 class="text-3xl font-semibold text-teal-800 text-center">ë¡œê·¸ì¸</h2>
                <p class="text-stone-600 text-center">ë§ŒìŠ¹ ê²½ì œ êµì‹¤ì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤!</p>
                <form id="loginForm" class="space-y-4">
                    <div><label for="email" class="block text-sm font-medium text-stone-700">ì´ë©”ì¼</label><input type="email" id="email" name="email" required class="mt-1 block w-full p-3 border border-stone-300 rounded-md shadow-sm focus:ring-teal-500 focus:border-teal-500 text-lg" placeholder="your@email.com"></div>
                    <div><label for="password" class="block text-sm font-medium text-stone-700">ë¹„ë°€ë²ˆí˜¸</label><input type="password" id="password" name="password" required class="mt-1 block w-full p-3 border border-stone-300 rounded-md shadow-sm focus:ring-teal-500 focus:border-teal-500 text-lg" placeholder="********"></div>
                    <button type="submit" class="w-full bg-teal-500 hover:bg-teal-600 text-white font-bold py-3 px-4 rounded-lg shadow-md transition-transform hover:scale-105 text-lg">ë¡œê·¸ì¸</button>
                </form>
                <p class="text-sm text-center text-stone-500">ê³„ì •ì´ ì—†ìœ¼ì‹ ê°€ìš”? <a href="#" id="switchToRegister" class="text-teal-600 hover:underline">íšŒì›ê°€ì…</a></p>
                <p id="authError" class="text-sm text-center text-red-500 hidden"></p>
            </section>

            <section id="register" class="hidden space-y-6 max-w-md mx-auto bg-white p-8 rounded-xl shadow-lg">
                <h2 class="text-3xl font-semibold text-teal-800 text-center">íšŒì›ê°€ì…</h2>
                <form id="registerForm" class="space-y-4">
                    <div><label for="registerName" class="block text-sm font-medium text-stone-700">ì´ë¦„</label><input type="text" id="registerName" name="name" required class="mt-1 block w-full p-3 border border-stone-300 rounded-md shadow-sm focus:ring-teal-500 focus:border-teal-500 text-lg" placeholder="ê¹€ë§ŒìŠ¹"></div>
                    <div><label for="registerEmail" class="block text-sm font-medium text-stone-700">ì´ë©”ì¼</label><input type="email" id="registerEmail" name="email" required class="mt-1 block w-full p-3 border border-stone-300 rounded-md shadow-sm focus:ring-teal-500 focus:border-teal-500 text-lg" placeholder="your@email.com"></div>
                    <div><label for="registerPassword" class="block text-sm font-medium text-stone-700">ë¹„ë°€ë²ˆí˜¸</label><input type="password" id="registerPassword" name="password" required minlength="6" class="mt-1 block w-full p-3 border border-stone-300 rounded-md shadow-sm focus:ring-teal-500 focus:border-teal-500 text-lg" placeholder="6ì ì´ìƒ"></div>
                    <button type="submit" class="w-full bg-sky-500 hover:bg-sky-600 text-white font-bold py-3 px-4 rounded-lg shadow-md transition-transform hover:scale-105 text-lg">íšŒì›ê°€ì…</button>
                </form>
                <p class="text-sm text-center text-stone-500">ì´ë¯¸ ê³„ì •ì´ ìˆìœ¼ì‹ ê°€ìš”? <a href="#" id="switchToLogin" class="text-teal-600 hover:underline">ë¡œê·¸ì¸</a></p>
                <p id="registerAuthError" class="text-sm text-center text-red-500 hidden"></p>
            </section>

            <section id="dashboard" class="hidden space-y-6">
                <h2 class="text-3xl font-semibold text-teal-800">ğŸ  ë‚´ ì§€ê°‘ í˜„í™©</h2>
                <p class="text-stone-600">ë‚˜ì˜ í˜„ì¬ ìì‚° ìƒíƒœì™€ ë³´ìœ  í˜„í™©ì„ í•œëˆˆì— ë³¼ ìˆ˜ ìˆì–´ìš”.</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-xl shadow-lg"><h3 class="text-xl font-semibold text-teal-700 mb-2">ğŸ’° í˜„ì¬ ì”ì•¡ (KRW)</h3><p id="currentBalance" class="text-4xl font-bold text-sky-600">0 ì›</p></div>
                    <div class="bg-white p-6 rounded-xl shadow-lg"><h3 class="text-xl font-semibold text-teal-700 mb-2">ğŸ“Š ì´ ìì‚° ê°€ì¹˜</h3><p id="totalAssetValue" class="text-4xl font-bold text-emerald-600">0 ì›</p><p class="text-sm text-stone-500">(í˜„ê¸ˆ + ì£¼ì‹ í‰ê°€ì•¡)</p></div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-lg"><h3 class="text-xl font-semibold text-teal-700 mb-4">ğŸ¨ ìì‚° êµ¬ì„±</h3><div class="chart-container h-64 md:h-80"><canvas id="assetAllocationChart"></canvas></div></div>
                <div class="mt-8 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                    <button data-section="transfer" class="quick-action-button bg-sky-500 hover:bg-sky-600 text-white font-semibold py-3 px-4 rounded-lg shadow-md transition-transform hover:scale-105">ğŸ’¸ ê³„ì¢Œ ì´ì²´í•˜ê¸°</button>
                    <button data-section="market" class="quick-action-button bg-emerald-500 hover:bg-emerald-600 text-white font-semibold py-3 px-4 rounded-lg shadow-md transition-transform hover:scale-105">ğŸ“ˆ ì£¼ì‹ ê±°ë˜í•˜ê¸°</button>
                    <button data-section="shopPage" class="quick-action-button bg-orange-500 hover:bg-orange-600 text-white font-semibold py-3 px-4 rounded-lg shadow-md transition-transform hover:scale-105">ğŸ›ï¸ ìƒì  ë°”ë¡œê°€ê¸°</button>
                    <button data-section="auctionPage" class="quick-action-button bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-3 px-4 rounded-lg shadow-md transition-transform hover:scale-105">ğŸ›ï¸ ê²½ë§¤ ì°¸ì—¬í•˜ê¸°</button>
                    <button data-section="deeds" class="quick-action-button bg-amber-500 hover:bg-amber-600 text-white font-semibold py-3 px-4 rounded-lg shadow-md transition-transform hover:scale-105">ğŸŒŸ ì„ í–‰ ë“±ë¡í•˜ê¸°</button>
                </div>
            </section>

            <section id="transfer" class="hidden space-y-6">
                <h2 class="text-3xl font-semibold text-teal-800">ğŸ’¸ ê³„ì¢Œ ì´ì²´</h2>
                <p class="text-stone-600">ì¹œêµ¬ì—ê²Œ ëˆì„ ë³´ë‚¼ ìˆ˜ ìˆì–´ìš”. ì •í™•í•œ ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.</p>
                <div class="bg-white p-8 rounded-xl shadow-lg max-w-lg mx-auto">
                    <form id="transferForm" class="space-y-4">
                        <div><label for="recipient" class="block text-sm font-medium text-stone-700">ë°›ëŠ” ì‚¬ëŒ (ì´ë©”ì¼)</label><input type="email" id="recipient" name="recipient" required class="mt-1 block w-full p-3 border border-stone-300 rounded-md shadow-sm focus:ring-teal-500 focus:border-teal-500 text-lg" placeholder="friend@email.com"></div>
                        <div><label for="transferAmount" class="block text-sm font-medium text-stone-700">ë³´ë‚¼ ê¸ˆì•¡ (ì›)</label><input type="number" id="transferAmount" name="transferAmount" min="100" step="100" required class="mt-1 block w-full p-3 border border-stone-300 rounded-md shadow-sm focus:ring-teal-500 focus:border-teal-500 text-lg" placeholder="ì˜ˆ: 5000"></div>
                        <div><label for="transferMemo" class="block text-sm font-medium text-stone-700">ë©”ëª¨ (ì„ íƒ)</label><input type="text" id="transferMemo" name="transferMemo" class="mt-1 block w-full p-3 border border-stone-300 rounded-md shadow-sm focus:ring-teal-500 focus:border-teal-500 text-lg" placeholder="ì˜ˆ: ìƒì¼ ì¶•í•˜í•´!"></div>
                        <button type="submit" class="w-full bg-sky-500 hover:bg-sky-600 text-white font-bold py-3 px-4 rounded-lg shadow-md transition-transform hover:scale-105 text-lg">ë³´ë‚´ê¸°</button>
                    </form>
                </div>
            </section>

            <section id="market" class="hidden space-y-6">
                <h2 class="text-3xl font-semibold text-teal-800">ğŸ“ˆ ì£¼ì‹ ì‹œì¥</h2>
                <p class="text-stone-600">ë‹¤ì–‘í•œ ì£¼ì‹ì„ ì‚¬ê³  íŒ” ìˆ˜ ìˆì–´ìš”. ì‹ ì¤‘í•˜ê²Œ íˆ¬ìí•˜ì„¸ìš”!</p>
                <div><div class="border-b border-stone-200 mb-4"><nav class="-mb-px flex space-x-8" aria-label="Tabs" id="marketTabsContainer"></nav></div><div id="marketContent" class="space-y-6"></div></div>
            </section>

            <section id="shopPage" class="hidden space-y-6">
                <h2 class="text-3xl font-semibold text-teal-800">ğŸ›ï¸ ë§ŒìŠ¹ ìƒì </h2>
                <p class="text-stone-600">ì„ ìƒë‹˜ë“¤ì´ ì¤€ë¹„í•œ íŠ¹ë³„í•œ ë¬¼í’ˆë“¤ì„ ë§Œë‚˜ë³´ì„¸ìš”!</p>
                <div id="shopItemList" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6"><p class="text-stone-500 col-span-full text-center">ìƒì  ë¬¼í’ˆì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p></div>
            </section>

            <section id="auctionPage" class="hidden space-y-6">
                <h2 class="text-3xl font-semibold text-teal-800">ğŸ›ï¸ ë§ŒìŠ¹ ê²½ë§¤ì¥</h2>
                <p class="text-stone-600">í¬ê·€í•œ ë¬¼í’ˆì„ ì–»ì„ ìˆ˜ ìˆëŠ” ê¸°íšŒ! ì‹ ì¤‘í•˜ê²Œ ì…ì°°í•˜ì„¸ìš”.</p>
                <div class="border-b border-stone-200 mb-4">
                    <nav class="-mb-px flex space-x-8" aria-label="AuctionTabs">
                        <button data-auctiontype="active" class="auction-tab-button active py-3 px-1 border-b-2 border-teal-600 text-teal-600 whitespace-nowrap text-sm font-medium">ì§„í–‰ì¤‘ì¸ ê²½ë§¤</button>
                        <button data-auctiontype="past" class="auction-tab-button py-3 px-1 border-b-2 border-transparent text-stone-500 hover:text-teal-600 hover:border-teal-600 whitespace-nowrap text-sm font-medium">ì§€ë‚œ ê²½ë§¤</button>
                    </nav>
                </div>
                <div id="auctionContentActive" class="auction-content-area grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                    <p class="text-stone-500 col-span-full text-center">ì§„í–‰ì¤‘ì¸ ê²½ë§¤ ë¬¼í’ˆì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>
                </div>
                <div id="auctionContentPast" class="auction-content-area hidden grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                    <p class="text-stone-500 col-span-full text-center">ì§€ë‚œ ê²½ë§¤ ë¬¼í’ˆì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>
                </div>
            </section>

            <section id="board" class="hidden space-y-6">
                <h2 class="text-3xl font-semibold text-teal-800">ğŸ“¢ ê²Œì‹œíŒ</h2>
                <div class="border-b border-stone-200 mb-4">
                    <nav class="-mb-px flex space-x-8" aria-label="BoardTabs">
                        <button data-boardtype="notice" class="board-tab-button active py-3 px-1 border-b-2 border-teal-600 text-teal-600 whitespace-nowrap text-sm font-medium">ê³µì§€ì‚¬í•­</button>
                        <button data-boardtype="freeboard" class="board-tab-button py-3 px-1 border-b-2 border-transparent text-stone-500 hover:text-teal-600 hover:border-teal-600 whitespace-nowrap text-sm font-medium">ììœ ê²Œì‹œíŒ</button>
                    </nav>
                </div>
                <div id="boardContentNotice" class="board-content-area space-y-4">
                    <div class="flex justify-between items-center"><h3 class="text-xl font-semibold text-teal-700">ê³µì§€ì‚¬í•­ ëª©ë¡</h3><button id="newNoticePostBtn" class="bg-teal-500 hover:bg-teal-600 text-white font-semibold py-2 px-4 rounded-lg text-sm hidden">ìƒˆ ê³µì§€ ì‘ì„±</button></div>
                    <ul id="noticePostList" class="space-y-3"></ul>
                </div>
                <div id="boardContentFreeboard" class="board-content-area hidden space-y-4">
                    <div class="flex justify-between items-center"><h3 class="text-xl font-semibold text-teal-700">ììœ ê²Œì‹œíŒ ëª©ë¡</h3><button id="newFreePostBtn" class="bg-sky-500 hover:bg-sky-600 text-white font-semibold py-2 px-4 rounded-lg text-sm">ìƒˆ ê¸€ ì‘ì„±</button></div>
                    <ul id="freePostList" class="space-y-3"></ul>
                </div>
            </section>

            <section id="deeds" class="hidden space-y-6">
                <h2 class="text-3xl font-semibold text-teal-800">ğŸŒŸ ë‚˜ì˜ ì„ í–‰</h2>
                <p class="text-stone-600">ì°©í•œ ì¼ì„ í•˜ê³  ë‚´ìš©ì„ ê¸°ë¡í•˜ë©´ ìš©ëˆì„ ë°›ì„ ìˆ˜ ìˆì–´ìš”! (1ê±´ë‹¹ 1,000ì›, í•˜ë£¨ 1ë²ˆ)</p>
                <div class="bg-white p-8 rounded-xl shadow-lg max-w-lg mx-auto">
                    <form id="deedForm" class="space-y-4">
                        <div><label for="deedDescription" class="block text-sm font-medium text-stone-700">ì„ í–‰ ë‚´ìš©</label><textarea id="deedDescription" name="deedDescription" rows="4" required class="mt-1 block w-full p-3 border border-stone-300 rounded-md shadow-sm focus:ring-teal-500 focus:border-teal-500 text-lg" placeholder="ì˜ˆ: ì¹œêµ¬ì˜ ìˆ™ì œë¥¼ ë„ì™€ì£¼ì—ˆìŠµë‹ˆë‹¤."></textarea></div>
                        <button type="submit" id="submitDeedBtn" class="w-full bg-amber-500 hover:bg-amber-600 text-white font-bold py-3 px-4 rounded-lg shadow-md transition-transform hover:scale-105 text-lg">ì„ í–‰ ë“±ë¡í•˜ê¸°</button>
                    </form>
                </div>
                <div class="mt-8 bg-white p-6 rounded-xl shadow-lg"><h3 class="text-xl font-semibold text-teal-700 mb-4">ë‚˜ì˜ ì„ í–‰ ê¸°ë¡</h3><ul id="deedList" class="space-y-3 max-h-96 overflow-y-auto"><li class="p-3 bg-stone-50 rounded-md border border-stone-200">ë“±ë¡ëœ ì„ í–‰ì´ ì—†ìŠµë‹ˆë‹¤.</li></ul></div>
            </section>

            <section id="transactions" class="hidden space-y-6">
                <h2 class="text-3xl font-semibold text-teal-800">ğŸ§¾ ê±°ë˜ ë‚´ì—­</h2>
                <p class="text-stone-600">ëª¨ë“  ëˆê³¼ ì£¼ì‹ ê±°ë˜ ê¸°ë¡ì„ í™•ì¸í•  ìˆ˜ ìˆì–´ìš”.</p>
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-semibold text-teal-700">ìµœê·¼ ê±°ë˜</h3>
                        <select id="transactionFilter" class="p-2 border border-stone-300 rounded-md focus:ring-teal-500 focus:border-teal-500">
                            <option value="all">ëª¨ë“  ë‚´ì—­</option><option value="transfer_in">ì…ê¸ˆ</option><option value="transfer_out">ì¶œê¸ˆ</option>
                            <option value="buy">ë§¤ìˆ˜</option><option value="sell">ë§¤ë„</option><option value="deed">ì„ í–‰ë³´ìƒ</option>
                            <option value="admin_credit">ê´€ë¦¬ì ì§€ê¸‰</option><option value="admin_debit">ê´€ë¦¬ì íšŒìˆ˜</option>
                            <option value="auction_bid">ê²½ë§¤ ì…ì°°</option><option value="auction_bid_cancel">ê²½ë§¤ ì…ì°° ì·¨ì†Œ</option><option value="auction_refund_lost">ê²½ë§¤ ë‚™ì°°ì‹¤íŒ¨ í™˜ë¶ˆ</option>
                        </select>
                    </div>
                    <div class="overflow-x-auto"><table class="min-w-full divide-y divide-stone-200"><thead class="bg-stone-50"><tr><th scope="col" class="px-6 py-3 text-left text-xs font-medium text-stone-500 uppercase tracking-wider">ë‚ ì§œ/ì‹œê°„</th><th scope="col" class="px-6 py-3 text-left text-xs font-medium text-stone-500 uppercase tracking-wider">ì¢…ë¥˜</th><th scope="col" class="px-6 py-3 text-left text-xs font-medium text-stone-500 uppercase tracking-wider">ë‚´ìš©</th><th scope="col" class="px-6 py-3 text-right text-xs font-medium text-stone-500 uppercase tracking-wider">ê¸ˆì•¡/ìˆ˜ëŸ‰</th><th scope="col" class="px-6 py-3 text-right text-xs font-medium text-stone-500 uppercase tracking-wider">ì”ì•¡/ë³´ìœ ëŸ‰</th></tr></thead><tbody id="transactionList" class="bg-white divide-y divide-stone-200"><tr><td colspan="5" class="text-center py-4 text-stone-500">ê±°ë˜ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr></tbody></table></div>
                </div>
            </section>

            <section id="settings" class="hidden space-y-6 max-w-lg mx-auto">
                <h2 class="text-3xl font-semibold text-teal-800">ğŸ”§ í™˜ê²½ ì„¤ì •</h2>
                <div class="bg-white p-8 rounded-xl shadow-lg">
                    <form id="settingsForm" class="space-y-4"><div><label for="userName" class="block text-sm font-medium text-stone-700">ì´ë¦„ ë³€ê²½</label><input type="text" id="userName" name="userName" required class="mt-1 block w-full p-3 border border-stone-300 rounded-md shadow-sm focus:ring-teal-500 focus:border-teal-500 text-lg" placeholder="ìƒˆë¡œìš´ ì´ë¦„"></div><button type="submit" class="w-full bg-teal-500 hover:bg-teal-600 text-white font-bold py-3 px-4 rounded-lg shadow-md transition-transform hover:scale-105 text-lg">ì´ë¦„ ì €ì¥</button></form>
                    <div class="mt-6"><h3 class="text-xl font-semibold text-teal-700 mb-2">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</h3><form id="changePasswordForm" class="space-y-4"><div><label for="currentPassword" class="block text-sm font-medium text-stone-700">í˜„ì¬ ë¹„ë°€ë²ˆí˜¸</label><input type="password" id="currentPassword" required class="mt-1 block w-full p-3 border border-stone-300 rounded-md shadow-sm"></div><div><label for="newPassword" class="block text-sm font-medium text-stone-700">ìƒˆ ë¹„ë°€ë²ˆí˜¸</label><input type="password" id="newPassword" required minlength="6" class="mt-1 block w-full p-3 border border-stone-300 rounded-md shadow-sm"></div><div><label for="confirmNewPassword" class="block text-sm font-medium text-stone-700">ìƒˆ ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label><input type="password" id="confirmNewPassword" required class="mt-1 block w-full p-3 border border-stone-300 rounded-md shadow-sm"></div><button type="submit" class="w-full bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 px-4 rounded-lg shadow-md">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</button></form></div>
                </div>
            </section>

            <section id="ranking" class="hidden space-y-6">
                <h2 class="text-3xl font-semibold text-teal-800">ğŸ† ë­í‚¹</h2>
                <p class="text-stone-600">ë‹¤ë¥¸ ì¹œêµ¬ë“¤ê³¼ ìì‚° ë° ìˆ˜ìµë¥ ì„ ë¹„êµí•´ë³´ì„¸ìš”!</p>
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <div class="border-b border-stone-200 mb-4"><nav class="-mb-px flex space-x-8" aria-label="RankingTabs"><button data-rankingtype="totalAsset" class="ranking-tab-button active py-3 px-1 border-b-2 border-teal-600 text-teal-600 whitespace-nowrap text-sm font-medium">ì´ ìì‚° ë­í‚¹</button><button data-rankingtype="roi" class="ranking-tab-button py-3 px-1 border-b-2 border-transparent text-stone-500 hover:text-teal-600 hover:border-teal-600 whitespace-nowrap text-sm font-medium">ìˆ˜ìµë¥  ë­í‚¹</button></nav></div>
                    <div id="rankingContentTotalAsset" class="ranking-content-area"><h3 class="text-xl font-semibold text-teal-700 mb-2">ğŸ’° ì´ ìì‚° TOP 10</h3><ul id="totalAssetRankingList" class="space-y-2"><li class="text-center text-stone-500 py-4">ë­í‚¹ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</li></ul></div>
                    <div id="rankingContentRoi" class="ranking-content-area hidden"><h3 class="text-xl font-semibold text-teal-700 mb-2">ğŸ“ˆ ìˆ˜ìµë¥  TOP 10</h3><ul id="roiRankingList" class="space-y-2"><li class="text-center text-stone-500 py-4">ìˆ˜ìµë¥  ë­í‚¹ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</li></ul></div>
                </div>
            </section>

            <section id="admin" class="hidden space-y-6">
                <h2 class="text-3xl font-semibold text-red-700">âš™ï¸ ê´€ë¦¬ì í˜ì´ì§€ (êµì‚¬ìš©)</h2>
                <p class="text-stone-600">ì´ í˜ì´ì§€ëŠ” êµì‚¬ë§Œ ì ‘ê·¼í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. í•™ìƒ ì •ë³´, ì‹œì¥, ìƒì , ê²½ë§¤ë¥¼ ê´€ë¦¬í•©ë‹ˆë‹¤.</p>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div class="bg-white p-6 rounded-xl shadow-lg"><h3 class="text-xl font-semibold text-red-600 mb-2">í•™ìƒ ê´€ë¦¬</h3><ul id="adminStudentList" class="space-y-2 text-sm max-h-96 overflow-y-auto"><li>ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</li></ul></div>
                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        <h3 class="text-xl font-semibold text-red-600 mb-2">ì‹œì¥ ê´€ë¦¬</h3><button id="randomizePricesBtn" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg text-sm">ì£¼ê°€ ì„ì˜ ë³€ê²½</button>
                        <div class="mt-4"><h4 class="text-md font-semibold text-red-500 mb-1">ì£¼ì‹ ê°€ê²© ìˆ˜ë™ ë³€ê²½</h4><select id="adminStockSelect" class="p-2 border rounded mb-2 w-full"></select><input type="number" id="adminNewPrice" placeholder="ìƒˆ ê°€ê²©" class="p-2 border rounded w-full mb-2"><button id="adminUpdatePriceBtn" class="bg-orange-500 hover:bg-orange-600 text-white font-semibold py-2 px-4 rounded-lg text-sm w-full">ê°€ê²© ì—…ë°ì´íŠ¸</button></div>
                        <div id="adminStockFluctuationSettings" class="mt-6"><h4 class="text-md font-semibold text-red-500 mb-1">ì£¼ì‹ ë³€ë™í­ ì„¤ì •</h4></div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-lg"><h3 class="text-xl font-semibold text-red-600 mb-2">ì„ í–‰ ìŠ¹ì¸ ê´€ë¦¬</h3><p class="text-sm text-stone-500 mb-2">í˜„ì¬ ìë™ ìŠ¹ì¸. ìˆ˜ë™ ìŠ¹ì¸ ê¸°ëŠ¥ì€ ì¶”í›„ êµ¬í˜„.</p></div>
                    <div class="bg-white p-6 rounded-xl shadow-lg md:col-span-1 lg:col-span-1">
                        <h3 class="text-xl font-semibold text-purple-600 mb-2">ğŸ›ï¸ ìƒì  ë¬¼í’ˆ ê´€ë¦¬</h3><button id="adminAddNewShopItemBtn" class="bg-purple-500 hover:bg-purple-600 text-white font-semibold py-2 px-4 rounded-lg text-sm mb-4">ìƒˆ ìƒì ë¬¼í’ˆ ë“±ë¡</button><div id="adminShopItemList" class="space-y-3 max-h-96 overflow-y-auto"><p class="text-stone-500">ìƒì  ë¬¼í’ˆ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p></div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-lg md:col-span-2 lg:col-span-2">
                        <h3 class="text-xl font-semibold text-indigo-600 mb-2">ğŸ›ï¸ ê²½ë§¤ ë¬¼í’ˆ ê´€ë¦¬</h3><button id="adminAddNewAuctionItemBtn" class="bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg text-sm mb-4">ìƒˆ ê²½ë§¤ë¬¼í’ˆ ë“±ë¡</button><div id="adminAuctionItemList" class="space-y-3 max-h-96 overflow-y-auto"><p class="text-stone-500">ê²½ë§¤ ë¬¼í’ˆ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p></div>
                    </div>
                </div>
            </section>
            
            <section id="adminUserDetail" class="hidden space-y-6">
                <button id="backToAdminListBtn" class="mb-4 bg-stone-500 hover:bg-stone-600 text-white font-semibold py-2 px-4 rounded-lg text-sm">â† í•™ìƒ ëª©ë¡ìœ¼ë¡œ</button>
                <h2 id="adminUserDetailName" class="text-3xl font-semibold text-blue-700">í•™ìƒ ìƒì„¸ ì •ë³´</h2>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg"><h3 class="text-xl font-semibold text-blue-600 mb-2">ë³´ìœ  ì£¼ì‹</h3><ul id="adminUserPortfolioList" class="space-y-1 text-sm"></ul></div>
                    <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-lg">
                        <h3 class="text-xl font-semibold text-blue-600 mb-2">ê±°ë˜ ë‚´ì—­</h3><div class="overflow-x-auto max-h-96"><table class="min-w-full divide-y divide-stone-200 text-sm"><thead class="bg-stone-50 sticky top-0"><tr><th class="px-3 py-2 text-left">ë‚ ì§œ</th><th class="px-3 py-2 text-left">ì¢…ë¥˜</th><th class="px-3 py-2 text-left">ë‚´ìš©</th><th class="px-3 py-2 text-right">ê¸ˆì•¡/ìˆ˜ëŸ‰</th></tr></thead><tbody id="adminUserTransactionList" class="bg-white divide-y divide-stone-200"></tbody></table></div>
                    </div>
                    <div class="lg:col-span-3 bg-white p-6 rounded-xl shadow-lg"><h3 class="text-xl font-semibold text-blue-600 mb-2">ì„ í–‰ ê¸°ë¡</h3><ul id="adminUserDeedList" class="space-y-2 text-sm max-h-60 overflow-y-auto"></ul></div>
                </div>
            </section>
        </main>
    </div>

    <div id="infoModal" class="modal"><div class="modal-content"><span id="closeInfoModalBtn" class="close-button">&times;</span><h3 id="modalTitle" class="text-xl font-semibold mb-2">ì•Œë¦¼</h3><p id="modalMessage" class="text-stone-700 whitespace-pre-wrap"></p><div class="mt-4 text-right"><button id="confirmInfoModalBtn" class="bg-teal-500 hover:bg-teal-600 text-white font-semibold py-2 px-4 rounded-lg">í™•ì¸</button></div></div></div>
    <div id="aiContentModal" class="ai-modal"><div class="ai-modal-content"><span id="closeAiModalBtn" class="close-button">&times;</span><h3 id="aiModalTitle" class="text-2xl font-bold text-purple-600 mb-3">âœ¨ AI ìƒì„± ë‚´ìš©</h3><div id="aiLoadingSpinner" class="loading-spinner hidden"></div><p id="aiModalMessage" class="text-stone-700 whitespace-pre-wrap text-lg leading-relaxed"></p><div class="mt-6 text-right"><button id="confirmAiModalBtn" class="bg-purple-500 hover:bg-purple-600 text-white font-semibold py-2 px-4 rounded-lg">ë‹«ê¸°</button></div></div></div>
    <div id="adminAdjustBalanceModal" class="admin-modal"><div class="admin-modal-content"><span id="closeAdminAdjustBalanceModalBtn" class="close-button">&times;</span><h3 id="adminAdjustBalanceModalTitle" class="text-xl font-semibold text-red-600 mb-3">í•™ìƒ ì”ì•¡ ì¡°ì •</h3><p id="adminAdjustBalanceStudentInfo" class="text-sm text-stone-600 mb-3"></p><div><label for="adminAdjustmentAmount" class="block text-sm font-medium text-stone-700">ì¡°ì • ê¸ˆì•¡ (ì–‘ìˆ˜: ì¦ê°€, ìŒìˆ˜: ê°ì†Œ)</label><input type="number" id="adminAdjustmentAmount" class="mt-1 block w-full p-2 border border-stone-300 rounded-md shadow-sm focus:ring-red-500 focus:border-red-500"></div><div class="mt-2"><label for="adminAdjustmentReason" class="block text-sm font-medium text-stone-700">ì¡°ì • ì‚¬ìœ </label><input type="text" id="adminAdjustmentReason" class="mt-1 block w-full p-2 border border-stone-300 rounded-md shadow-sm focus:ring-red-500 focus:border-red-500" placeholder="ì˜ˆ: íŠ¹ë³„ ë³´ìƒ"></div><div class="mt-4 text-right space-x-2"><button id="cancelAdminAdjustBalanceBtn" class="bg-stone-500 hover:bg-stone-600 text-white font-semibold py-2 px-4 rounded-lg">ì·¨ì†Œ</button><button id="adminConfirmAdjustBalanceBtn" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg">ì”ì•¡ ì¡°ì •</button></div></div></div>
    <div id="adminEditNameModal" class="admin-modal"><div class="admin-modal-content"><span id="closeAdminEditNameModalBtn" class="close-button">&times;</span><h3 id="adminEditNameModalTitle" class="text-xl font-semibold text-red-600 mb-3">í•™ìƒ ì´ë¦„ ë³€ê²½</h3><p id="adminEditNameStudentInfo" class="text-sm text-stone-600 mb-3"></p><div><label for="adminNewStudentName" class="block text-sm font-medium text-stone-700">ìƒˆ ì´ë¦„</label><input type="text" id="adminNewStudentName" class="mt-1 block w-full p-2 border border-stone-300 rounded-md shadow-sm focus:ring-red-500 focus:border-red-500"></div><div class="mt-4 text-right space-x-2"><button id="cancelAdminEditNameBtn" class="bg-stone-500 hover:bg-stone-600 text-white font-semibold py-2 px-4 rounded-lg">ì·¨ì†Œ</button><button id="adminConfirmEditNameBtn" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg">ì´ë¦„ ì €ì¥</button></div></div></div>
    <div id="adminResetStockModal" class="admin-modal"><div class="admin-modal-content"><span id="closeAdminResetStockModalBtn" class="close-button">&times;</span><h3 id="adminResetStockModalTitle" class="text-xl font-semibold text-red-600 mb-3">ë³´ìœ  ì£¼ì‹ ì´ˆê¸°í™”</h3><p id="adminResetStockInfo" class="text-sm text-stone-600 mb-3"></p><p class="text-sm text-red-500 mb-3">ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì •ë§ë¡œ í•´ë‹¹ ì£¼ì‹ì˜ ë³´ìœ ëŸ‰, í‰ë‹¨ê°€ ë“±ì„ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p><div class="mt-4 text-right space-x-2"><button id="cancelAdminResetStockBtn" class="bg-stone-500 hover:bg-stone-600 text-white font-semibold py-2 px-4 rounded-lg">ì·¨ì†Œ</button><button id="adminConfirmResetStockBtn" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg">ì´ˆê¸°í™”</button></div></div></div>
    <div id="adminResetPasswordModal" class="admin-modal"><div class="admin-modal-content"><span id="closeAdminResetPasswordModalBtn" class="close-button">&times;</span><h3 id="adminResetPasswordModalTitle" class="text-xl font-semibold text-red-600 mb-3">í•™ìƒ ë¹„ë°€ë²ˆí˜¸ ì´ˆê¸°í™”</h3><p id="adminResetPasswordStudentInfo" class="text-sm text-stone-600 mb-3"></p><div><label for="adminNewTemporaryPassword" class="block text-sm font-medium text-stone-700">ìƒˆ ì„ì‹œ ë¹„ë°€ë²ˆí˜¸</label><input type="text" id="adminNewTemporaryPassword" class="mt-1 block w-full p-2 border border-stone-300 rounded-md shadow-sm focus:ring-red-500 focus:border-red-500" value="mansung001"></div><p class="text-xs text-stone-500 mt-1">í•™ìƒì—ê²Œ ì´ ì„ì‹œ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì „ë‹¬í•˜ê³ , ë¡œê·¸ì¸ í›„ ì¦‰ì‹œ ë³€ê²½í•˜ë„ë¡ ì•ˆë‚´í•´ì£¼ì„¸ìš”.</p><div class="mt-4 text-right space-x-2"><button id="cancelAdminResetPasswordBtn" class="bg-stone-500 hover:bg-stone-600 text-white font-semibold py-2 px-4 rounded-lg">ì·¨ì†Œ</button><button id="adminConfirmResetPasswordBtn" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg">ì„ì‹œ ë¹„ë°€ë²ˆí˜¸ë¡œ ì´ˆê¸°í™”</button></div></div></div>
    <div id="postModal" class="post-modal"><div class="post-modal-content"><span id="closePostModalBtn" class="close-button">&times;</span><h3 id="postModalTitle" class="text-2xl font-bold text-teal-700 mb-4">ê¸€ ì‘ì„±/ìˆ˜ì •</h3><form id="postForm" class="space-y-4"><input type="hidden" id="postBoardType"><input type="hidden" id="postEditId"><div><label for="postTitleInput" class="block text-sm font-medium text-stone-700">ì œëª©</label><input type="text" id="postTitleInput" required class="mt-1 block w-full p-3 border border-stone-300 rounded-md shadow-sm focus:ring-teal-500 focus:border-teal-500 text-lg"></div><div><label for="postContentInput" class="block text-sm font-medium text-stone-700">ë‚´ìš©</label><textarea id="postContentInput" rows="8" required class="mt-1 block w-full p-3 border border-stone-300 rounded-md shadow-sm focus:ring-teal-500 focus:border-teal-500 text-lg"></textarea></div><div class="text-right"><button type="submit" id="savePostBtn" class="bg-teal-500 hover:bg-teal-600 text-white font-bold py-2 px-4 rounded-lg">ì €ì¥</button></div></form></div></div>
    <div id="shopItemFormModal" class="shop-modal"><div class="shop-modal-content"><span id="closeShopItemFormModalBtn" class="close-button">&times;</span><h3 id="shopItemFormModalTitle" class="text-2xl font-bold text-purple-700 mb-4">ìƒì  ë¬¼í’ˆ ê´€ë¦¬</h3><form id="shopItemForm" class="space-y-4"><input type="hidden" id="shopItemEditId"><div><label for="shopItemName" class="block text-sm font-medium text-stone-700">ë¬¼í’ˆ ì´ë¦„</label><input type="text" id="shopItemName" required class="mt-1 block w-full p-3 border border-stone-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500 text-lg"></div><div><label for="shopItemPrice" class="block text-sm font-medium text-stone-700">ê°€ê²© (ì›)</label><input type="number" id="shopItemPrice" min="0" step="100" required class="mt-1 block w-full p-3 border border-stone-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500 text-lg"></div><div><label for="shopItemDepositAccount" class="block text-sm font-medium text-stone-700">ì…ê¸ˆ ê³„ì¢Œ</label><input type="text" id="shopItemDepositAccount" required class="mt-1 block w-full p-3 border border-stone-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500 text-lg" placeholder="ì˜ˆ: ë§ŒìŠ¹ì€í–‰ 123-456-789 ê¹€ë§ŒìŠ¹"></div><div><label for="shopItemDescription" class="block text-sm font-medium text-stone-700">ë¬¼í’ˆ ì„¤ëª… (ì„ íƒ)</label><textarea id="shopItemDescription" rows="3" class="mt-1 block w-full p-3 border border-stone-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500 text-lg"></textarea></div><div><label for="shopItemImageUrl" class="block text-sm font-medium text-stone-700">ì´ë¯¸ì§€ URL (ì„ íƒ)</label><input type="url" id="shopItemImageUrl" class="mt-1 block w-full p-3 border border-stone-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500 text-lg" placeholder="https://example.com/image.png"></div><div class="text-right"><button type="submit" id="saveShopItemBtn" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded-lg">ì €ì¥</button></div></form></div></div>
    <div id="purchaseInfoModal" class="shop-modal"><div class="shop-modal-content"><span id="closePurchaseInfoModalBtn" class="close-button">&times;</span><h3 id="purchaseInfoModalTitle" class="text-2xl font-bold text-orange-600 mb-4">êµ¬ë§¤ ì •ë³´</h3><div id="purchaseInfoDetails" class="space-y-3 text-stone-700"><p><strong>ë¬¼í’ˆëª…:</strong> <span id="purchaseItemName"></span></p><p><strong>ê°€ê²©:</strong> <span id="purchaseItemPrice"></span></p><p><strong>ì…ê¸ˆ ê³„ì¢Œ:</strong> <span id="purchaseItemAccount" class="font-semibold text-blue-600"></span></p><p class="mt-4 text-sm text-stone-500">ìœ„ ê³„ì¢Œë¡œ ì •í™•í•œ ê¸ˆì•¡ì„ ì…ê¸ˆí•˜ì‹  í›„, ì„ ìƒë‹˜ê»˜ ì•Œë ¤ì£¼ì‹œë©´ ë¬¼í’ˆì„ ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p></div><div class="mt-6 text-right"><button id="confirmPurchaseInfoModalBtn" class="bg-orange-500 hover:bg-orange-600 text-white font-semibold py-2 px-4 rounded-lg">í™•ì¸</button></div></div></div>
    <div id="auctionItemFormModal" class="auction-modal"><div class="auction-modal-content"><span id="closeAuctionItemFormModalBtn" class="close-button">&times;</span><h3 id="auctionItemFormModalTitle" class="text-2xl font-bold text-indigo-700 mb-4">ê²½ë§¤ ë¬¼í’ˆ ê´€ë¦¬</h3><form id="auctionItemForm" class="space-y-4"><input type="hidden" id="auctionItemEditId"><div><label for="auctionItemName" class="block text-sm font-medium text-stone-700">ë¬¼í’ˆ ì´ë¦„</label><input type="text" id="auctionItemName" required class="mt-1 block w-full p-3 border border-stone-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-lg"></div><div><label for="auctionItemStartPrice" class="block text-sm font-medium text-stone-700">ê²½ë§¤ ì‹œì‘ê°€ (ì›)</label><input type="number" id="auctionItemStartPrice" min="0" step="100" required class="mt-1 block w-full p-3 border border-stone-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-lg"></div><div><label for="auctionItemDeadline" class="block text-sm font-medium text-stone-700">ê²½ë§¤ ë§ˆê° ê¸°í•œ</label><input type="datetime-local" id="auctionItemDeadline" required class="mt-1 block w-full p-3 border border-stone-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-lg"></div><div><label for="auctionItemDescription" class="block text-sm font-medium text-stone-700">ë¬¼í’ˆ ì„¤ëª… (ì„ íƒ)</label><textarea id="auctionItemDescription" rows="3" class="mt-1 block w-full p-3 border border-stone-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-lg"></textarea></div><div><label for="auctionItemImageUrl" class="block text-sm font-medium text-stone-700">ì´ë¯¸ì§€ URL (ì„ íƒ)</label><input type="url" id="auctionItemImageUrl" class="mt-1 block w-full p-3 border border-stone-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-lg" placeholder="https://example.com/image.png"></div><div class="text-right"><button type="submit" id="saveAuctionItemBtn" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg">ì €ì¥</button></div></form></div></div>
    <div id="placeBidModal" class="auction-modal"><div class="auction-modal-content"><span id="closePlaceBidModalBtn" class="close-button">&times;</span><h3 id="placeBidModalTitle" class="text-2xl font-bold text-green-600 mb-4">ì…ì°°í•˜ê¸°</h3><form id="placeBidForm" class="space-y-4"><input type="hidden" id="bidAuctionId"><p class="text-sm text-stone-600">ë¬¼í’ˆëª…: <strong id="bidItemNameDisplay"></strong></p><p class="text-sm text-stone-600">í˜„ì¬ ìµœê³  ì…ì°°ê°€: <strong id="currentHighestBidDisplay"></strong></p><div><label for="bidAmount" class="block text-sm font-medium text-stone-700">ì…ì°° ê¸ˆì•¡ (ì›)</label><input type="number" id="bidAmount" min="0" step="100" required class="mt-1 block w-full p-3 border border-stone-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500 text-lg"></div><p class="text-xs text-stone-500">ì…ì°° ê¸ˆì•¡ì€ í˜„ì¬ ìµœê³  ì…ì°°ê°€ë³´ë‹¤ ë†’ì•„ì•¼ í•©ë‹ˆë‹¤.</p><div class="text-right"><button type="submit" id="confirmPlaceBidBtn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg">ì…ì°°</button></div></form></div></div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { 
        getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut,
        updateProfile, EmailAuthProvider, reauthenticateWithCredential, updatePassword
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { 
        getFirestore, collection, doc, setDoc, getDoc, updateDoc, deleteDoc, onSnapshot, 
        query, where, addDoc, getDocs, serverTimestamp, increment, runTransaction,
        Timestamp, arrayUnion, orderBy, limit, deleteField, writeBatch
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const firebaseConfig = { /* Firebase config object, AIzaSy... */
      apiKey: "AIzaSyDCeJPDQUNi-KmJ9DhkTRIu-9t2PGZCpt0", // Replace with your actual config
      authDomain: "mansungcoin-c6e06.firebaseapp.com",
      projectId: "mansungcoin-c6e06",
      storageBucket: "mansungcoin-c6e06.appspot.com",
      messagingSenderId: "704809284946",
      appId: "1:704809284946:web:3e71d98f38810577e1768b"
    };

    // Initialize Firebase
    const firebaseApp = initializeApp(firebaseConfig); 
    const auth = getAuth(firebaseApp);
    const db = getFirestore(firebaseApp);

    // --- Global Variables ---
    let currentUserData = null; 
    let currentAuthUser = null; 
    let stockDataCache = {}; 
    let unsubscribePortfolioListener = null;
    let unsubscribeTransactionsListener = null;
    let unsubscribeDeedsListener = null;
    let unsubscribeStockListeners = {};
    let unsubscribeNoticePostsListener = null;
    let unsubscribeFreeboardPostsListener = null;
    let unsubscribeShopItemsListener = null; 
    let unsubscribeAuctionsListener = null; // Listener for auctions
    let stockUpdateInterval = null;
    const MAX_HISTORY_LENGTH = 200; 
    let auctionCountdownIntervals = {};


    // --- Chart Instances ---
    let assetChartInstance = null;
    const stockChartInstances = {};

    // --- Utility Functions ---
    const formatCurrency = (amount) => new Intl.NumberFormat('ko-KR', { style: 'currency', currency: 'KRW' }).format(amount);
    const formatDate = (date) => {
        if (!date) return 'ë‚ ì§œ ì •ë³´ ì—†ìŒ';
        const d = (date instanceof Timestamp) ? date.toDate() : new Date(date);
        return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')} ${String(d.getHours()).padStart(2, '0')}:${String(d.getMinutes()).padStart(2, '0')}`;
    };
    const isSameDay = (date1, date2) => { /* ... */ 
        if (!date1 || !date2) return false;
        const d1 = (date1 instanceof Timestamp) ? date1.toDate() : new Date(date1);
        const d2 = (date2 instanceof Timestamp) ? date2.toDate() : new Date(date2);
        return d1.getFullYear() === d2.getFullYear() && d1.getMonth() === d2.getMonth() && d1.getDate() === d2.getDate();
    };


    // --- Modal Elements & Functions ---
    const infoModal = document.getElementById('infoModal'); /* ... */
    const modalTitle = document.getElementById('modalTitle');
    const modalMessage = document.getElementById('modalMessage');
    const closeInfoModalBtn = document.getElementById('closeInfoModalBtn');
    const confirmInfoModalBtn = document.getElementById('confirmInfoModalBtn');
    const aiContentModal = document.getElementById('aiContentModal'); /* ... */
    const aiModalTitle = document.getElementById('aiModalTitle');
    const aiModalMessage = document.getElementById('aiModalMessage');
    const aiLoadingSpinner = document.getElementById('aiLoadingSpinner');
    const closeAiModalBtn = document.getElementById('closeAiModalBtn');
    const confirmAiModalBtn = document.getElementById('confirmAiModalBtn');
    const adminAdjustBalanceModal = document.getElementById('adminAdjustBalanceModal'); /* ... */
    const adminAdjustBalanceModalTitle = document.getElementById('adminAdjustBalanceModalTitle');
    const adminAdjustBalanceStudentInfo = document.getElementById('adminAdjustBalanceStudentInfo');
    const adminAdjustmentAmountInput = document.getElementById('adminAdjustmentAmount');
    const adminAdjustmentReasonInput = document.getElementById('adminAdjustmentReason');
    const adminConfirmAdjustBalanceBtn = document.getElementById('adminConfirmAdjustBalanceBtn');
    const closeAdminAdjustBalanceModalBtn = document.getElementById('closeAdminAdjustBalanceModalBtn');
    const cancelAdminAdjustBalanceBtn = document.getElementById('cancelAdminAdjustBalanceBtn');
    let studentIdToAdjust = null;
    const adminEditNameModal = document.getElementById('adminEditNameModal'); /* ... */
    const adminEditNameModalTitle = document.getElementById('adminEditNameModalTitle');
    const adminEditNameStudentInfo = document.getElementById('adminEditNameStudentInfo');
    const adminNewStudentNameInput = document.getElementById('adminNewStudentName');
    const adminConfirmEditNameBtn = document.getElementById('adminConfirmEditNameBtn');
    const closeAdminEditNameModalBtn = document.getElementById('closeAdminEditNameModalBtn');
    const cancelAdminEditNameBtn = document.getElementById('cancelAdminEditNameBtn');
    let studentIdToEditName = null;
    const adminResetStockModal = document.getElementById('adminResetStockModal'); /* ... */
    const adminResetStockModalTitle = document.getElementById('adminResetStockModalTitle');
    const adminResetStockInfo = document.getElementById('adminResetStockInfo');
    const adminConfirmResetStockBtn = document.getElementById('adminConfirmResetStockBtn');
    const closeAdminResetStockModalBtn = document.getElementById('closeAdminResetStockModalBtn');
    const cancelAdminResetStockBtn = document.getElementById('cancelAdminResetStockBtn');
    let studentIdToResetStock = null; let stockIdToReset = null;
    const adminResetPasswordModal = document.getElementById('adminResetPasswordModal'); /* ... */
    const adminResetPasswordModalTitle = document.getElementById('adminResetPasswordModalTitle');
    const adminResetPasswordStudentInfo = document.getElementById('adminResetPasswordStudentInfo');
    const adminNewTemporaryPasswordInput = document.getElementById('adminNewTemporaryPassword');
    const adminConfirmResetPasswordBtn = document.getElementById('adminConfirmResetPasswordBtn');
    const closeAdminResetPasswordModalBtn = document.getElementById('closeAdminResetPasswordModalBtn');
    const cancelAdminResetPasswordBtn = document.getElementById('cancelAdminResetPasswordBtn');
    let studentIdToResetPassword = null;
    const postModal = document.getElementById('postModal'); /* ... */
    const postModalTitleEl = document.getElementById('postModalTitle');
    const postForm = document.getElementById('postForm');
    const postBoardTypeInput = document.getElementById('postBoardType');
    const postEditIdInput = document.getElementById('postEditId');
    const postTitleInput = document.getElementById('postTitleInput');
    const postContentInput = document.getElementById('postContentInput');
    const closePostModalBtn = document.getElementById('closePostModalBtn');
    const shopItemFormModal = document.getElementById('shopItemFormModal'); /* ... */
    const shopItemFormModalTitle = document.getElementById('shopItemFormModalTitle');
    const shopItemForm = document.getElementById('shopItemForm');
    const shopItemEditIdInput = document.getElementById('shopItemEditId');
    const shopItemNameInput = document.getElementById('shopItemName');
    const shopItemPriceInput = document.getElementById('shopItemPrice');
    const shopItemDepositAccountInput = document.getElementById('shopItemDepositAccount');
    const shopItemDescriptionInput = document.getElementById('shopItemDescription');
    const shopItemImageUrlInput = document.getElementById('shopItemImageUrl');
    const closeShopItemFormModalBtn = document.getElementById('closeShopItemFormModalBtn');
    const purchaseInfoModal = document.getElementById('purchaseInfoModal'); /* ... */
    const purchaseInfoModalTitle = document.getElementById('purchaseInfoModalTitle');
    const purchaseItemNameEl = document.getElementById('purchaseItemName');
    const purchaseItemPriceEl = document.getElementById('purchaseItemPrice');
    const purchaseItemAccountEl = document.getElementById('purchaseItemAccount');
    const closePurchaseInfoModalBtn = document.getElementById('closePurchaseInfoModalBtn');
    const confirmPurchaseInfoModalBtn = document.getElementById('confirmPurchaseInfoModalBtn');
    // Auction Modals
    const auctionItemFormModal = document.getElementById('auctionItemFormModal');
    const auctionItemFormModalTitle = document.getElementById('auctionItemFormModalTitle');
    const auctionItemForm = document.getElementById('auctionItemForm');
    const auctionItemEditIdInput = document.getElementById('auctionItemEditId');
    const auctionItemNameInput = document.getElementById('auctionItemName');
    const auctionItemStartPriceInput = document.getElementById('auctionItemStartPrice');
    const auctionItemDeadlineInput = document.getElementById('auctionItemDeadline');
    const auctionItemDescriptionInput = document.getElementById('auctionItemDescription');
    const auctionItemImageUrlInput = document.getElementById('auctionItemImageUrl');
    const closeAuctionItemFormModalBtn = document.getElementById('closeAuctionItemFormModalBtn');
    const placeBidModal = document.getElementById('placeBidModal');
    const placeBidModalTitle = document.getElementById('placeBidModalTitle');
    const placeBidForm = document.getElementById('placeBidForm');
    const bidAuctionIdInput = document.getElementById('bidAuctionId');
    const bidItemNameDisplay = document.getElementById('bidItemNameDisplay');
    const currentHighestBidDisplay = document.getElementById('currentHighestBidDisplay');
    const bidAmountInput = document.getElementById('bidAmount');
    const closePlaceBidModalBtn = document.getElementById('closePlaceBidModalBtn');

    function showInfoModal(title, message) { /* ... */ modalTitle.textContent = title; modalMessage.textContent = message; infoModal.style.display = 'block'; }
    function closeInfoModal() { infoModal.style.display = 'none'; }
    function showAiModal(title) { /* ... */ aiModalTitle.textContent = title; aiModalMessage.textContent = ''; aiLoadingSpinner.classList.remove('hidden'); aiContentModal.style.display = 'block'; }
    function updateAiModalContent(content) { aiModalMessage.textContent = content; aiLoadingSpinner.classList.add('hidden'); }
    function closeAiModal() { aiContentModal.style.display = 'none'; aiLoadingSpinner.classList.add('hidden'); }
    function showAdminAdjustBalanceModal(studentId, studentName, currentBalance) { /* ... */ studentIdToAdjust = studentId; adminAdjustBalanceModalTitle.textContent = `${studentName} í•™ìƒ ì”ì•¡ ì¡°ì •`; adminAdjustBalanceStudentInfo.textContent = `í˜„ì¬ ì”ì•¡: ${formatCurrency(currentBalance)}`; adminAdjustmentAmountInput.value = ''; adminAdjustmentReasonInput.value = ''; adminAdjustBalanceModal.style.display = 'block'; }
    function closeAdminAdjustBalanceModal() { adminAdjustBalanceModal.style.display = 'none'; studentIdToAdjust = null; }
    function showAdminEditNameModal(studentId, currentName) { /* ... */ studentIdToEditName = studentId; adminEditNameModalTitle.textContent = `í•™ìƒ ì´ë¦„ ë³€ê²½ (${currentName})`; adminEditNameStudentInfo.textContent = `í˜„ì¬ ì´ë¦„: ${currentName}`; adminNewStudentNameInput.value = currentName; adminEditNameModal.style.display = 'block'; }
    function closeAdminEditNameModal() { adminEditNameModal.style.display = 'none'; studentIdToEditName = null; }
    function showAdminResetStockModal(studentId, studentName, stockName, currentStockId) { /* ... */ studentIdToResetStock = studentId; stockIdToReset = currentStockId; adminResetStockModalTitle.textContent = `${studentName} í•™ìƒì˜ ${stockName} ë³´ìœ ëŸ‰ ì´ˆê¸°í™”`; adminResetStockInfo.textContent = `${studentName} í•™ìƒì˜ ${stockName} ì£¼ì‹ ë³´ìœ  ì •ë³´ë¥¼ ì´ˆê¸°í™”í•©ë‹ˆë‹¤.`; adminResetStockModal.style.display = 'block'; }
    function closeAdminResetStockModal() { adminResetStockModal.style.display = 'none'; studentIdToResetStock = null; stockIdToReset = null; }
    function showAdminResetPasswordModal(studentId, studentName, studentEmail) { /* ... */ studentIdToResetPassword = studentId; adminResetPasswordModalTitle.textContent = `${studentName} (${studentEmail}) ë¹„ë°€ë²ˆí˜¸ ì´ˆê¸°í™”`; adminResetPasswordStudentInfo.textContent = `ìƒˆë¡œìš´ ì„ì‹œ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.`; adminNewTemporaryPasswordInput.value = "mansung001"; adminResetPasswordModal.style.display = 'block'; }
    function closeAdminResetPasswordModal() { adminResetPasswordModal.style.display = 'none'; studentIdToResetPassword = null; }
    function showPostModal(boardType, post = null) { /* ... */ postBoardTypeInput.value = boardType; if (post) { postModalTitleEl.textContent = `${boardType === 'notice' ? 'ê³µì§€ì‚¬í•­' : 'ììœ ê²Œì‹œê¸€'} ìˆ˜ì •`; postEditIdInput.value = post.id; postTitleInput.value = post.title; postContentInput.value = post.content; } else { postModalTitleEl.textContent = `ìƒˆ ${boardType === 'notice' ? 'ê³µì§€ì‚¬í•­' : 'ììœ ê²Œì‹œê¸€'} ì‘ì„±`; postEditIdInput.value = ''; postForm.reset(); } postModal.style.display = 'block'; }
    function closePostModal() { postModal.style.display = 'none'; postForm.reset(); postEditIdInput.value = ''; }
    function showShopItemFormModal(item = null) { /* ... */ if (item) { shopItemFormModalTitle.textContent = "ìƒì  ë¬¼í’ˆ ìˆ˜ì •"; shopItemEditIdInput.value = item.id; shopItemNameInput.value = item.itemName; shopItemPriceInput.value = item.price; shopItemDepositAccountInput.value = item.depositAccount; shopItemDescriptionInput.value = item.description || ""; shopItemImageUrlInput.value = item.imageUrl || ""; } else { shopItemFormModalTitle.textContent = "ìƒˆ ìƒì  ë¬¼í’ˆ ë“±ë¡"; shopItemForm.reset(); shopItemEditIdInput.value = ""; } shopItemFormModal.style.display = 'block'; }
    function closeShopItemFormModal() { shopItemFormModal.style.display = 'none'; }
    function showPurchaseInfoModal(item) { /* ... */ purchaseItemNameEl.textContent = item.itemName; purchaseItemPriceEl.textContent = formatCurrency(item.price); purchaseItemAccountEl.textContent = item.depositAccount; purchaseInfoModal.style.display = 'block'; }
    function closePurchaseInfoModal() { purchaseInfoModal.style.display = 'none'; }
    function showAuctionItemFormModal(item = null) {
        if (item) { // Edit mode
            auctionItemFormModalTitle.textContent = "ê²½ë§¤ ë¬¼í’ˆ ìˆ˜ì •";
            auctionItemEditIdInput.value = item.id;
            auctionItemNameInput.value = item.itemName;
            auctionItemStartPriceInput.value = item.startPrice;
            auctionItemDeadlineInput.value = item.deadline ? new Date(item.deadline.seconds * 1000).toISOString().substring(0, 16) : '';
            auctionItemDescriptionInput.value = item.description || "";
            auctionItemImageUrlInput.value = item.imageUrl || "";
        } else { // Create mode
            auctionItemFormModalTitle.textContent = "ìƒˆ ê²½ë§¤ ë¬¼í’ˆ ë“±ë¡";
            auctionItemForm.reset();
            auctionItemEditIdInput.value = "";
        }
        auctionItemFormModal.style.display = 'block';
    }
    function closeAuctionItemFormModal() { auctionItemFormModal.style.display = 'none'; }
    function showPlaceBidModal(auctionId, itemName, currentBid) {
        bidAuctionIdInput.value = auctionId;
        bidItemNameDisplay.textContent = itemName;
        currentHighestBidDisplay.textContent = formatCurrency(currentBid);
        bidAmountInput.value = '';
        bidAmountInput.min = currentBid + 100; // Minimum bid must be higher
        placeBidModal.style.display = 'block';
    }
    function closePlaceBidModal() { placeBidModal.style.display = 'none'; }

    closeInfoModalBtn.addEventListener('click', closeInfoModal); /* ... */
    confirmInfoModalBtn.addEventListener('click', closeInfoModal);
    closeAiModalBtn.addEventListener('click', closeAiModal);
    confirmAiModalBtn.addEventListener('click', closeAiModal);
    closeAdminAdjustBalanceModalBtn.addEventListener('click', closeAdminAdjustBalanceModal);
    cancelAdminAdjustBalanceBtn.addEventListener('click', closeAdminAdjustBalanceModal);
    closeAdminEditNameModalBtn.addEventListener('click', closeAdminEditNameModal);
    cancelAdminEditNameBtn.addEventListener('click', closeAdminEditNameModal);
    closeAdminResetStockModalBtn.addEventListener('click', closeAdminResetStockModal);
    cancelAdminResetStockBtn.addEventListener('click', closeAdminResetStockModal);
    closeAdminResetPasswordModalBtn.addEventListener('click', closeAdminResetPasswordModal);
    cancelAdminResetPasswordBtn.addEventListener('click', closeAdminResetPasswordModal);
    closePostModalBtn.addEventListener('click', closePostModal);
    closeShopItemFormModalBtn.addEventListener('click', closeShopItemFormModal);
    closePurchaseInfoModalBtn.addEventListener('click', closePurchaseInfoModal);
    confirmPurchaseInfoModalBtn.addEventListener('click', closePurchaseInfoModal);
    closeAuctionItemFormModalBtn.addEventListener('click', closeAuctionItemFormModal);
    closePlaceBidModalBtn.addEventListener('click', closePlaceBidModal);

    window.onclick = function(event) {
        if (event.target == infoModal) closeInfoModal();
        if (event.target == aiContentModal) closeAiModal();
        if (event.target == adminAdjustBalanceModal) closeAdminAdjustBalanceModal();
        if (event.target == adminEditNameModal) closeAdminEditNameModal();
        if (event.target == adminResetStockModal) closeAdminResetStockModal();
        if (event.target == adminResetPasswordModal) closeAdminResetPasswordModal();
        if (event.target == postModal) closePostModal();
        if (event.target == shopItemFormModal) closeShopItemFormModal();
        if (event.target == purchaseInfoModal) closePurchaseInfoModal();
        if (event.target == auctionItemFormModal) closeAuctionItemFormModal();
        if (event.target == placeBidModal) closePlaceBidModal();
    }

    // --- DOM Elements ---
    const sections = document.querySelectorAll('main section'); /* ... */
    const navLinks = document.querySelectorAll('.nav-link');
    const adminNavLink = document.getElementById('adminNavLink');
    const adminDivider = document.getElementById('adminDivider');
    const quickActionButtons = document.querySelectorAll('.quick-action-button');
    const currentBalanceEl = document.getElementById('currentBalance');
    const totalAssetValueEl = document.getElementById('totalAssetValue');
    const recipientInput = document.getElementById('recipient'); 
    const transferForm = document.getElementById('transferForm');
    const deedForm = document.getElementById('deedForm');
    const deedDescriptionEl = document.getElementById('deedDescription');
    const deedListEl = document.getElementById('deedList');
    const transactionListEl = document.getElementById('transactionList');
    const transactionFilterEl = document.getElementById('transactionFilter');
    const marketTabsContainer = document.getElementById('marketTabsContainer');
    const marketContentContainer = document.getElementById('marketContent');
    const loggedInUserDisplay = document.getElementById('loggedInUserDisplay');
    const loginForm = document.getElementById('loginForm');
    const registerForm = document.getElementById('registerForm');
    const loginLink = document.getElementById('loginLink');
    const loginLinkText = document.getElementById('loginLinkText');
    const authErrorEl = document.getElementById('authError');
    const registerAuthErrorEl = document.getElementById('registerAuthError');
    const adminStudentListEl = document.getElementById('adminStudentList');
    const adminStockFluctuationSettingsEl = document.getElementById('adminStockFluctuationSettings');
    const settingsForm = document.getElementById('settingsForm');
    const userNameInput = document.getElementById('userName');
    const changePasswordForm = document.getElementById('changePasswordForm');
    const rankingContentTotalAsset = document.getElementById('rankingContentTotalAsset');
    const rankingContentRoi = document.getElementById('rankingContentRoi');
    const totalAssetRankingListEl = document.getElementById('totalAssetRankingList');
    const roiRankingListEl = document.getElementById('roiRankingList');
    const rankingTabButtons = document.querySelectorAll('.ranking-tab-button');
    const adminUserDetailSection = document.getElementById('adminUserDetail');
    const adminUserDetailNameEl = document.getElementById('adminUserDetailName');
    const adminUserPortfolioListEl = document.getElementById('adminUserPortfolioList');
    const adminUserTransactionListEl = document.getElementById('adminUserTransactionList');
    const adminUserDeedListEl = document.getElementById('adminUserDeedList');
    const backToAdminListBtn = document.getElementById('backToAdminListBtn');
    const boardTabButtons = document.querySelectorAll('.board-tab-button');
    const boardContentNoticeEl = document.getElementById('boardContentNotice');
    const boardContentFreeboardEl = document.getElementById('boardContentFreeboard');
    const noticePostListEl = document.getElementById('noticePostList');
    const freePostListEl = document.getElementById('freePostList');
    const newNoticePostBtn = document.getElementById('newNoticePostBtn');
    const newFreePostBtn = document.getElementById('newFreePostBtn');
    const shopItemListEl = document.getElementById('shopItemList'); 
    const adminShopItemListEl = document.getElementById('adminShopItemList'); 
    const adminAddNewShopItemBtn = document.getElementById('adminAddNewShopItemBtn');
    // Auction DOM Elements
    const auctionTabButtons = document.querySelectorAll('.auction-tab-button');
    const auctionContentActiveEl = document.getElementById('auctionContentActive');
    const auctionContentPastEl = document.getElementById('auctionContentPast');
    const adminAddNewAuctionItemBtn = document.getElementById('adminAddNewAuctionItemBtn');
    const adminAuctionItemListEl = document.getElementById('adminAuctionItemList');


    // --- Navigation ---
    function showSection(sectionId, forceShow = false) { /* ... */ 
        console.log("Attempting to show section:", sectionId);
        if (!currentAuthUser && !forceShow && sectionId !== 'login' && sectionId !== 'register') { showSection('login', true); return; }
        if (sectionId === 'admin' && (!currentUserData || currentUserData.role !== 'teacher')) { showInfoModal("ì ‘ê·¼ ë¶ˆê°€", "ê´€ë¦¬ìë§Œ ì ‘ê·¼í•  ìˆ˜ ìˆëŠ” í˜ì´ì§€ì…ë‹ˆë‹¤."); showSection('dashboard'); return; }
        if (sectionId === 'adminUserDetail' && (!currentUserData || currentUserData.role !== 'teacher')) { showInfoModal("ì ‘ê·¼ ë¶ˆê°€", "ê´€ë¦¬ìë§Œ ì ‘ê·¼í•  ìˆ˜ ìˆëŠ” í˜ì´ì§€ì…ë‹ˆë‹¤."); showSection('admin'); return; }
        sections.forEach(section => section.classList.add('hidden'));
        const targetSection = document.getElementById(sectionId);
        if (targetSection) targetSection.classList.remove('hidden');
        else { console.error(`Section with id "${sectionId}" not found.`); if (currentAuthUser) showSection('dashboard'); else showSection('login', true); return; }
        navLinks.forEach(link => { link.classList.remove('bg-teal-600', 'font-semibold'); if (link.dataset.section === sectionId) link.classList.add('bg-teal-600', 'font-semibold'); });
        if (window.innerWidth < 768 && sidebar.classList.contains('open')) sidebar.classList.remove('open');
        if (currentAuthUser) { 
            if (sectionId === 'dashboard') updateDashboardDisplay();
            if (sectionId === 'market') loadAndRenderMarketTabs();
            if (sectionId === 'shopPage') loadAndRenderShopItems();
            if (sectionId === 'auctionPage') { loadAndRenderAuctionItems('active'); checkAndProcessEndedAuctions(); } // Load active auctions by default
            if (sectionId === 'board') loadAndRenderBoard('notice'); 
            if (sectionId === 'transactions') renderTransactions();
            if (sectionId === 'deeds') renderDeeds();
            if (sectionId === 'settings') loadUserSettings();
            if (sectionId === 'ranking') loadRankingData('totalAsset');
            if (sectionId === 'admin' && currentUserData && currentUserData.role === 'teacher') { loadAdminData(); loadAdminShopItems(); loadAdminAuctionItems(); }
        }
    }
    document.getElementById('switchToRegister').addEventListener('click', (e) => { e.preventDefault(); showSection('register', true); });
    document.getElementById('switchToLogin').addEventListener('click', (e) => { e.preventDefault(); showSection('login', true); });
    backToAdminListBtn.addEventListener('click', () => showSection('admin'));
    navLinks.forEach(link => { link.addEventListener('click', (e) => { e.preventDefault(); if (link.id === 'loginLink' && currentAuthUser) { signOut(auth).catch(error => showInfoModal("ë¡œê·¸ì•„ì›ƒ ì˜¤ë¥˜", `ë¡œê·¸ì•„ì›ƒ ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`)); } else { showSection(link.dataset.section); } }); });
    quickActionButtons.forEach(button => { button.addEventListener('click', (e) => { e.preventDefault(); showSection(button.dataset.section); }); });

    // --- Firebase Auth State Change ---
    onAuthStateChanged(auth, async (user) => { /* ... */ 
        currentAuthUser = user;
        if (user) {
            loggedInUserDisplay.textContent = user.displayName || user.email; loginLinkText.textContent = 'ë¡œê·¸ì•„ì›ƒ';
            await loadCurrentUserData(user.uid); attachRealtimeListeners(user.uid); startStockUpdates(); 
            if (currentUserData && currentUserData.role === 'teacher') { adminNavLink.classList.remove('hidden'); adminDivider.classList.remove('hidden'); newNoticePostBtn.classList.remove('hidden'); } 
            else { adminNavLink.classList.add('hidden'); adminDivider.classList.add('hidden'); newNoticePostBtn.classList.add('hidden'); }
            showSection('dashboard'); 
        } else {
            loggedInUserDisplay.textContent = 'ë¡œê·¸ì¸ í•„ìš”'; loginLinkText.textContent = 'ë¡œê·¸ì¸';
            adminNavLink.classList.add('hidden'); adminDivider.classList.add('hidden'); newNoticePostBtn.classList.add('hidden');
            currentUserData = null; detachRealtimeListeners(); stopStockUpdates(); clearDashboard(); 
            showSection('login', true); 
        }
    });
    function clearDashboard() { /* ... */ 
        currentBalanceEl.textContent = formatCurrency(0); totalAssetValueEl.textContent = formatCurrency(0);
        if (assetChartInstance) { assetChartInstance.destroy(); assetChartInstance = null; }
        transactionListEl.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-stone-500">ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.</td></tr>';
        deedListEl.innerHTML = '<li class="p-3 bg-stone-50 rounded-md border border-stone-200 text-center text-stone-500">ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.</li>';
        shopItemListEl.innerHTML = '<p class="text-stone-500 col-span-full text-center">ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.</p>';
        auctionContentActiveEl.innerHTML = '<p class="text-stone-500 col-span-full text-center">ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.</p>';
        auctionContentPastEl.innerHTML = '<p class="text-stone-500 col-span-full text-center">ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.</p>';
    }

    // --- Firebase Firestore Data Loading ---
    async function loadCurrentUserData(userId) { /* ... */ 
        const userDocRef = doc(db, "users", userId);
        try {
            const docSnap = await getDoc(userDocRef);
            if (docSnap.exists()) { currentUserData = { id: docSnap.id, ...docSnap.data() }; if (!currentUserData.portfolio) currentUserData.portfolio = {}; if (!currentUserData.deeds) currentUserData.deeds = []; } 
            else { currentUserData = { id: userId, name: currentAuthUser.displayName || "ìƒˆ ì‚¬ìš©ì", email: currentAuthUser.email, balance: 2000, portfolio: {}, deeds: [], role: 'student', createdAt: serverTimestamp() }; await setDoc(userDocRef, { uid: userId, name: currentUserData.name, email: currentUserData.email, balance: currentUserData.balance, portfolio: currentUserData.portfolio, role: currentUserData.role, createdAt: currentUserData.createdAt }); }
            updateDashboardDisplay();
        } catch (error) { console.error("Error loading user data:", error); showInfoModal("ì˜¤ë¥˜", "ì‚¬ìš©ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."); }
    }
    function attachRealtimeListeners(userId) { /* ... */ 
        detachRealtimeListeners();
        const userDocRef = doc(db, "users", userId);
        unsubscribePortfolioListener = onSnapshot(userDocRef, (docSnap) => { if (docSnap.exists()) { currentUserData = { ...currentUserData, ...docSnap.data(), id: docSnap.id }; if (!currentUserData.portfolio) currentUserData.portfolio = {}; if (document.getElementById('dashboard').classList.contains('hidden') === false) updateDashboardDisplay(); const activeStockTab = document.querySelector('#market .tab-button.active'); if (activeStockTab && document.getElementById('market').classList.contains('hidden') === false) { const stockIdToRender = Object.keys(stockDataCache).find(id => stockDataCache[id].name === activeStockTab.textContent); if(stockIdToRender) renderStockDetails(stockIdToRender); } if (currentUserData && currentUserData.role === 'teacher') { adminNavLink.classList.remove('hidden'); adminDivider.classList.remove('hidden'); newNoticePostBtn.classList.remove('hidden'); } else { adminNavLink.classList.add('hidden'); adminDivider.classList.add('hidden'); newNoticePostBtn.classList.add('hidden'); }}}, (error) => console.error("Error in user data onSnapshot:", error));
        const transactionsQuery = query(collection(db, "users", userId, "transactions"), orderBy("date", "desc")); 
        unsubscribeTransactionsListener = onSnapshot(transactionsQuery, (querySnapshot) => { const transactions = []; querySnapshot.forEach((doc) => transactions.push({ id: doc.id, ...doc.data() })); if(currentUserData) currentUserData.transactions = transactions; if (document.getElementById('transactions').classList.contains('hidden') === false) renderTransactions(); }, (error) => console.error("Error in transactions onSnapshot:", error));
        const deedsQuery = query(collection(db, "users", userId, "deeds"), orderBy("date", "desc")); 
        unsubscribeDeedsListener = onSnapshot(deedsQuery, (querySnapshot) => { const deeds = []; querySnapshot.forEach((doc) => deeds.push({ id: doc.id, ...doc.data() })); if(currentUserData) currentUserData.deeds = deeds; if (document.getElementById('deeds').classList.contains('hidden') === false) renderDeeds(); }, (error) => console.error("Error in deeds onSnapshot:", error));
        const stocksQuery = query(collection(db, "stocks"));
        unsubscribeStockListeners['all'] = onSnapshot(stocksQuery, (querySnapshot) => { let updated = false; querySnapshot.forEach((docSnap) => { const stockId = docSnap.id; if (stockId === 'gold') return; const newStockData = { id: docSnap.id, ...docSnap.data() }; if (JSON.stringify(stockDataCache[stockId]) !== JSON.stringify(newStockData)) updated = true; stockDataCache[stockId] = newStockData; }); if (updated && document.getElementById('market').classList.contains('hidden') === false) loadAndRenderMarketTabs(); if (updated && document.getElementById('dashboard').classList.contains('hidden') === false) updateDashboardDisplay(); if (updated && document.getElementById('admin').classList.contains('hidden') === false && currentUserData?.role === 'teacher') loadAdminData(); }, (error) => console.error("Error in stocks onSnapshot:", error));
        const noticeQuery = query(collection(db, "boards", "notice", "posts"), orderBy("createdAt", "desc"));
        unsubscribeNoticePostsListener = onSnapshot(noticeQuery, (snapshot) => { if (document.getElementById('board').classList.contains('hidden') === false && !boardContentNoticeEl.classList.contains('hidden')) renderPosts('notice', snapshot); });
        const freeboardQuery = query(collection(db, "boards", "freeboard", "posts"), orderBy("createdAt", "desc"));
        unsubscribeFreeboardPostsListener = onSnapshot(freeboardQuery, (snapshot) => { if (document.getElementById('board').classList.contains('hidden') === false && !boardContentFreeboardEl.classList.contains('hidden')) renderPosts('freeboard', snapshot); });
        const shopItemsQuery = query(collection(db, "shopItems"), orderBy("createdAt", "desc"));
        unsubscribeShopItemsListener = onSnapshot(shopItemsQuery, (snapshot) => { if (document.getElementById('shopPage').classList.contains('hidden') === false) loadAndRenderShopItems(); if (document.getElementById('admin').classList.contains('hidden') === false && currentUserData?.role === 'teacher') loadAdminShopItems(); }, (error) => console.error("Error in shopItems onSnapshot:", error));
        // Realtime listener for auctions
        const auctionsQuery = query(collection(db, "auctions"), orderBy("deadline", "asc")); // Order by deadline to process older ones first
        unsubscribeAuctionsListener = onSnapshot(auctionsQuery, (snapshot) => {
            checkAndProcessEndedAuctions(); // Check whenever auction data changes
            const activeAuctionTab = document.querySelector('#auctionPage .auction-tab-button.active');
            if (document.getElementById('auctionPage').classList.contains('hidden') === false && activeAuctionTab) {
                loadAndRenderAuctionItems(activeAuctionTab.dataset.auctiontype);
            }
            if (document.getElementById('admin').classList.contains('hidden') === false && currentUserData?.role === 'teacher') {
                loadAdminAuctionItems();
            }
        }, (error) => console.error("Error in auctions onSnapshot:", error));
    }
    function detachRealtimeListeners() { /* ... */ 
        if (unsubscribePortfolioListener) unsubscribePortfolioListener(); if (unsubscribeTransactionsListener) unsubscribeTransactionsListener();
        if (unsubscribeDeedsListener) unsubscribeDeedsListener(); Object.values(unsubscribeStockListeners).forEach(unsub => unsub()); unsubscribeStockListeners = {};
        if (unsubscribeNoticePostsListener) unsubscribeNoticePostsListener(); if (unsubscribeFreeboardPostsListener) unsubscribeFreeboardPostsListener();
        if (unsubscribeShopItemsListener) unsubscribeShopItemsListener(); if (unsubscribeAuctionsListener) unsubscribeAuctionsListener();
        Object.values(auctionCountdownIntervals).forEach(clearInterval); auctionCountdownIntervals = {};
    }

    // --- Gemini API Call Function ---
    async function generateTextViaGemini(prompt) { /* ... */ 
        showAiModal("âœ¨ AIê°€ ì—´ì‹¬íˆ ìƒê°í•˜ê³  ìˆì–´ìš”..."); const apiKey = ""; const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`; const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
        try { const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) }); if (!response.ok) { let errorDetails = `API ìš”ì²­ ì‹¤íŒ¨ (ìƒíƒœ ì½”ë“œ: ${response.status})`; try { const errorResult = await response.json(); if (errorResult.error?.message) errorDetails += ` - ${errorResult.error.message}`; } catch (e) { /* Ignore */ } throw new Error(errorDetails); } const result = await response.json(); if (result.candidates?.[0]?.content?.parts?.[0]?.text) { updateAiModalContent(result.candidates[0].content.parts[0].text); } else { updateAiModalContent("AIê°€ ì‘ë‹µì„ ìƒì„±í•˜ëŠ” ë° ì‹¤íŒ¨í–ˆì–´ìš”. ì‘ë‹µ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•Šì•„ìš”."); }} catch (error) { updateAiModalContent(`AIì™€ ì—°ê²°í•˜ëŠ” ë° ë¬¸ì œê°€ ë°œìƒí–ˆì–´ìš”: ${error.message}.`); }
    }

    // --- Authentication Logic ---
    loginForm.addEventListener('submit', async (e) => { /* ... */ e.preventDefault(); const email = loginForm.email.value; const password = loginForm.password.value; authErrorEl.classList.add('hidden'); try { await signInWithEmailAndPassword(auth, email, password); } catch (error) { if (['auth/wrong-password', 'auth/user-not-found', 'auth/invalid-credential'].includes(error.code)) { try { const q = query(collection(db, "users"), where("email", "==", email)); const querySnapshot = await getDocs(q); if (!querySnapshot.empty) { const userDoc = querySnapshot.docs[0]; const userData = userDoc.data(); if (userData.temporaryPassword === password) { currentAuthUser = { uid: userDoc.id, email: userData.email, displayName: userData.name }; await loadCurrentUserData(userDoc.id); attachRealtimeListeners(userDoc.id); startStockUpdates(); if (currentUserData?.role === 'teacher') adminNavLink.classList.remove('hidden'); showSection('dashboard'); showInfoModal("ì„ì‹œ ë¹„ë°€ë²ˆí˜¸ ë¡œê·¸ì¸ ì„±ê³µ", "ë³´ì•ˆì„ ìœ„í•´ ì¦‰ì‹œ 'í™˜ê²½ ì„¤ì •'ì—ì„œ ìƒˆ ë¹„ë°€ë²ˆí˜¸ë¡œ ë³€ê²½í•´ì£¼ì„¸ìš”!"); loginForm.reset(); return; }}} catch (dbError) { console.error("Error checking temporary password:", dbError); }} authErrorEl.textContent = `ë¡œê·¸ì¸ ì‹¤íŒ¨: ${mapAuthErrorCodeToMessage(error.code)}`; authErrorEl.classList.remove('hidden'); }});
    registerForm.addEventListener('submit', async (e) => { /* ... */ e.preventDefault(); const name = registerForm.name.value; const email = registerForm.email.value; const password = registerForm.password.value; registerAuthErrorEl.classList.add('hidden'); try { const userCredential = await createUserWithEmailAndPassword(auth, email, password); const user = userCredential.user; await updateProfile(user, { displayName: name }); await setDoc(doc(db, "users", user.uid), { uid: user.uid, name: name, email: user.email, balance: 2000, portfolio: {}, role: 'student', createdAt: serverTimestamp() }); showInfoModal("íšŒì›ê°€ì… ì„±ê³µ!", "ë§ŒìŠ¹ ê²½ì œ êµì‹¤ì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤!"); } catch (error) { registerAuthErrorEl.textContent = `íšŒì›ê°€ì… ì‹¤íŒ¨: ${mapAuthErrorCodeToMessage(error.code)}`; registerAuthErrorEl.classList.remove('hidden'); }});
    function mapAuthErrorCodeToMessage(errorCode) { /* ... */ switch (errorCode) { case 'auth/invalid-email': return 'ìœ íš¨í•˜ì§€ ì•Šì€ ì´ë©”ì¼ ì£¼ì†Œì…ë‹ˆë‹¤.'; case 'auth/user-disabled': return 'ì‚¬ìš© ì¤‘ì§€ëœ ê³„ì •ì…ë‹ˆë‹¤.'; case 'auth/user-not-found': return 'ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'; case 'auth/wrong-password': return 'ì˜ëª»ëœ ë¹„ë°€ë²ˆí˜¸ì…ë‹ˆë‹¤.'; case 'auth/invalid-credential': return 'ì´ë©”ì¼ ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì˜ëª»ë˜ì—ˆìŠµë‹ˆë‹¤.'; case 'auth/email-already-in-use': return 'ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì´ë©”ì¼ ì£¼ì†Œì…ë‹ˆë‹¤.'; case 'auth/weak-password': return 'ë¹„ë°€ë²ˆí˜¸ëŠ” 6ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.'; case 'auth/operation-not-allowed': return 'ì´ë©”ì¼/ë¹„ë°€ë²ˆí˜¸ ë¡œê·¸ì¸ì´ í™œì„±í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.'; default: return errorCode; }}

    // --- Dashboard Logic ---
    function updateDashboardDisplay() { /* ... */ if (!currentUserData) return; currentBalanceEl.textContent = formatCurrency(currentUserData.balance || 0); let stockValue = 0; if (currentUserData.portfolio) { for (const stockId in currentUserData.portfolio) { const portfolioItem = currentUserData.portfolio[stockId]; const quantity = portfolioItem?.quantity || 0; const stockPrice = stockDataCache[stockId]?.price || 0; stockValue += quantity * stockPrice; }} totalAssetValueEl.textContent = formatCurrency((currentUserData.balance || 0) + stockValue); renderAssetAllocationChart(); }
    function renderAssetAllocationChart() { /* ... */ if (!currentUserData || !stockDataCache) return; const ctx = document.getElementById('assetAllocationChart').getContext('2d'); const labels = ['í˜„ê¸ˆ']; const data = [currentUserData.balance || 0]; const backgroundColors = ['rgba(54, 162, 235, 0.7)']; if (currentUserData.portfolio) { for (const stockId in currentUserData.portfolio) { const portfolioItem = currentUserData.portfolio[stockId]; const quantity = portfolioItem?.quantity || 0; if (quantity > 0 && stockDataCache[stockId]) { labels.push(stockDataCache[stockId].name); data.push(quantity * stockDataCache[stockId].price); backgroundColors.push(stockDataCache[stockId].color || getRandomColor()); }}} if (assetChartInstance) assetChartInstance.destroy(); if (data.every(val => val === 0) && data.length > 1 && data[0] === 0) { assetChartInstance = new Chart(ctx, {type: 'doughnut', data: {labels: ['ìì‚° ì—†ìŒ'], datasets: [{ data: [1], backgroundColor: ['rgba(200, 200, 200, 0.7)'] }]}, options: {responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' }, tooltip: { callbacks: { label: function(context) { return ' ìì‚°ì„ ëŠ˜ë ¤ë³´ì„¸ìš”!'; }}}}}}); } else { assetChartInstance = new Chart(ctx, {type: 'doughnut', data: {labels: labels, datasets: [{label: 'ìì‚° êµ¬ì„±', data: data, backgroundColor: backgroundColors, borderColor: backgroundColors.map(color => color.replace('0.7', '1')), borderWidth: 1}]}, options: {responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' }, tooltip: { callbacks: {label: function(context) {let label = context.label || ''; if (label) { label += ': '; } if (context.parsed !== null) { label += formatCurrency(context.parsed); } return label;}}}}}}); }}
    function getRandomColor() { const r = Math.floor(Math.random() * 200); const g = Math.floor(Math.random() * 200); const b = Math.floor(Math.random() * 200); return `rgba(${r}, ${g}, ${b}, 0.7)`; }

    // --- Transfer Logic ---
    transferForm.addEventListener('submit', async (e) => { /* ... */ e.preventDefault(); if (!currentAuthUser || !currentUserData) { showInfoModal('ì˜¤ë¥˜', 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.'); return; } const recipientEmail = recipientInput.value.trim(); const amount = parseInt(transferAmount.value); const memo = transferMemo.value || 'ê³„ì¢Œì´ì²´'; if (!recipientEmail) { showInfoModal('ì˜¤ë¥˜', 'ë°›ëŠ” ì‚¬ëŒ ì´ë©”ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; } if (recipientEmail === currentAuthUser.email) { showInfoModal('ì˜¤ë¥˜', 'ìê¸° ìì‹ ì—ê²Œ ì´ì²´í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); return; } if (isNaN(amount) || amount <= 0) { showInfoModal('ì˜¤ë¥˜', 'ì˜¬ë°”ë¥¸ ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; } if (amount > currentUserData.balance) { showInfoModal('ì˜¤ë¥˜', 'ì”ì•¡ì´ ë¶€ì¡±í•©ë‹ˆë‹¤.'); return; } try { const q = query(collection(db, "users"), where("email", "==", recipientEmail)); const querySnapshot = await getDocs(q); if (querySnapshot.empty) { showInfoModal('ì˜¤ë¥˜', 'ë°›ëŠ” ì‚¬ëŒì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì´ë©”ì¼ì„ í™•ì¸í•´ì£¼ì„¸ìš”.'); return; } const recipientDoc = querySnapshot.docs[0]; const recipientId = recipientDoc.id; const recipientData = recipientDoc.data(); await runTransaction(db, async (transaction) => { const senderDocRef = doc(db, "users", currentAuthUser.uid); const recipientDocRef = doc(db, "users", recipientId); const senderSnap = await transaction.get(senderDocRef); if (!senderSnap.exists() || senderSnap.data().balance < amount) throw new Error("ì”ì•¡ì´ ë¶€ì¡±í•©ë‹ˆë‹¤."); transaction.update(senderDocRef, { balance: increment(-amount) }); transaction.update(recipientDocRef, { balance: increment(amount) }); transaction.set(doc(collection(db, "users", currentAuthUser.uid, "transactions")), {type: 'transfer_out', description: `${recipientData.name}(${recipientEmail})ì—ê²Œ ì†¡ê¸ˆ (${memo})`, amount: amount, date: serverTimestamp(), counterpartyName: recipientData.name, counterpartyEmail: recipientEmail}); transaction.set(doc(collection(db, "users", recipientId, "transactions")), {type: 'transfer_in', description: `${currentUserData.name}(${currentAuthUser.email})ìœ¼ë¡œë¶€í„° ì…ê¸ˆ (${memo})`, amount: amount, date: serverTimestamp(), counterpartyName: currentUserData.name, counterpartyEmail: currentAuthUser.email}); }); showInfoModal('ì„±ê³µ', `${recipientData.name}ë‹˜ì—ê²Œ ${formatCurrency(amount)}ì„ ë³´ëƒˆìŠµë‹ˆë‹¤.`); transferForm.reset(); } catch (error) { showInfoModal('ì´ì²´ ì‹¤íŒ¨', `ì´ì²´ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`); }});

    // --- Market Logic ---
    async function initializeStockData() { /* ... */ const initialStocks = { 'hanul': { name: 'í•œìš¸ë°˜ ì£¼ì‹', price: 1000, history: [1000], color: 'rgba(59, 130, 246, 0.7)', minFluctuation: -50, maxFluctuation: 100, type: 'normal' }, 'usan': { name: 'ìš°ì‚° ì£¼ì‹', price: 1000, history: [1000], color: 'rgba(16, 185, 129, 0.7)', minFluctuation: -50, maxFluctuation: 100, type: 'normal' }, 'haetsal': { name: 'í–‡ì‚´ ì£¼ì‹', price: 1000, history: [1000], color: 'rgba(245, 158, 11, 0.7)', minFluctuation: -50, maxFluctuation: 100, type: 'normal' }}; for (const stockId in initialStocks) { const stockDocRef = doc(db, "stocks", stockId); const docSnap = await getDoc(stockDocRef); if (!docSnap.exists()) { await setDoc(stockDocRef, initialStocks[stockId]); } else { const existingData = docSnap.data(); if (initialStocks[stockId].type === 'normal' && (existingData.minFluctuation === undefined || existingData.maxFluctuation === undefined)) { await updateDoc(stockDocRef, {minFluctuation: existingData.minFluctuation || initialStocks[stockId].minFluctuation, maxFluctuation: existingData.maxFluctuation || initialStocks[stockId].maxFluctuation, type: existingData.type || initialStocks[stockId].type});}}} try { const goldSnap = await getDoc(doc(db, "stocks", "gold")); if (goldSnap.exists()) await deleteDoc(doc(db, "stocks", "gold")); } catch (error) { console.warn("Could not remove 'gold' stock doc:", error); }}
    async function updateNormalStockPrices() { /* ... */ for (const stockId in stockDataCache) { const stock = stockDataCache[stockId]; if (stock.type === 'normal') { const minFluctuation = stock.minFluctuation || -50; const maxFluctuation = stock.maxFluctuation || 100; const change = Math.floor(Math.random() * (maxFluctuation - minFluctuation + 1)) + minFluctuation; let newPrice = stock.price + change; if (newPrice < 100) newPrice = 100; const newHistory = [...(stock.history || [])]; newHistory.push(newPrice); if (newHistory.length > MAX_HISTORY_LENGTH) newHistory.shift(); try { await updateDoc(doc(db, "stocks", stockId), { price: newPrice, history: newHistory }); } catch (error) { console.error(`Error updating ${stock.name}:`, error); }}}}
    function startStockUpdates() { /* ... */ initializeStockData().then(() => { if (stockUpdateInterval) clearInterval(stockUpdateInterval); updateNormalStockPrices(); stockUpdateInterval = setInterval(updateNormalStockPrices, 60000); });}
    function stopStockUpdates() { if (stockUpdateInterval) clearInterval(stockUpdateInterval); stockUpdateInterval = null; }
    async function loadAndRenderMarketTabs() { /* ... */ if (!currentAuthUser) return; marketTabsContainer.innerHTML = '<p class="text-sm text-stone-500">ì£¼ì‹ ì •ë³´ ë¡œë”© ì¤‘...</p>'; if (Object.keys(stockDataCache).filter(id => id !== 'gold').length === 0) { try { const querySnapshot = await getDocs(query(collection(db, "stocks"))); querySnapshot.forEach((docSnap) => { if (docSnap.id !== 'gold') stockDataCache[docSnap.id] = { id: docSnap.id, ...docSnap.data() }; }); } catch (error) { marketTabsContainer.innerHTML = '<p class="text-sm text-red-500">ì£¼ì‹ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>'; return; }} marketTabsContainer.innerHTML = ''; const stockIds = Object.keys(stockDataCache).filter(id => id !== 'gold'); if (stockIds.length === 0) { marketTabsContainer.innerHTML = '<p class="text-sm text-stone-500">ê±°ë˜ ê°€ëŠ¥í•œ ì£¼ì‹ì´ ì—†ìŠµë‹ˆë‹¤.</p>'; marketContentContainer.innerHTML = ''; return; } stockIds.sort((a,b) => (stockDataCache[a].name > stockDataCache[b].name) ? 1 : -1); stockIds.forEach((stockId, index) => { const stock = stockDataCache[stockId]; const tabButton = document.createElement('button'); tabButton.className = `tab-button py-3 px-1 border-b-2 border-transparent text-stone-500 hover:text-teal-600 hover:border-teal-600 whitespace-nowrap text-sm font-medium`; tabButton.textContent = stock.name; tabButton.onclick = () => { document.querySelectorAll('#market .tab-button').forEach(btn => btn.classList.remove('active')); tabButton.classList.add('active'); renderStockDetails(stockId); }; marketTabsContainer.appendChild(tabButton); if (index === 0) { tabButton.classList.add('active'); renderStockDetails(stockId); }});}
    function renderStockDetails(stockId, filterType = 'day') { /* ... */ if (!currentUserData || !stockDataCache[stockId]) { marketContentContainer.innerHTML = '<p class="text-center text-stone-500">ì£¼ì‹ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>'; return; } const stock = stockDataCache[stockId]; const portfolioItem = currentUserData.portfolio?.[stockId]; const userHoldings = portfolioItem?.quantity || 0; const avgBuyPrice = portfolioItem?.avgBuyPrice || 0; const holdingValue = userHoldings * stock.price; let roiDisplay = 'N/A'; if (userHoldings > 0 && avgBuyPrice > 0) { const roi = ((stock.price - avgBuyPrice) / avgBuyPrice) * 100; roiDisplay = `${roi.toFixed(2)}%`; } marketContentContainer.innerHTML = `<div class="bg-white p-6 rounded-xl shadow-lg"><div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4"><div><h3 class="text-2xl font-bold text-teal-700">${stock.name}</h3><p class="text-4xl font-bold" style="color: ${stock.color || getRandomColor()}">${formatCurrency(stock.price)}</p></div><div class="text-right mt-2 md:mt-0"><p class="text-sm text-stone-500">ë‚˜ì˜ ë³´ìœ ëŸ‰: <span class="font-semibold">${userHoldings} ì£¼</span></p><p class="text-sm text-stone-500">í‰ê°€ì•¡: <span class="font-semibold">${formatCurrency(holdingValue)}</span></p><p class="text-sm text-stone-500">í‰ê·  ë§¤ìˆ˜ê°€: <span class="font-semibold">${userHoldings > 0 ? formatCurrency(avgBuyPrice) : 'N/A'}</span></p><p class="text-sm text-stone-500">í‰ê°€ ìˆ˜ìµë¥ : <span class="font-semibold ${roiDisplay !== 'N/A' && parseFloat(roiDisplay) >= 0 ? 'text-green-600' : 'text-red-600'}">${roiDisplay}</span></p><button id="aiStockAnalysisBtn-${stockId}" data-stock-id="${stockId}" class="mt-2 bg-purple-500 hover:bg-purple-600 text-white font-semibold py-2 px-3 rounded-lg text-sm transition-transform hover:scale-105">âœ¨ AI ì¢…ëª© ë¶„ì„</button></div></div><div class="mb-4 flex justify-center space-x-2"><button data-stock-id="${stockId}" data-filter="day" class="time-filter-btn ${filterType === 'day' ? 'active' : ''} bg-stone-200 hover:bg-stone-300 text-stone-700 text-xs py-1 px-3 rounded">1ì‹œê°„</button><button data-stock-id="${stockId}" data-filter="week" class="time-filter-btn ${filterType === 'week' ? 'active' : ''} bg-stone-200 hover:bg-stone-300 text-stone-700 text-xs py-1 px-3 rounded">1ì¼</button><button data-stock-id="${stockId}" data-filter="month" class="time-filter-btn ${filterType === 'month' ? 'active' : ''} bg-stone-200 hover:bg-stone-300 text-stone-700 text-xs py-1 px-3 rounded">ì „ì²´</button></div><div class="chart-container h-64 md:h-80 mb-6"><canvas id="stockChart-${stockId}"></canvas></div><div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div><h4 class="text-lg font-semibold text-teal-600 mb-2">ë§¤ìˆ˜ (ì‚¬ê¸°)</h4><form id="buyForm-${stockId}" class="space-y-3"><input type="hidden" name="stockId" value="${stockId}"><div><label for="buyQuantity-${stockId}" class="block text-sm font-medium text-stone-700">ìˆ˜ëŸ‰</label><input type="number" id="buyQuantity-${stockId}" name="quantity" min="1" required class="mt-1 block w-full p-2 border border-stone-300 rounded-md shadow-sm focus:ring-teal-500 focus:border-teal-500"></div><p class="text-sm">ì˜ˆìƒ ê¸ˆì•¡: <span id="buyEstimate-${stockId}">0 ì›</span></p><button type="submit" class="w-full bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-2 px-3 rounded-lg">ë§¤ìˆ˜</button></form></div><div><h4 class="text-lg font-semibold text-red-600 mb-2">ë§¤ë„ (íŒ”ê¸°)</h4><form id="sellForm-${stockId}" class="space-y-3"><input type="hidden" name="stockId" value="${stockId}"><div><label for="sellQuantity-${stockId}" class="block text-sm font-medium text-stone-700">ìˆ˜ëŸ‰</label><input type="number" id="sellQuantity-${stockId}" name="quantity" min="1" max="${userHoldings}" ${userHoldings === 0 ? 'disabled' : ''} required class="mt-1 block w-full p-2 border border-stone-300 rounded-md shadow-sm focus:ring-red-500 focus:border-red-500"></div><p class="text-sm">ì˜ˆìƒ ê¸ˆì•¡: <span id="sellEstimate-${stockId}">0 ì›</span></p><button type="submit" class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-3 rounded-lg" ${userHoldings === 0 ? 'disabled' : ''}>ë§¤ë„</button></form></div></div></div>`; let historyToDisplay = stock.history || []; if (filterType === 'day') historyToDisplay = historyToDisplay.slice(-60); else if (filterType === 'week') historyToDisplay = historyToDisplay.slice(- (60 * 24) > MAX_HISTORY_LENGTH ? -MAX_HISTORY_LENGTH : -(60*24) ); else if (filterType === 'month') historyToDisplay = historyToDisplay.slice(-MAX_HISTORY_LENGTH); renderStockChart(stockId, historyToDisplay, stock.color || getRandomColor()); const buyQuantityInput = document.getElementById(`buyQuantity-${stockId}`); const buyEstimateEl = document.getElementById(`buyEstimate-${stockId}`); buyQuantityInput.addEventListener('input', () => { const quantity = parseInt(buyQuantityInput.value) || 0; buyEstimateEl.textContent = formatCurrency(quantity * stock.price); }); const sellQuantityInput = document.getElementById(`sellQuantity-${stockId}`); const sellEstimateEl = document.getElementById(`sellEstimate-${stockId}`); if (sellQuantityInput) sellQuantityInput.addEventListener('input', () => { const quantity = parseInt(sellQuantityInput.value) || 0; sellEstimateEl.textContent = formatCurrency(quantity * stock.price); }); document.getElementById(`buyForm-${stockId}`).addEventListener('submit', handleBuyStock); const sellForm = document.getElementById(`sellForm-${stockId}`); if (sellForm) sellForm.addEventListener('submit', handleSellStock); document.getElementById(`aiStockAnalysisBtn-${stockId}`).addEventListener('click', handleAiStockAnalysis); document.querySelectorAll(`#marketContent .time-filter-btn`).forEach(button => button.addEventListener('click', (e) => renderStockDetails(e.target.dataset.stockId, e.target.dataset.filter)));}
    async function handleAiStockAnalysis(e) { /* ... */ const stockId = e.target.dataset.stockId; const stockName = stockDataCache[stockId].name; const prompt = `ì´ˆë“±í•™ìƒì„ ìœ„í•œ ${stockName}ì— ëŒ€í•œ ì§§ê³  ì¬ë¯¸ìˆëŠ” ì´ì•¼ê¸°ë¥¼ ë§Œë“¤ì–´ì¤˜. ì˜ˆë¥¼ ë“¤ì–´, ${stockName}ì´ ì™œ ì˜¤ë¥´ê±°ë‚˜ ë‚´ë¦´ ìˆ˜ ìˆëŠ”ì§€, ë˜ëŠ” ${stockName}ê³¼ ê´€ë ¨ëœ ì¬ë¯¸ìˆëŠ” ìƒìƒì„ ë§ë¶™ì—¬ì„œ ì´ì•¼ê¸°í•´ì¤˜. ê¸ì •ì ì´ê³  í¬ë§ì°¬ ë‚´ìš©ìœ¼ë¡œ ì‘ì„±í•´ì¤˜. 100ì ì´ë‚´ë¡œ ì§§ê²Œ ë¶€íƒí•´.`; generateTextViaGemini(prompt); }
    function renderStockChart(stockId, historyData, color) { /* ... */ const ctx = document.getElementById(`stockChart-${stockId}`).getContext('2d'); if (stockChartInstances[stockId]) stockChartInstances[stockId].destroy(); if (!historyData || historyData.length === 0) { ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height); ctx.textAlign = "center"; ctx.fillStyle = "#888"; ctx.fillText("ê°€ê²© ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.", ctx.canvas.width / 2, ctx.canvas.height / 2); return; } const labels = historyData.map((_, index) => `${index + 1}`); stockChartInstances[stockId] = new Chart(ctx, {type: 'line', data: {labels: labels, datasets: [{label: `${stockDataCache[stockId].name} ê°€ê²© ë³€ë™`, data: historyData, borderColor: color.replace('0.7', '1'), backgroundColor: color, tension: 0.1, fill: true,}]}, options: {responsive: true, maintainAspectRatio: false, scales: {y: { beginAtZero: false, ticks: { callback: function(value) { return formatCurrency(value); }}}, x: { ticks: { maxRotation: 0, minRotation: 0, autoSkip: true, maxTicksLimit: 10 }}}, plugins: { legend: { display: false }, tooltip: { callbacks: {label: function(context) { return formatCurrency(context.parsed.y); }, title: function(context) { return `ì‹œì  ${context[0].label}`; }}}}}});}
    async function handleBuyStock(e) { /* ... */ e.preventDefault(); if (!currentAuthUser || !currentUserData) { showInfoModal('ì˜¤ë¥˜', 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.'); return; } const stockId = e.target.stockId.value; const quantityToBuy = parseInt(e.target.quantity.value); const stock = stockDataCache[stockId]; if (!stock || typeof stock.price !== 'number') { showInfoModal('ì˜¤ë¥˜', 'ì£¼ì‹ ê°€ê²© ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); return; } const cost = quantityToBuy * stock.price; if (isNaN(quantityToBuy) || quantityToBuy <= 0) { showInfoModal('ì˜¤ë¥˜', 'ì˜¬ë°”ë¥¸ ìˆ˜ëŸ‰ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; } if (cost > currentUserData.balance) { showInfoModal('ì˜¤ë¥˜', 'ì”ì•¡ì´ ë¶€ì¡±í•©ë‹ˆë‹¤.'); return; } try { const userDocRef = doc(db, "users", currentAuthUser.uid); await runTransaction(db, async (transaction) => { const userSnap = await transaction.get(userDocRef); if (!userSnap.exists()) throw new Error("ì‚¬ìš©ì ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); const userData = userSnap.data(); if (userData.balance < cost) throw new Error("ì”ì•¡ì´ ë¶€ì¡±í•©ë‹ˆë‹¤. (íŠ¸ëœì­ì…˜ í™•ì¸)"); const currentPortfolio = userData.portfolio || {}; const currentStockInfo = currentPortfolio[stockId] || { quantity: 0, avgBuyPrice: 0, totalInvested: 0, totalShares: 0 }; const newTotalShares = (currentStockInfo.totalShares || 0) + quantityToBuy; const newTotalInvested = (currentStockInfo.totalInvested || 0) + cost; const newAvgBuyPrice = newTotalShares > 0 ? parseFloat((newTotalInvested / newTotalShares).toFixed(2)) : 0; const updatedStockData = {quantity: (currentStockInfo.quantity || 0) + quantityToBuy, avgBuyPrice: newAvgBuyPrice, totalInvested: newTotalInvested, totalShares: newTotalShares}; const updates = { balance: increment(-cost), [`portfolio.${stockId}`]: updatedStockData }; transaction.update(userDocRef, updates); transaction.set(doc(collection(db, "users", currentAuthUser.uid, "transactions")), {type: 'buy', description: `${stock.name} ${quantityToBuy}ì£¼ ë§¤ìˆ˜`, amount: cost, stockId: stockId, quantity: quantityToBuy, pricePerStock: stock.price, date: serverTimestamp()}); }); showInfoModal('ë§¤ìˆ˜ ì„±ê³µ', `${stock.name} ${quantityToBuy}ì£¼ë¥¼ ${formatCurrency(cost)}ì— ë§¤ìˆ˜í–ˆìŠµë‹ˆë‹¤.`); e.target.reset(); document.getElementById(`buyEstimate-${stockId}`).textContent = '0 ì›'; } catch (error) { showInfoModal('ë§¤ìˆ˜ ì‹¤íŒ¨', `ë§¤ìˆ˜ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${error.message}`); }}
    async function handleSellStock(e) { /* ... */ e.preventDefault(); if (!currentAuthUser || !currentUserData) { showInfoModal('ì˜¤ë¥˜', 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.'); return; } const stockId = e.target.stockId.value; const quantityToSell = parseInt(e.target.quantity.value); const stock = stockDataCache[stockId]; if (!stock || typeof stock.price !== 'number') { showInfoModal('ì˜¤ë¥˜', 'ì£¼ì‹ ê°€ê²© ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); return; } const portfolioItem = currentUserData.portfolio?.[stockId]; const currentHoldings = portfolioItem?.quantity || 0; const avgBuyPrice = portfolioItem?.avgBuyPrice || 0; if (isNaN(quantityToSell) || quantityToSell <= 0) { showInfoModal('ì˜¤ë¥˜', 'ì˜¬ë°”ë¥¸ ìˆ˜ëŸ‰ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; } if (quantityToSell > currentHoldings) { showInfoModal('ì˜¤ë¥˜', 'ë³´ìœ  ìˆ˜ëŸ‰ì´ ë¶€ì¡±í•©ë‹ˆë‹¤.'); return; } const income = quantityToSell * stock.price; const profitOrLoss = (stock.price - avgBuyPrice) * quantityToSell; try { const userDocRef = doc(db, "users", currentAuthUser.uid); await runTransaction(db, async (transaction) => { const userSnap = await transaction.get(userDocRef); if (!userSnap.exists()) throw new Error("ì‚¬ìš©ì ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); const currentPortfolio = userSnap.data().portfolio || {}; const currentStockInfo = currentPortfolio[stockId]; if (!currentStockInfo || currentStockInfo.quantity < quantityToSell) throw new Error("ë³´ìœ  ìˆ˜ëŸ‰ì´ ë¶€ì¡±í•©ë‹ˆë‹¤. (íŠ¸ëœì­ì…˜ í™•ì¸)"); const newQuantity = currentStockInfo.quantity - quantityToSell; const updates = { balance: increment(income) }; if (newQuantity === 0) updates[`portfolio.${stockId}`] = deleteField(); else updates[`portfolio.${stockId}`] = { ...currentStockInfo, quantity: newQuantity }; transaction.update(userDocRef, updates); transaction.set(doc(collection(db, "users", currentAuthUser.uid, "transactions")), {type: 'sell', description: `${stock.name} ${quantityToSell}ì£¼ ë§¤ë„ (ì†ìµ: ${formatCurrency(profitOrLoss)})`, amount: income, stockId: stockId, quantity: quantityToSell, pricePerStock: stock.price, profitOrLoss: profitOrLoss, date: serverTimestamp()}); }); showInfoModal('ë§¤ë„ ì„±ê³µ', `${stock.name} ${quantityToSell}ì£¼ë¥¼ ${formatCurrency(income)}ì— ë§¤ë„í–ˆìŠµë‹ˆë‹¤. (ì†ìµ: ${formatCurrency(profitOrLoss)})`); e.target.reset(); document.getElementById(`sellEstimate-${stockId}`).textContent = '0 ì›'; } catch (error) { showInfoModal('ë§¤ë„ ì‹¤íŒ¨', `ë§¤ë„ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${error.message}`); }}

    // --- Deeds Logic ---
    deedForm.addEventListener('submit', async (e) => { /* ... */ e.preventDefault(); if (!currentAuthUser || !currentUserData) { showInfoModal('ì˜¤ë¥˜', 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.'); return; } const description = deedDescriptionEl.value.trim(); if (!description) { showInfoModal('ì˜¤ë¥˜', 'ì„ í–‰ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; } const deedsColRefQuery = query(collection(db, "users", currentAuthUser.uid, "deeds"), orderBy("date", "desc"), limit(1)); const lastDeedSnapshot = await getDocs(deedsColRefQuery); if (!lastDeedSnapshot.empty) { const lastDeedData = lastDeedSnapshot.docs[0].data(); if (lastDeedData.date && isSameDay(lastDeedData.date, new Date())) { showInfoModal("ì•Œë¦¼", "ì˜¤ëŠ˜ì€ ì´ë¯¸ ì„ í–‰ì„ ë“±ë¡í–ˆì–´ìš”! ë‚´ì¼ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”."); return; }} const reward = 1000; try { await updateDoc(doc(db, "users", currentAuthUser.uid), { balance: increment(reward) }); await addDoc(collection(db, "users", currentAuthUser.uid, "deeds"), {description: description, reward: reward, status: 'approved', date: serverTimestamp()}); await addDoc(collection(db, "users", currentAuthUser.uid, "transactions"), {type: 'deed', description: `ì„ í–‰ë³´ìƒ: ${description.substring(0,20)}...`, amount: reward, date: serverTimestamp()}); showInfoModal('ì„ í–‰ ë“±ë¡ ì™„ë£Œ', `"${description.substring(0,30)}..." ì„ í–‰ìœ¼ë¡œ ${formatCurrency(reward)}ì´ ì…ê¸ˆë˜ì—ˆìŠµë‹ˆë‹¤!`); deedForm.reset(); } catch (error) { showInfoModal("ì„ í–‰ ë“±ë¡ ì‹¤íŒ¨", "ì„ í–‰ ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."); }});
    function renderDeeds() { /* ... */ if (!currentUserData || !currentUserData.deeds) { deedListEl.innerHTML = '<li class="p-3 bg-stone-50 rounded-md border border-stone-200 text-center text-stone-500">ì„ í–‰ ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</li>'; return; } deedListEl.innerHTML = ''; if (currentUserData.deeds.length === 0) { deedListEl.innerHTML = '<li class="p-3 bg-stone-50 rounded-md border border-stone-200 text-center text-stone-500">ë“±ë¡ëœ ì„ í–‰ì´ ì—†ìŠµë‹ˆë‹¤.</li>'; return; } currentUserData.deeds.forEach(deed => { const li = document.createElement('li'); li.className = 'p-4 bg-white rounded-lg shadow-sm border border-stone-200 flex justify-between items-center'; const deedTextDiv = document.createElement('div'); deedTextDiv.innerHTML = `<p class="font-medium text-stone-700">${deed.description}</p><p class="text-xs text-stone-500">${formatDate(deed.date)} - ${formatCurrency(deed.reward)}</p>`; const buttonsDiv = document.createElement('div'); buttonsDiv.className = 'flex flex-col sm:flex-row items-end space-y-2 sm:space-y-0 sm:space-x-2'; const statusSpan = document.createElement('span'); statusSpan.className = `text-xs font-semibold ${deed.status === 'approved' ? 'text-green-600 bg-green-100' : 'text-amber-600 bg-amber-100'} px-2 py-1 rounded-full mb-2 sm:mb-0`; statusSpan.textContent = deed.status === 'approved' ? 'ë³´ìƒì™„ë£Œ' : 'ìŠ¹ì¸ëŒ€ê¸°'; const aiButton = document.createElement('button'); aiButton.className = 'bg-purple-500 hover:bg-purple-600 text-white font-semibold py-1 px-2 rounded-lg text-xs transition-transform hover:scale-105'; aiButton.innerHTML = 'âœ¨ ì´ì•¼ê¸° í™•ì¥'; aiButton.onclick = () => handleAiDeedStory(deed.description); buttonsDiv.appendChild(statusSpan); buttonsDiv.appendChild(aiButton); li.appendChild(deedTextDiv); li.appendChild(buttonsDiv); deedListEl.appendChild(li); });}
    async function handleAiDeedStory(deedDescription) { /* ... */ const prompt = `ì´ˆë“±í•™ìƒì´ ì‘ì„±í•œ "${deedDescription}"ë¼ëŠ” ì„ í–‰ ë‚´ìš©ì´ ìˆìŠµë‹ˆë‹¤. ì´ ì„ í–‰ì„ ë°”íƒ•ìœ¼ë¡œ, ì–´ë¦°ì´ê°€ ì´í•´í•˜ê¸° ì‰½ê³  ê¸ì •ì ì¸ ì¹­ì°¬ê³¼ í•¨ê»˜ ì´ì•¼ê¸°ë¥¼ ì¡°ê¸ˆ ë” êµ¬ì²´ì ì´ê³  ì¬ë¯¸ìˆê²Œ í™•ì¥í•´ì£¼ì„¸ìš”. ì˜ˆë¥¼ ë“¤ì–´, ê·¸ ì„ í–‰ì´ ë‹¤ë¥¸ ì‚¬ëŒì—ê²Œ ì–´ë–¤ ì¢‹ì€ ì˜í–¥ì„ ì£¼ì—ˆëŠ”ì§€, ë˜ëŠ” ê·¸ ì„ í–‰ì„ í†µí•´ ë¬´ì—‡ì„ ë°°ì› ëŠ”ì§€ ë“±ì„ í¬í•¨í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. 150ì ì´ë‚´ë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”.`; generateTextViaGemini(prompt); }

    // --- Transactions Logic ---
    function renderTransactions() { /* ... */ if (!currentUserData || !currentUserData.transactions) { transactionListEl.innerHTML = '<tr><td colspan="5" class="text-center py-10 text-stone-500">ê±°ë˜ ë‚´ì—­ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td></tr>'; return; } transactionListEl.innerHTML = ''; const filterValue = transactionFilterEl.value; const filteredTransactions = currentUserData.transactions.filter(tx => (filterValue === 'all' || tx.type === filterValue)); if (filteredTransactions.length === 0) { transactionListEl.innerHTML = '<tr><td colspan="5" class="text-center py-10 text-stone-500">í•´ë‹¹ ì¢…ë¥˜ì˜ ê±°ë˜ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>'; return; } filteredTransactions.forEach(tx => { const tr = document.createElement('tr'); let amountDisplay = ''; let balanceAfterTxDisplay = 'N/A'; switch (tx.type) { case 'transfer_in': amountDisplay = `<span class="text-sky-600 font-semibold">+${formatCurrency(tx.amount)}</span>`; break; case 'transfer_out': amountDisplay = `<span class="text-red-600 font-semibold">-${formatCurrency(tx.amount)}</span>`; break; case 'buy': amountDisplay = `<span class="text-red-600">${formatCurrency(tx.amount)} (${tx.quantity}ì£¼)</span>`; break; case 'sell': amountDisplay = `<span class="text-sky-600">+${formatCurrency(tx.amount)} (${tx.quantity}ì£¼)</span>`; if (tx.profitOrLoss !== undefined) amountDisplay += ` (ì†ìµ: ${formatCurrency(tx.profitOrLoss)})`; break; case 'deed': amountDisplay = `<span class="text-amber-600 font-semibold">+${formatCurrency(tx.amount)}</span>`; break; case 'admin_credit': amountDisplay = `<span class="text-blue-600 font-semibold">+${formatCurrency(tx.amount)}</span>`; break; case 'admin_debit': amountDisplay = `<span class="text-orange-600 font-semibold">-${formatCurrency(tx.amount)}</span>`; break; case 'auction_bid': amountDisplay = `<span class="text-red-700 font-semibold">-${formatCurrency(tx.amount)}</span>`; break; case 'auction_bid_cancel': amountDisplay = `<span class="text-green-700 font-semibold">+${formatCurrency(tx.amount)}</span>`; break; case 'auction_refund_lost': amountDisplay = `<span class="text-sky-700 font-semibold">+${formatCurrency(tx.amount)}</span>`; break; default: amountDisplay = formatCurrency(tx.amount); } tr.innerHTML = `<td class="px-6 py-4 whitespace-nowrap text-sm text-stone-500">${formatDate(tx.date)}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-stone-900">${getTransactionTypeKorean(tx.type)}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-stone-500">${tx.description}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-right">${amountDisplay}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-right text-stone-500">${balanceAfterTxDisplay}</td>`; transactionListEl.appendChild(tr); });}
    function getTransactionTypeKorean(type) { /* ... */ switch (type) { case 'transfer_in': return 'ì…ê¸ˆ'; case 'transfer_out': return 'ì¶œê¸ˆ'; case 'buy': return 'ì£¼ì‹ë§¤ìˆ˜'; case 'sell': return 'ì£¼ì‹ë§¤ë„'; case 'deed': return 'ì„ í–‰ë³´ìƒ'; case 'admin_credit': return 'ê´€ë¦¬ì ì§€ê¸‰'; case 'admin_debit': return 'ê´€ë¦¬ì íšŒìˆ˜'; case 'auction_bid': return 'ê²½ë§¤ ì…ì°°'; case 'auction_bid_cancel': return 'ê²½ë§¤ ì…ì°° ì·¨ì†Œ'; case 'auction_refund_lost': return 'ê²½ë§¤ ë‚™ì°°ì‹¤íŒ¨ í™˜ë¶ˆ'; default: return type; }}
    transactionFilterEl.addEventListener('change', renderTransactions);

    // --- Settings Logic ---
    function loadUserSettings() { if (currentUserData) userNameInput.value = currentUserData.name || ''; }
    settingsForm.addEventListener('submit', async (e) => { /* ... */ e.preventDefault(); if (!currentAuthUser) { showInfoModal("ì˜¤ë¥˜", "ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤."); return; } const newName = userNameInput.value.trim(); if (!newName) { showInfoModal("ì˜¤ë¥˜", "ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."); return; } try { await updateProfile(currentAuthUser, { displayName: newName }); await updateDoc(doc(db, "users", currentAuthUser.uid), { name: newName }); showInfoModal("ì„±ê³µ", "ì´ë¦„ì´ ì„±ê³µì ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤."); loggedInUserDisplay.textContent = newName; } catch (error) { showInfoModal("ì˜¤ë¥˜", `ì´ë¦„ ë³€ê²½ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${error.message}`); }});
    changePasswordForm.addEventListener('submit', async (e) => { /* ... */ e.preventDefault(); if (!currentAuthUser) { showInfoModal("ì˜¤ë¥˜", "ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤."); return; } const currentPasswordVal = document.getElementById('currentPassword').value; const newPasswordVal = document.getElementById('newPassword').value; const confirmNewPasswordVal = document.getElementById('confirmNewPassword').value; if (!currentPasswordVal || !newPasswordVal || !confirmNewPasswordVal) { showInfoModal("ì˜¤ë¥˜", "ëª¨ë“  ë¹„ë°€ë²ˆí˜¸ í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”."); return; } if (newPasswordVal !== confirmNewPasswordVal) { showInfoModal("ì˜¤ë¥˜", "ìƒˆ ë¹„ë°€ë²ˆí˜¸ì™€ í™•ì¸ ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."); return; } if (newPasswordVal.length < 6) { showInfoModal("ì˜¤ë¥˜", "ìƒˆ ë¹„ë°€ë²ˆí˜¸ëŠ” 6ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤."); return; } try { const credential = EmailAuthProvider.credential(currentAuthUser.email, currentPasswordVal); await reauthenticateWithCredential(currentAuthUser, credential); await updatePassword(currentAuthUser, newPasswordVal); await updateDoc(doc(db, "users", currentAuthUser.uid), { temporaryPassword: deleteField() }); showInfoModal("ì„±ê³µ", "ë¹„ë°€ë²ˆí˜¸ê°€ ì„±ê³µì ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤."); changePasswordForm.reset(); } catch (error) { showInfoModal("ì˜¤ë¥˜", `ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${mapAuthErrorCodeToMessage(error.code)}`); }});

    // --- Admin Logic ---
    async function loadAdminData() { /* ... */ if (!currentAuthUser || !currentUserData || currentUserData.role !== 'teacher') { adminStudentListEl.innerHTML = '<li>ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.</li>'; return; } adminStudentListEl.innerHTML = '<li>í•™ìƒ ì •ë³´ ë¡œë”© ì¤‘...</li>'; try { const usersSnapshot = await getDocs(collection(db, "users")); adminStudentListEl.innerHTML = ''; usersSnapshot.forEach(docSnap => { const student = docSnap.data(); const studentId = docSnap.id; const li = document.createElement('li'); li.className = "flex justify-between items-center py-1"; li.innerHTML = `<div class="flex-grow"><span class="font-medium">${student.name}</span> (${student.email})<br><span class="text-xs text-stone-500">UID: ${studentId.substring(0,8)}... - ì”ì•¡: ${formatCurrency(student.balance)}</span></div><div class="flex space-x-1"><button data-studentid="${studentId}" data-studentname="${student.name}" class="admin-edit-name-btn bg-yellow-500 hover:bg-yellow-600 text-white text-xs py-1 px-2 rounded">ì´ë¦„ë³€ê²½</button><button data-studentid="${studentId}" data-studentname="${student.name}" data-studentemail="${student.email}" class="admin-reset-password-btn bg-pink-500 hover:bg-pink-600 text-white text-xs py-1 px-2 rounded">ë¹„ë²ˆì´ˆê¸°í™”</button><button data-studentid="${studentId}" data-studentname="${student.name}" data-currentbalance="${student.balance}" class="admin-adjust-balance-btn bg-blue-500 hover:bg-blue-600 text-white text-xs py-1 px-2 rounded">ì”ì•¡ì¡°ì •</button><button data-studentid="${studentId}" data-studentname="${student.name}" class="admin-view-details-btn bg-purple-500 hover:bg-purple-600 text-white text-xs py-1 px-2 rounded">ìƒì„¸ë³´ê¸°</button></div>`; adminStudentListEl.appendChild(li); }); document.querySelectorAll('.admin-adjust-balance-btn').forEach(b => b.addEventListener('click', (e) => showAdminAdjustBalanceModal(e.target.dataset.studentid, e.target.dataset.studentname, parseFloat(e.target.dataset.currentbalance)))); document.querySelectorAll('.admin-edit-name-btn').forEach(b => b.addEventListener('click', (e) => showAdminEditNameModal(e.target.dataset.studentid, e.target.dataset.studentname))); document.querySelectorAll('.admin-reset-password-btn').forEach(b => b.addEventListener('click', (e) => showAdminResetPasswordModal(e.target.dataset.studentid, e.target.dataset.studentname, e.target.dataset.studentemail))); document.querySelectorAll('.admin-view-details-btn').forEach(b => b.addEventListener('click', (e) => loadAndShowAdminUserDetail(e.target.dataset.studentid, e.target.dataset.studentname))); } catch (error) { adminStudentListEl.innerHTML = '<li>í•™ìƒ ì •ë³´ ë¡œë“œ ì‹¤íŒ¨</li>'; } const adminStockSelect = document.getElementById('adminStockSelect'); adminStockSelect.innerHTML = '<option value="">-- ì£¼ì‹ ì„ íƒ --</option>'; adminStockFluctuationSettingsEl.innerHTML = ''; Object.keys(stockDataCache).filter(id => id !== 'gold').sort((a,b) => (stockDataCache[a].name > stockDataCache[b].name) ? 1 : -1).forEach(stockId => { const stock = stockDataCache[stockId]; const option = document.createElement('option'); option.value = stockId; option.textContent = stock.name; adminStockSelect.appendChild(option); if (stock.type === 'normal') { const settingDiv = document.createElement('div'); settingDiv.className = 'mt-2 p-2 border rounded border-stone-300'; settingDiv.innerHTML = `<p class="text-sm font-medium text-stone-700">${stock.name} ë³€ë™í­:</p><div class="flex space-x-2 mt-1"><input type="number" id="minFluctuation-${stockId}" value="${stock.minFluctuation || -50}" placeholder="ìµœì†Œ" class="w-1/2 p-1 border rounded text-sm"><input type="number" id="maxFluctuation-${stockId}" value="${stock.maxFluctuation || 100}" placeholder="ìµœëŒ€" class="w-1/2 p-1 border rounded text-sm"></div><button data-stockid="${stockId}" class="save-fluctuation-btn mt-2 bg-green-500 hover:bg-green-600 text-white text-xs py-1 px-2 rounded w-full">ë³€ë™í­ ì €ì¥ (${stock.name})</button>`; adminStockFluctuationSettingsEl.appendChild(settingDiv); }}); document.querySelectorAll('.save-fluctuation-btn').forEach(b => b.addEventListener('click', async (e) => { const stockId = e.target.dataset.stockid; const minFluctuation = parseInt(document.getElementById(`minFluctuation-${stockId}`).value); const maxFluctuation = parseInt(document.getElementById(`maxFluctuation-${stockId}`).value); if (isNaN(minFluctuation) || isNaN(maxFluctuation) || minFluctuation >= maxFluctuation) { showInfoModal("ì˜¤ë¥˜", "ìœ íš¨í•œ ë³€ë™í­ì„ ì…ë ¥í•˜ì„¸ìš” (ìµœì†Œ < ìµœëŒ€)."); return; } try { await updateDoc(doc(db, "stocks", stockId), { minFluctuation, maxFluctuation }); showInfoModal("ì„±ê³µ", `${stockDataCache[stockId].name} ë³€ë™í­ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.`); } catch (error) { showInfoModal("ì˜¤ë¥˜", "ë³€ë™í­ ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ."); }}));}
    adminConfirmAdjustBalanceBtn.addEventListener('click', async () => { /* ... */ if (!studentIdToAdjust) return; const amount = parseInt(adminAdjustmentAmountInput.value); const reason = adminAdjustmentReasonInput.value.trim() || "ê´€ë¦¬ì ì”ì•¡ ì¡°ì •"; if (isNaN(amount)) { showInfoModal("ì˜¤ë¥˜", "ìœ íš¨í•œ ì¡°ì • ê¸ˆì•¡ì„ ì…ë ¥í•˜ì„¸ìš”."); return; } try { await updateDoc(doc(db, "users", studentIdToAdjust), { balance: increment(amount) }); await addDoc(collection(db, "users", studentIdToAdjust, "transactions"), {type: amount >= 0 ? 'admin_credit' : 'admin_debit', description: reason, amount: Math.abs(amount), date: serverTimestamp()}); showInfoModal("ì„±ê³µ", "í•™ìƒ ì”ì•¡ì´ ì„±ê³µì ìœ¼ë¡œ ì¡°ì •ë˜ì—ˆìŠµë‹ˆë‹¤."); closeAdminAdjustBalanceModal(); } catch (error) { showInfoModal("ì˜¤ë¥˜", `ì”ì•¡ ì¡°ì • ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${error.message}`); }});
    adminConfirmEditNameBtn.addEventListener('click', async () => { /* ... */ if (!studentIdToEditName) return; const newName = adminNewStudentNameInput.value.trim(); if (!newName) { showInfoModal("ì˜¤ë¥˜", "ìƒˆë¡œìš´ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”."); return; } try { await updateDoc(doc(db, "users", studentIdToEditName), { name: newName }); if (currentAuthUser && studentIdToEditName === currentAuthUser.uid) { await updateProfile(currentAuthUser, { displayName: newName }); loggedInUserDisplay.textContent = newName; } showInfoModal("ì„±ê³µ", "í•™ìƒ ì´ë¦„ì´ ì„±ê³µì ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤."); closeAdminEditNameModal(); loadAdminData(); } catch (error) { showInfoModal("ì˜¤ë¥˜", `ì´ë¦„ ë³€ê²½ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${error.message}`); }});
    adminConfirmResetPasswordBtn.addEventListener('click', async () => { /* ... */ if (!studentIdToResetPassword) return; const newTemporaryPassword = adminNewTemporaryPasswordInput.value.trim(); if (!newTemporaryPassword || newTemporaryPassword.length < 6) { showInfoModal("ì˜¤ë¥˜", "ì„ì‹œ ë¹„ë°€ë²ˆí˜¸ëŠ” 6ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤."); return; } try { await updateDoc(doc(db, "users", studentIdToResetPassword), { temporaryPassword: newTemporaryPassword }); showInfoModal("ì„±ê³µ", `í•™ìƒì˜ ì„ì‹œ ë¹„ë°€ë²ˆí˜¸ê°€ "${newTemporaryPassword}"ë¡œ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤. í•™ìƒì—ê²Œ ì „ë‹¬í•´ì£¼ì„¸ìš”.`); closeAdminResetPasswordModal(); } catch (error) { showInfoModal("ì˜¤ë¥˜", `ì„ì‹œ ë¹„ë°€ë²ˆí˜¸ ì„¤ì • ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${error.message}`); }});
    async function loadAndShowAdminUserDetail(studentId, studentName) { /* ... */ adminUserDetailNameEl.textContent = `${studentName} í•™ìƒ ìƒì„¸ ì •ë³´`; adminUserPortfolioListEl.innerHTML = '<li>í¬íŠ¸í´ë¦¬ì˜¤ ì •ë³´ ë¡œë”© ì¤‘...</li>'; adminUserTransactionListEl.innerHTML = '<tr><td colspan="4" class="text-center py-4">ê±°ë˜ ë‚´ì—­ ë¡œë”© ì¤‘...</td></tr>'; adminUserDeedListEl.innerHTML = '<li>ì„ í–‰ ê¸°ë¡ ë¡œë”© ì¤‘...</li>'; showSection('adminUserDetail'); try { const userDocSnap = await getDoc(doc(db, "users", studentId)); if (userDocSnap.exists()) { const userData = userDocSnap.data(); adminUserPortfolioListEl.innerHTML = ''; if (userData.portfolio && Object.keys(userData.portfolio).length > 0) { for (const stockId in userData.portfolio) { const item = userData.portfolio[stockId]; const stockInfo = stockDataCache[stockId]; if (!stockInfo) continue; const li = document.createElement('li'); li.className = "flex justify-between items-center"; li.innerHTML = `<span>${stockInfo.name}: ${item.quantity}ì£¼ (í‰ë‹¨ê°€: ${formatCurrency(item.avgBuyPrice || 0)})</span><button data-studentid="${studentId}" data-stockid="${stockId}" data-stockname="${stockInfo.name}" class="admin-reset-stock-btn bg-red-500 hover:bg-red-600 text-white text-xs py-0.5 px-1.5 rounded ml-2">ì´ˆê¸°í™”</button>`; adminUserPortfolioListEl.appendChild(li); } document.querySelectorAll('.admin-reset-stock-btn').forEach(b => b.addEventListener('click', (e) => showAdminResetStockModal(e.target.dataset.studentid, studentName, e.target.dataset.stockname, e.target.dataset.stockid))); } else adminUserPortfolioListEl.innerHTML = '<li>ë³´ìœ  ì£¼ì‹ ì—†ìŒ</li>'; } else adminUserPortfolioListEl.innerHTML = '<li>ì‚¬ìš©ì ì •ë³´ ì—†ìŒ</li>'; const transactionsSnapshot = await getDocs(query(collection(db, "users", studentId, "transactions"), orderBy("date", "desc"))); adminUserTransactionListEl.innerHTML = ''; if (transactionsSnapshot.empty) adminUserTransactionListEl.innerHTML = '<tr><td colspan="4" class="text-center py-4">ê±°ë˜ ë‚´ì—­ ì—†ìŒ</td></tr>'; else transactionsSnapshot.forEach(docSnap => { const tx = docSnap.data(); const tr = document.createElement('tr'); tr.innerHTML = `<td class="px-3 py-2 whitespace-nowrap">${formatDate(tx.date)}</td><td class="px-3 py-2">${getTransactionTypeKorean(tx.type)}</td><td class="px-3 py-2">${tx.description}</td><td class="px-3 py-2 text-right">${formatCurrency(tx.amount)} ${tx.quantity ? `(${tx.quantity}ì£¼)`: ''}</td>`; adminUserTransactionListEl.appendChild(tr); }); const deedsSnapshot = await getDocs(query(collection(db, "users", studentId, "deeds"), orderBy("date", "desc"))); adminUserDeedListEl.innerHTML = ''; if (deedsSnapshot.empty) adminUserDeedListEl.innerHTML = '<li>ì„ í–‰ ê¸°ë¡ ì—†ìŒ</li>'; else deedsSnapshot.forEach(docSnap => { const deed = docSnap.data(); const li = document.createElement('li'); li.innerHTML = `<strong>${formatDate(deed.date)}:</strong> ${deed.description} (+${formatCurrency(deed.reward)})`; adminUserDeedListEl.appendChild(li); }); } catch (error) { showInfoModal("ì˜¤ë¥˜", "í•™ìƒ ìƒì„¸ ì •ë³´ ë¡œë“œ ì‹¤íŒ¨"); }}
    adminConfirmResetStockBtn.addEventListener('click', async () => { /* ... */ if (!studentIdToResetStock || !stockIdToReset) return; try { await updateDoc(doc(db, "users", studentIdToResetStock), { [`portfolio.${stockIdToReset}`]: deleteField() }); showInfoModal("ì„±ê³µ", "í•´ë‹¹ ì£¼ì‹ ë³´ìœ  ì •ë³´ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤."); closeAdminResetStockModal(); const studentName = adminUserDetailNameEl.textContent.split(" ")[0]; loadAndShowAdminUserDetail(studentIdToResetStock, studentName); } catch (error) { showInfoModal("ì˜¤ë¥˜", "ì£¼ì‹ ì •ë³´ ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ ë°œìƒ"); }});
    document.getElementById('randomizePricesBtn').addEventListener('click', async () => { /* ... */ if (!currentAuthUser || !currentUserData || currentUserData.role !== 'teacher') { showInfoModal("ì˜¤ë¥˜", "ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤."); return; } showInfoModal("ì§„í–‰ ì¤‘", "ì£¼ê°€ ë³€ê²½ ì¤‘..."); try { for (const stockId in stockDataCache) { const stock = stockDataCache[stockId]; if (stock.type === 'normal') { const minFluctuation = stock.minFluctuation || -50; const maxFluctuation = stock.maxFluctuation || 100; const change = Math.floor(Math.random() * (maxFluctuation - minFluctuation + 1)) + minFluctuation; let newPrice = stock.price + change; if (newPrice < 100) newPrice = 100; const newHistory = [...(stock.history || [])]; newHistory.push(newPrice); if (newHistory.length > MAX_HISTORY_LENGTH) newHistory.shift(); await updateDoc(doc(db, "stocks", stockId), { price: newPrice, history: newHistory }); }} showInfoModal('ì•Œë¦¼', 'ì¼ë°˜ ì£¼ì‹ ê°€ê²©ì´ ì„ì˜ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.'); } catch (error) { showInfoModal("ì˜¤ë¥˜", "ì£¼ê°€ ë³€ê²½ ì¤‘ ì˜¤ë¥˜ ë°œìƒ"); }});
    document.getElementById('adminUpdatePriceBtn').addEventListener('click', async () => { /* ... */ if (!currentAuthUser || !currentUserData || currentUserData.role !== 'teacher') { showInfoModal("ì˜¤ë¥˜", "ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤."); return; } const stockId = document.getElementById('adminStockSelect').value; const newPriceStr = document.getElementById('adminNewPrice').value; if (!stockId) { showInfoModal("ì˜¤ë¥˜", "ê°€ê²©ì„ ë³€ê²½í•  ì£¼ì‹ì„ ì„ íƒí•˜ì„¸ìš”."); return; } if (!newPriceStr) { showInfoModal("ì˜¤ë¥˜", "ìƒˆë¡œìš´ ê°€ê²©ì„ ì…ë ¥í•˜ì„¸ìš”."); return; } const newPrice = parseInt(newPriceStr); if (isNaN(newPrice) || newPrice < 0) { showInfoModal("ì˜¤ë¥˜", "ìœ íš¨í•œ ê°€ê²©ì„ ì…ë ¥í•˜ì„¸ìš”."); return; } try { const stock = stockDataCache[stockId]; if (!stock) { showInfoModal("ì˜¤ë¥˜", "ì„ íƒí•œ ì£¼ì‹ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); return; } const newHistory = [...(stock.history || [])]; newHistory.push(newPrice); if (newHistory.length > MAX_HISTORY_LENGTH) newHistory.shift(); await updateDoc(doc(db, "stocks", stockId), { price: newPrice, history: newHistory }); showInfoModal('ì„±ê³µ', `${stock.name}ì˜ ê°€ê²©ì´ ${formatCurrency(newPrice)}ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.`); document.getElementById('adminNewPrice').value = ''; } catch (error) { showInfoModal("ì˜¤ë¥˜", "ì£¼ê°€ ë³€ê²½ ì¤‘ ì˜¤ë¥˜ ë°œìƒ"); }});

    // --- Ranking Logic ---
    rankingTabButtons.forEach(button => { /* ... */ button.addEventListener('click', (e) => { rankingTabButtons.forEach(btn => {btn.classList.remove('active', 'border-teal-600', 'text-teal-600'); btn.classList.add('border-transparent', 'text-stone-500');}); e.target.classList.add('active', 'border-teal-600', 'text-teal-600'); e.target.classList.remove('border-transparent', 'text-stone-500'); const rankingType = e.target.dataset.rankingtype; document.querySelectorAll('.ranking-content-area').forEach(area => area.classList.add('hidden')); document.getElementById(`rankingContent${rankingType.charAt(0).toUpperCase() + rankingType.slice(1)}`).classList.remove('hidden'); loadRankingData(rankingType); });});
    async function loadRankingData(type) { /* ... */ if (!currentAuthUser) return; if (type === 'totalAsset') { totalAssetRankingListEl.innerHTML = '<li class="text-center text-stone-500 py-4">ì´ ìì‚° ë­í‚¹ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</li>'; try { const usersSnapshot = await getDocs(collection(db, "users")); const userAssets = []; usersSnapshot.forEach(docSnap => { const user = docSnap.data(); let totalStockValue = 0; if (user.portfolio) for (const stockId in user.portfolio) { const portfolioItem = user.portfolio[stockId]; const stockInfo = stockDataCache[stockId]; if (portfolioItem && stockInfo) totalStockValue += (portfolioItem.quantity || 0) * (stockInfo.price || 0); } userAssets.push({ name: user.name, totalAsset: (user.balance || 0) + totalStockValue }); }); userAssets.sort((a, b) => b.totalAsset - a.totalAsset); totalAssetRankingListEl.innerHTML = ''; userAssets.slice(0, 10).forEach((user, index) => { const li = document.createElement('li'); li.className = "flex justify-between items-center p-2 border-b"; li.innerHTML = `<span>${index + 1}. ${user.name}</span> <span class="font-semibold">${formatCurrency(user.totalAsset)}</span>`; totalAssetRankingListEl.appendChild(li); }); if (userAssets.length === 0) totalAssetRankingListEl.innerHTML = '<li class="text-center text-stone-500 py-4">ë­í‚¹ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</li>'; } catch (error) { totalAssetRankingListEl.innerHTML = '<li class="text-center text-red-500 py-4">ë­í‚¹ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</li>'; }} else if (type === 'roi') { roiRankingListEl.innerHTML = '<li class="text-center text-stone-500 py-4">ìˆ˜ìµë¥  ë­í‚¹ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</li>'; try { const usersSnapshot = await getDocs(collection(db, "users")); const userRois = []; usersSnapshot.forEach(docSnap => { const user = docSnap.data(); let totalPortfolioCurrentValue = 0; let totalPortfolioCostBasis = 0; if (user.portfolio) for (const stockId in user.portfolio) { const portfolioItem = user.portfolio[stockId]; const stockInfo = stockDataCache[stockId]; if (portfolioItem && stockInfo && portfolioItem.quantity > 0 && portfolioItem.avgBuyPrice > 0) { totalPortfolioCostBasis += portfolioItem.avgBuyPrice * portfolioItem.quantity; totalPortfolioCurrentValue += stockInfo.price * portfolioItem.quantity; }} let roi = 0; if (totalPortfolioCostBasis > 0) roi = ((totalPortfolioCurrentValue - totalPortfolioCostBasis) / totalPortfolioCostBasis) * 100; userRois.push({ name: user.name, roi: roi }); }); userRois.sort((a, b) => b.roi - a.roi); roiRankingListEl.innerHTML = ''; userRois.slice(0, 10).forEach((user, index) => { const li = document.createElement('li'); li.className = "flex justify-between items-center p-2 border-b"; li.innerHTML = `<span>${index + 1}. ${user.name}</span> <span class="font-semibold ${user.roi >= 0 ? 'text-green-600' : 'text-red-600'}">${user.roi.toFixed(2)}%</span>`; roiRankingListEl.appendChild(li); }); if (userRois.length === 0) roiRankingListEl.innerHTML = '<li class="text-center text-stone-500 py-4">ë­í‚¹ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</li>'; } catch (error) { roiRankingListEl.innerHTML = '<li class="text-center text-red-500 py-4">ìˆ˜ìµë¥  ë­í‚¹ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</li>'; }}}
    
    // --- Board Logic ---
    boardTabButtons.forEach(button => { /* ... */ button.addEventListener('click', (e) => { boardTabButtons.forEach(btn => {btn.classList.remove('active', 'border-teal-600', 'text-teal-600'); btn.classList.add('border-transparent', 'text-stone-500');}); e.target.classList.add('active', 'border-teal-600', 'text-teal-600'); e.target.classList.remove('border-transparent', 'text-stone-500'); const boardType = e.target.dataset.boardtype; document.querySelectorAll('.board-content-area').forEach(area => area.classList.add('hidden')); document.getElementById(`boardContent${boardType.charAt(0).toUpperCase() + boardType.slice(1)}`).classList.remove('hidden'); loadAndRenderBoard(boardType); });});
    newNoticePostBtn.addEventListener('click', () => showPostModal('notice'));
    newFreePostBtn.addEventListener('click', () => showPostModal('freeboard'));
    postForm.addEventListener('submit', async (e) => { /* ... */ e.preventDefault(); if (!currentAuthUser) { showInfoModal("ì˜¤ë¥˜", "ê¸€ì„ ì‘ì„±í•˜ë ¤ë©´ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤."); return; } const boardType = postBoardTypeInput.value; const postId = postEditIdInput.value; const title = postTitleInput.value.trim(); const content = postContentInput.value.trim(); if (!title || !content) { showInfoModal("ì˜¤ë¥˜", "ì œëª©ê³¼ ë‚´ìš©ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”."); return; } const postData = { title: title, content: content, authorUid: currentAuthUser.uid, authorName: currentUserData.name || currentAuthUser.email, updatedAt: serverTimestamp() }; try { if (postId) { await updateDoc(doc(db, "boards", boardType, "posts", postId), postData); showInfoModal("ì„±ê³µ", "ê¸€ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤."); } else { postData.createdAt = serverTimestamp(); await addDoc(collection(db, "boards", boardType, "posts"), postData); showInfoModal("ì„±ê³µ", "ê¸€ì´ ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤."); } closePostModal(); } catch (error) { showInfoModal("ì˜¤ë¥˜", "ê¸€ì„ ì €ì¥í•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."); }});
    async function loadAndRenderBoard(boardType) { /* ... */ const listEl = boardType === 'notice' ? noticePostListEl : freePostListEl; listEl.innerHTML = `<li class="text-center text-stone-500 py-4">${boardType === 'notice' ? 'ê³µì§€ì‚¬í•­' : 'ê²Œì‹œê¸€'}ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</li>`; const querySnapshot = await getDocs(query(collection(db, "boards", boardType, "posts"), orderBy("createdAt", "desc"))); renderPosts(boardType, querySnapshot);}
    function renderPosts(boardType, snapshot) { /* ... */ const listEl = boardType === 'notice' ? noticePostListEl : freePostListEl; listEl.innerHTML = ''; if (snapshot.empty) { listEl.innerHTML = `<li class="text-center text-stone-500 py-4">${boardType === 'notice' ? 'ê³µì§€ì‚¬í•­ì´' : 'ê²Œì‹œê¸€ì´'} ì—†ìŠµë‹ˆë‹¤.</li>`; return; } snapshot.forEach(docSnap => { const post = { id: docSnap.id, ...docSnap.data() }; const li = document.createElement('li'); li.className = "bg-white p-4 rounded-lg shadow-sm border border-stone-200"; li.innerHTML = `<div class="flex justify-between items-start"><div><h4 class="text-lg font-semibold text-teal-700">${post.title}</h4><p class="text-xs text-stone-500">ì‘ì„±ì: ${post.authorName} | ë‚ ì§œ: ${formatDate(post.createdAt)}</p></div>${ (currentUserData && (currentUserData.role === 'teacher' || post.authorUid === currentAuthUser.uid)) ? `<div class="flex space-x-2"><button data-boardtype="${boardType}" data-postid="${post.id}" class="edit-post-btn text-xs bg-yellow-500 hover:bg-yellow-600 text-white py-1 px-2 rounded">ìˆ˜ì •</button><button data-boardtype="${boardType}" data-postid="${post.id}" class="delete-post-btn text-xs bg-red-500 hover:bg-red-600 text-white py-1 px-2 rounded">ì‚­ì œ</button></div>` : '' }</div><p class="mt-2 text-stone-700 post-content">${post.content.substring(0, 100)}${post.content.length > 100 ? '...' : ''}</p>${post.content.length > 100 ? `<button data-boardtype="${boardType}" data-postid="${post.id}" class="view-full-post-btn text-xs text-blue-500 hover:underline mt-1">ë”ë³´ê¸°</button>` : ''}`; listEl.appendChild(li); }); listEl.addEventListener('click', async (e) => { const target = e.target; const boardType = target.dataset.boardtype; const postId = target.dataset.postid; if (target.classList.contains('edit-post-btn')) { const postDoc = await getDoc(doc(db, "boards", boardType, "posts", postId)); if (postDoc.exists()) showPostModal(boardType, { id: postDoc.id, ...postDoc.data() }); } else if (target.classList.contains('delete-post-btn')) { if (confirm("ì •ë§ë¡œ ì´ ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) { try { await deleteDoc(doc(db, "boards", boardType, "posts", postId)); showInfoModal("ì„±ê³µ", "ê¸€ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤."); } catch (error) { showInfoModal("ì˜¤ë¥˜", "ê¸€ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ"); }}} else if (target.classList.contains('view-full-post-btn')) { const postDoc = await getDoc(doc(db, "boards", boardType, "posts", postId)); if (postDoc.exists()) { const postData = postDoc.data(); showInfoModal(postData.title, postData.content); }}}); }

    // --- Shop Logic ---
    async function loadAndRenderShopItems() { /* ... */ if (!currentAuthUser) { shopItemListEl.innerHTML = '<p class="text-stone-500 col-span-full text-center">ìƒì  ë¬¼í’ˆì„ ë³´ë ¤ë©´ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.</p>'; return; } shopItemListEl.innerHTML = '<p class="text-stone-500 col-span-full text-center">ìƒì  ë¬¼í’ˆì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>'; try { const q = query(collection(db, "shopItems"), orderBy("createdAt", "desc")); const querySnapshot = await getDocs(q); shopItemListEl.innerHTML = ''; if (querySnapshot.empty) { shopItemListEl.innerHTML = '<p class="text-stone-500 col-span-full text-center">íŒë§¤ ì¤‘ì¸ ë¬¼í’ˆì´ ì•„ì§ ì—†ìŠµë‹ˆë‹¤.</p>'; return; } querySnapshot.forEach(docSnap => { const item = { id: docSnap.id, ...docSnap.data() }; const itemCard = document.createElement('div'); itemCard.className = 'shop-item-card bg-white p-5 rounded-xl shadow-lg flex flex-col justify-between'; let imageHtml = `<div class="w-full h-40 bg-stone-200 rounded-md flex items-center justify-center mb-3"><span class="text-stone-400 text-sm">ì´ë¯¸ì§€ ì—†ìŒ</span></div>`; if (item.imageUrl) { imageHtml = `<img src="${item.imageUrl}" alt="${item.itemName}" class="w-full h-40 object-cover rounded-md mb-3" onerror="this.parentElement.innerHTML='<div class=\\'w-full h-40 bg-stone-200 rounded-md flex items-center justify-center mb-3\\'><span class=\\'text-stone-400 text-sm\\'>ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨</span></div>';">`; } itemCard.innerHTML = `<div>${imageHtml}<h4 class="text-xl font-semibold text-purple-700 mb-1">${item.itemName}</h4><p class="text-2xl font-bold text-orange-600 mb-2">${formatCurrency(item.price)}</p><p class="text-sm text-stone-600 mb-3 h-12 overflow-hidden">${item.description || 'íŠ¹ë³„í•œ ì„¤ëª…ì´ ì—†ì–´ìš”.'}</p></div><button data-itemid="${item.id}" class="view-purchase-info-btn mt-auto w-full bg-orange-500 hover:bg-orange-600 text-white font-bold py-2 px-4 rounded-lg transition-transform hover:scale-105">êµ¬ë§¤ ì •ë³´ ë³´ê¸°</button>`; shopItemListEl.appendChild(itemCard); }); document.querySelectorAll('.view-purchase-info-btn').forEach(button => { button.addEventListener('click', async (e) => { const itemId = e.target.dataset.itemid; const itemDoc = await getDoc(doc(db, "shopItems", itemId)); if (itemDoc.exists()) { showPurchaseInfoModal({ id: itemDoc.id, ...itemDoc.data() }); } else { showInfoModal("ì˜¤ë¥˜", "ë¬¼í’ˆ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); }}); }); } catch (error) { console.error("Error loading shop items for user:", error); shopItemListEl.innerHTML = '<p class="text-red-500 col-span-full text-center">ìƒì  ë¬¼í’ˆì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>'; }}
    adminAddNewShopItemBtn.addEventListener('click', () => showShopItemFormModal());
    shopItemForm.addEventListener('submit', async (e) => { /* ... */ e.preventDefault(); if (!currentAuthUser || !currentUserData || currentUserData.role !== 'teacher') { showInfoModal("ì˜¤ë¥˜", "ë¬¼í’ˆì„ ë“±ë¡/ìˆ˜ì •í•  ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤."); return; } const itemId = shopItemEditIdInput.value; const itemName = shopItemNameInput.value.trim(); const price = parseFloat(shopItemPriceInput.value); const depositAccount = shopItemDepositAccountInput.value.trim(); const description = shopItemDescriptionInput.value.trim(); const imageUrl = shopItemImageUrlInput.value.trim(); if (!itemName || isNaN(price) || price < 0 || !depositAccount) { showInfoModal("ì˜¤ë¥˜", "ë¬¼í’ˆ ì´ë¦„, ê°€ê²©, ì…ê¸ˆ ê³„ì¢ŒëŠ” í•„ìˆ˜ í•­ëª©ì…ë‹ˆë‹¤."); return; } const itemData = { itemName, price, depositAccount, description: description || "", imageUrl: imageUrl || "", updatedAt: serverTimestamp(), sellerUid: currentAuthUser.uid, sellerName: currentUserData.name }; try { if (itemId) { const itemRef = doc(db, "shopItems", itemId); await updateDoc(itemRef, itemData); showInfoModal("ì„±ê³µ", "ìƒì  ë¬¼í’ˆì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤."); } else { itemData.createdAt = serverTimestamp(); await addDoc(collection(db, "shopItems"), itemData); showInfoModal("ì„±ê³µ", "ìƒˆ ìƒì  ë¬¼í’ˆì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤."); } closeShopItemFormModal(); loadAdminShopItems(); } catch (error) { console.error("Error saving shop item:", error); showInfoModal("ì˜¤ë¥˜", "ìƒì  ë¬¼í’ˆ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."); }});
    async function loadAdminShopItems() { /* ... */ if (!currentAuthUser || !currentUserData || currentUserData.role !== 'teacher') { adminShopItemListEl.innerHTML = '<p class="text-stone-500">ìƒì  ë¬¼í’ˆ ê´€ë¦¬ëŠ” ê´€ë¦¬ìë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>'; return; } adminShopItemListEl.innerHTML = '<p class="text-stone-500">ìƒì  ë¬¼í’ˆ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>'; try { const q = query(collection(db, "shopItems"), orderBy("createdAt", "desc")); const querySnapshot = await getDocs(q); adminShopItemListEl.innerHTML = ''; if (querySnapshot.empty) { adminShopItemListEl.innerHTML = '<p class="text-stone-500">ë“±ë¡ëœ ìƒì  ë¬¼í’ˆì´ ì—†ìŠµë‹ˆë‹¤.</p>'; return; } querySnapshot.forEach(docSnap => { const item = { id: docSnap.id, ...docSnap.data() }; const itemDiv = document.createElement('div'); itemDiv.className = "bg-stone-50 p-3 rounded-md border border-stone-200 flex justify-between items-center"; itemDiv.innerHTML = `<div><p class="font-medium text-purple-600">${item.itemName} - ${formatCurrency(item.price)}</p><p class="text-xs text-stone-500">ê³„ì¢Œ: ${item.depositAccount}</p><p class="text-xs text-stone-400">ë“±ë¡ì: ${item.sellerName || item.sellerUid.substring(0,8)}</p></div><div class="space-x-2"><button data-itemid="${item.id}" class="admin-edit-shop-item-btn bg-yellow-500 hover:bg-yellow-600 text-white text-xs py-1 px-2 rounded">ìˆ˜ì •</button><button data-itemid="${item.id}" class="admin-delete-shop-item-btn bg-red-500 hover:bg-red-600 text-white text-xs py-1 px-2 rounded">ì‚­ì œ</button></div>`; adminShopItemListEl.appendChild(itemDiv); }); document.querySelectorAll('.admin-edit-shop-item-btn').forEach(button => { button.addEventListener('click', async (e) => { const itemId = e.target.dataset.itemid; const itemDoc = await getDoc(doc(db, "shopItems", itemId)); if (itemDoc.exists()) { showShopItemFormModal({ id: itemDoc.id, ...itemDoc.data() }); }}); }); document.querySelectorAll('.admin-delete-shop-item-btn').forEach(button => { button.addEventListener('click', async (e) => { const itemId = e.target.dataset.itemid; if (confirm("ì •ë§ë¡œ ì´ ë¬¼í’ˆì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")) { try { await deleteDoc(doc(db, "shopItems", itemId)); showInfoModal("ì„±ê³µ", "ìƒì  ë¬¼í’ˆì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤."); loadAdminShopItems(); } catch (error) { console.error("Error deleting shop item:", error); showInfoModal("ì˜¤ë¥˜", "ë¬¼í’ˆ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ."); }}}); }); } catch (error) { console.error("Error loading shop items for admin:", error); adminShopItemListEl.innerHTML = '<p class="text-red-500">ìƒì  ë¬¼í’ˆ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨.</p>'; }}

    // --- Auction Logic ---
    auctionTabButtons.forEach(button => {
        button.addEventListener('click', (e) => {
            auctionTabButtons.forEach(btn => { btn.classList.remove('active', 'border-teal-600', 'text-teal-600'); btn.classList.add('border-transparent', 'text-stone-500'); });
            e.target.classList.add('active', 'border-teal-600', 'text-teal-600'); e.target.classList.remove('border-transparent', 'text-stone-500');
            const auctionType = e.target.dataset.auctiontype;
            document.querySelectorAll('.auction-content-area').forEach(area => area.classList.add('hidden'));
            document.getElementById(`auctionContent${auctionType.charAt(0).toUpperCase() + auctionType.slice(1)}`).classList.remove('hidden');
            loadAndRenderAuctionItems(auctionType);
        });
    });

    function getCountdownText(deadline, status) {
        if (status !== 'active') {
            switch(status) {
                case 'ended_sold': return '<span class="text-green-600 font-semibold">ë‚™ì°°ë¨</span>';
                case 'ended_unsold': return '<span class="text-red-600 font-semibold">ìœ ì°°ë¨</span>';
                case 'cancelled': return '<span class="text-stone-600 font-semibold">ì·¨ì†Œë¨</span>';
                default: return '<span class="text-stone-500 font-semibold">ì¢…ë£Œë¨</span>';
            }
        }
        const now = new Date().getTime();
        const deadlineTime = deadline.toDate().getTime();
        const distance = deadlineTime - now;

        if (distance < 0) return '<span class="countdown-ended">ê²½ë§¤ ì¢…ë£Œ</span>';
        
        const days = Math.floor(distance / (1000 * 60 * 60 * 24));
        const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((distance % (1000 * 60)) / 1000);

        let text = "";
        if (days > 0) text += `${days}ì¼ `;
        if (hours > 0 || days > 0) text += `${hours}ì‹œê°„ `;
        if (minutes > 0 || hours > 0 || days > 0) text += `${minutes}ë¶„ `;
        text += `${seconds}ì´ˆ ë‚¨ìŒ`;
        
        let colorClass = 'countdown-timer';
        if (distance < 60 * 60 * 1000) colorClass = 'countdown-soon'; // Less than 1 hour
        return `<span class="${colorClass}">${text}</span>`;
    }

    async function loadAndRenderAuctionItems(type = 'active') {
        if (!currentAuthUser) {
            const targetEl = type === 'active' ? auctionContentActiveEl : auctionContentPastEl;
            targetEl.innerHTML = '<p class="text-stone-500 col-span-full text-center">ê²½ë§¤ ë¬¼í’ˆì„ ë³´ë ¤ë©´ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.</p>';
            return;
        }
        const targetEl = type === 'active' ? auctionContentActiveEl : auctionContentPastEl;
        targetEl.innerHTML = `<p class="text-stone-500 col-span-full text-center">${type === 'active' ? 'ì§„í–‰ì¤‘ì¸' : 'ì§€ë‚œ'} ê²½ë§¤ ë¬¼í’ˆì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>`;
        
        try {
            const q = query(collection(db, "auctions"), orderBy("deadline", "asc"));
            const querySnapshot = await getDocs(q);
            targetEl.innerHTML = '';

            const items = [];
            querySnapshot.forEach(docSnap => {
                const item = { id: docSnap.id, ...docSnap.data() };
                if ((type === 'active' && item.status === 'active') || (type !== 'active' && item.status !== 'active')) {
                    items.push(item);
                }
            });

            if (items.length === 0) {
                targetEl.innerHTML = `<p class="text-stone-500 col-span-full text-center">${type === 'active' ? 'ì§„í–‰ì¤‘ì¸' : 'ì§€ë‚œ'} ê²½ë§¤ ë¬¼í’ˆì´ ì—†ìŠµë‹ˆë‹¤.</p>`;
                return;
            }

            if (type !== 'active') {
                items.sort((a, b) => b.deadline.toDate() - a.deadline.toDate());
            }

            items.forEach(item => {
                const itemCard = document.createElement('div');
                itemCard.className = 'auction-item-card bg-white p-5 rounded-xl shadow-lg flex flex-col justify-between';
                
                let imageHtml = `<div class="w-full h-48 bg-stone-200 rounded-md flex items-center justify-center mb-3"><span class="text-stone-400 text-sm">ì´ë¯¸ì§€ ì—†ìŒ</span></div>`;
                if (item.imageUrl) {
                    imageHtml = `<img src="${item.imageUrl}" alt="${item.itemName}" class="w-full h-48 object-cover rounded-md mb-3" onerror="this.parentElement.innerHTML='<div class=\\'w-full h-48 bg-stone-200 rounded-md flex items-center justify-center mb-3\\'><span class=\\'text-stone-400 text-sm\\'>ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨</span></div>';">`;
                }

                const countdownId = `countdown-${item.id}`;
                if (auctionCountdownIntervals[item.id]) clearInterval(auctionCountdownIntervals[item.id]);

                itemCard.innerHTML = `
                    <div>
                        ${imageHtml}
                        <h4 class="text-xl font-semibold text-indigo-700 mb-1">${item.itemName}</h4>
                        <p class="text-sm text-stone-500 mb-1">ì‹œì‘ê°€: ${formatCurrency(item.startPrice)}</p>
                        <p class="text-lg font-bold text-green-600 mb-1">í˜„ì¬ê°€: ${formatCurrency(item.currentBid)}</p>
                        <p class="text-sm text-stone-500 mb-2">ìµœê³  ì…ì°°ì: <span class="font-medium">${item.highestBidderName || 'ì—†ìŒ'}</span></p>
                        <p class="text-sm text-stone-500 mb-3">ë§ˆê°ê¹Œì§€: <span id="${countdownId}">${getCountdownText(item.deadline, item.status)}</span></p>
                        <p class="text-xs text-stone-600 mb-3 h-10 overflow-hidden">${item.description || 'ë¬¼í’ˆ ì„¤ëª…ì´ ì—†ìŠµë‹ˆë‹¤.'}</p>
                    </div>
                    <div class="mt-auto space-y-2">
                        ${item.status === 'active' ? `
                            <button data-auctionid="${item.id}" data-itemname="${item.itemName}" data-currentbid="${item.currentBid}" class="place-bid-btn w-full bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg">ì…ì°°í•˜ê¸°</button>
                            ${item.highestBidderUid === currentAuthUser.uid ? `<button data-auctionid="${item.id}" class="cancel-bid-btn w-full bg-yellow-500 hover:bg-yellow-600 text-white font-semibold py-2 px-3 rounded-lg text-sm">ë‚´ ì…ì°° ì·¨ì†Œ</button>` : ''}
                        ` : `<p class="text-center font-semibold ${item.status === 'ended_sold' ? 'text-green-700' : item.status === 'cancelled' ? 'text-stone-700' : 'text-red-700'}">${item.status === 'ended_sold' ? `ë‚™ì°°ì: ${item.highestBidderName || 'ì •ë³´ ì—†ìŒ'}` : item.status === 'cancelled' ? 'ì·¨ì†Œë¨' : 'ìœ ì°°ë¨'}</p>`}
                    </div>
                `;
                targetEl.appendChild(itemCard);

                if (item.status === 'active') {
                    const countdownEl = document.getElementById(countdownId);
                    auctionCountdownIntervals[item.id] = setInterval(() => {
                        const text = getCountdownText(item.deadline, item.status);
                        countdownEl.innerHTML = text;
                        if (text.includes("ê²½ë§¤ ì¢…ë£Œ")) {
                            clearInterval(auctionCountdownIntervals[item.id]);
                            checkAndProcessEndedAuctions(); // Re-check and process if this one just ended
                        }
                    }, 1000);
                }
            });

            document.querySelectorAll('.place-bid-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const auctionId = e.target.dataset.auctionid;
                    const itemName = e.target.dataset.itemname;
                    const currentBid = parseFloat(e.target.dataset.currentbid);
                    showPlaceBidModal(auctionId, itemName, currentBid);
                });
            });
            document.querySelectorAll('.cancel-bid-btn').forEach(button => {
                button.addEventListener('click', (e) => handleCancelBid(e.target.dataset.auctionid));
            });

        } catch (error) {
            console.error(`Error loading ${type} auction items:`, error);
            targetEl.innerHTML = `<p class="text-red-500 col-span-full text-center">${type === 'active' ? 'ì§„í–‰ì¤‘ì¸' : 'ì§€ë‚œ'} ê²½ë§¤ ë¬¼í’ˆì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>`;
        }
    }
    
    adminAddNewAuctionItemBtn.addEventListener('click', () => showAuctionItemFormModal());

    auctionItemForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        if (!currentAuthUser || !currentUserData || currentUserData.role !== 'teacher') {
            showInfoModal("ì˜¤ë¥˜", "ê²½ë§¤ ë¬¼í’ˆì„ ë“±ë¡/ìˆ˜ì •í•  ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤."); return;
        }
        const itemId = auctionItemEditIdInput.value;
        const itemName = auctionItemNameInput.value.trim();
        const startPrice = parseFloat(auctionItemStartPriceInput.value);
        const deadlineStr = auctionItemDeadlineInput.value;
        const description = auctionItemDescriptionInput.value.trim();
        const imageUrl = auctionItemImageUrlInput.value.trim();

        if (!itemName || isNaN(startPrice) || startPrice < 0 || !deadlineStr) {
            showInfoModal("ì˜¤ë¥˜", "ë¬¼í’ˆ ì´ë¦„, ì‹œì‘ê°€, ë§ˆê° ê¸°í•œì€ í•„ìˆ˜ í•­ëª©ì…ë‹ˆë‹¤."); return;
        }
        const deadline = Timestamp.fromDate(new Date(deadlineStr));
        if (deadline.toDate() <= new Date()) {
            showInfoModal("ì˜¤ë¥˜", "ë§ˆê° ê¸°í•œì€ í˜„ì¬ ì‹œê°„ ì´í›„ì—¬ì•¼ í•©ë‹ˆë‹¤."); return;
        }

        const itemData = {
            itemName, startPrice, currentBid: startPrice, deadline, description: description || "", imageUrl: imageUrl || "",
            status: 'active', highestBidderUid: null, highestBidderName: null, bids: {}, // bids is a map
            updatedAt: serverTimestamp(), sellerUid: currentAuthUser.uid, sellerName: currentUserData.name
        };
        try {
            if (itemId) {
                const itemRef = doc(db, "auctions", itemId);
                // When editing, we generally don't reset currentBid or bidders if auction is live.
                // For simplicity here, editing an active auction might be restricted or only allow description/image changes.
                // This example will update all fields, potentially resetting bids if startPrice changes.
                // A more robust edit would check item.status and only allow certain fields to change.
                await updateDoc(itemRef, { itemName, startPrice, deadline, description, imageUrl, updatedAt: serverTimestamp() }); // Not resetting bids/status on edit
                showInfoModal("ì„±ê³µ", "ê²½ë§¤ ë¬¼í’ˆì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
            } else {
                itemData.createdAt = serverTimestamp();
                await addDoc(collection(db, "auctions"), itemData);
                showInfoModal("ì„±ê³µ", "ìƒˆ ê²½ë§¤ ë¬¼í’ˆì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
            }
            closeAuctionItemFormModal();
            loadAdminAuctionItems();
        } catch (error) { console.error("Error saving auction item:", error); showInfoModal("ì˜¤ë¥˜", "ê²½ë§¤ ë¬¼í’ˆ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."); }
    });

    async function loadAdminAuctionItems() {
        if (!currentAuthUser || !currentUserData || currentUserData.role !== 'teacher') {
            adminAuctionItemListEl.innerHTML = '<p class="text-stone-500">ê²½ë§¤ ë¬¼í’ˆ ê´€ë¦¬ëŠ” ê´€ë¦¬ìë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>'; return;
        }
        adminAuctionItemListEl.innerHTML = '<p class="text-stone-500">ê²½ë§¤ ë¬¼í’ˆ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>';
        try {
            const q = query(collection(db, "auctions"), orderBy("createdAt", "desc"));
            const querySnapshot = await getDocs(q);
            adminAuctionItemListEl.innerHTML = '';
            if (querySnapshot.empty) { adminAuctionItemListEl.innerHTML = '<p class="text-stone-500">ë“±ë¡ëœ ê²½ë§¤ ë¬¼í’ˆì´ ì—†ìŠµë‹ˆë‹¤.</p>'; return; }
            
            querySnapshot.forEach(docSnap => {
                const item = { id: docSnap.id, ...docSnap.data() };
                const itemDiv = document.createElement('div');
                itemDiv.className = "bg-stone-50 p-3 rounded-md border border-stone-200 flex justify-between items-center";
                itemDiv.innerHTML = `
                    <div>
                        <p class="font-medium text-indigo-600">${item.itemName} (í˜„ì¬ê°€: ${formatCurrency(item.currentBid)})</p>
                        <p class="text-xs text-stone-500">íŒë§¤ì: ${item.sellerName || "ì•Œ ìˆ˜ ì—†ìŒ"} | ë§ˆê°: ${formatDate(item.deadline)} - ìƒíƒœ: ${item.status}</p>
                    </div>
                    <div class="space-x-2">
                        <button data-itemid="${item.id}" class="admin-edit-auction-item-btn bg-yellow-500 hover:bg-yellow-600 text-white text-xs py-1 px-2 rounded ${item.status !== 'active' ? 'opacity-50 cursor-not-allowed' : ''}" ${item.status !== 'active' ? 'disabled' : ''}>ìˆ˜ì •</button>
                        <button data-itemid="${item.id}" class="admin-cancel-auction-item-btn bg-stone-500 hover:bg-stone-600 text-white text-xs py-1 px-2 rounded ${item.status !== 'active' ? 'opacity-50 cursor-not-allowed' : ''}" ${item.status !== 'active' ? 'disabled' : ''}>ì·¨ì†Œ</button>
                        <button data-itemid="${item.id}" class="admin-delete-auction-item-btn bg-red-500 hover:bg-red-600 text-white text-xs py-1 px-2 rounded">ì‚­ì œ</button>
                    </div>
                `;
                adminAuctionItemListEl.appendChild(itemDiv);
            });

            document.querySelectorAll('.admin-edit-auction-item-btn').forEach(button => {
                button.addEventListener('click', async (e) => {
                    const itemId = e.target.dataset.itemid;
                    const itemDoc = await getDoc(doc(db, "auctions", itemId));
                    if (itemDoc.exists()) showAuctionItemFormModal({ id: itemDoc.id, ...itemDoc.data() });
                });
            });
            document.querySelectorAll('.admin-cancel-auction-item-btn').forEach(button => {
                button.addEventListener('click', async (e) => {
                    const itemId = e.target.dataset.itemid;
                    if (!confirm('ì •ë§ë¡œ ì´ ê²½ë§¤ë¥¼ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ëª¨ë“  ì…ì°°ê¸ˆì´ í™˜ë¶ˆë©ë‹ˆë‹¤.')) return;

                    try {
                        const itemRef = doc(db, 'auctions', itemId);
                        const itemSnap = await getDoc(itemRef);
                        if (!itemSnap.exists()) { showInfoModal('ì˜¤ë¥˜', 'ê²½ë§¤ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); return; }
                        const auction = itemSnap.data();
                        if (auction.status !== 'active') { showInfoModal('ì˜¤ë¥˜', 'ì´ë¯¸ ì¢…ë£Œë˜ì—ˆê±°ë‚˜ ì·¨ì†Œëœ ê²½ë§¤ì…ë‹ˆë‹¤.'); return; }

                        const batch = writeBatch(db);
                        const bids = auction.bids || {};
                        for (const bidderUid in bids) {
                            const bidData = bids[bidderUid];
                            const userRef = doc(db, 'users', bidderUid);
                            batch.update(userRef, { balance: increment(bidData.bidAmount) });
                            batch.set(doc(collection(userRef, 'transactions')), {
                                type: 'auction_cancel_refund',
                                description: `${auction.itemName} ê²½ë§¤ ì·¨ì†Œ í™˜ë¶ˆ`,
                                amount: bidData.bidAmount,
                                auctionId: itemId,
                                itemName: auction.itemName,
                                date: serverTimestamp()
                            });
                        }
                        batch.update(itemRef, { status: 'cancelled', updatedAt: serverTimestamp() });
                        await batch.commit();
                        showInfoModal('ì„±ê³µ', 'ê²½ë§¤ê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.');
                        loadAdminAuctionItems();
                    } catch (error) {
                        console.error('Error cancelling auction:', error);
                        showInfoModal('ì˜¤ë¥˜', 'ê²½ë§¤ ì·¨ì†Œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                    }
                });
            });

            document.querySelectorAll('.admin-delete-auction-item-btn').forEach(button => {
                button.addEventListener('click', async (e) => {
                    const itemId = e.target.dataset.itemid;
                    const itemDoc = await getDoc(doc(db, "auctions", itemId));
                    if (itemDoc.exists() && itemDoc.data().status === 'active' && Object.keys(itemDoc.data().bids || {}).length > 0) {
                         if (!confirm("ì´ ê²½ë§¤ëŠ” í˜„ì¬ ì…ì°°ì´ ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤. ì •ë§ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ëª¨ë“  ì…ì°°ê¸ˆì€ í™˜ë¶ˆë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.")) return;
                    } else if (!confirm("ì •ë§ë¡œ ì´ ê²½ë§¤ ë¬¼í’ˆì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")) return;
                    
                    try { await deleteDoc(doc(db, "auctions", itemId)); showInfoModal("ì„±ê³µ", "ê²½ë§¤ ë¬¼í’ˆì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤."); loadAdminAuctionItems(); } 
                    catch (error) { console.error("Error deleting auction item:", error); showInfoModal("ì˜¤ë¥˜", "ê²½ë§¤ ë¬¼í’ˆ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ."); }
                });
            });
        } catch (error) { console.error("Error loading admin auction items:", error); adminAuctionItemListEl.innerHTML = '<p class="text-red-500">ê²½ë§¤ ë¬¼í’ˆ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨.</p>'; }
    }

    placeBidForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        if (!currentAuthUser || !currentUserData) { showInfoModal("ì˜¤ë¥˜", "ì…ì°°í•˜ë ¤ë©´ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤."); return; }
        
        const auctionId = bidAuctionIdInput.value;
        const newBidAmount = parseInt(bidAmountInput.value);

        if (isNaN(newBidAmount) || newBidAmount <= 0) { showInfoModal("ì˜¤ë¥˜", "ìœ íš¨í•œ ì…ì°° ê¸ˆì•¡ì„ ì…ë ¥í•˜ì„¸ìš”."); return; }

        const auctionRef = doc(db, "auctions", auctionId);
        const userRef = doc(db, "users", currentAuthUser.uid);

        try {
            await runTransaction(db, async (transaction) => {
                const auctionSnap = await transaction.get(auctionRef);
                const userSnap = await transaction.get(userRef);

                if (!auctionSnap.exists()) throw new Error("ê²½ë§¤ ë¬¼í’ˆì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                if (!userSnap.exists()) throw new Error("ì‚¬ìš©ì ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");

                const auction = auctionSnap.data();
                const user = userSnap.data();

                if (auction.status !== 'active') throw new Error("ì´ë¯¸ ì¢…ë£Œëœ ê²½ë§¤ì…ë‹ˆë‹¤.");
                if (auction.deadline.toDate() <= new Date()) throw new Error("ê²½ë§¤ ì‹œê°„ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
                if (newBidAmount <= auction.currentBid) throw new Error(`ì…ì°° ê¸ˆì•¡ì€ í˜„ì¬ ìµœê³ ê°€(${formatCurrency(auction.currentBid)})ë³´ë‹¤ ë†’ì•„ì•¼ í•©ë‹ˆë‹¤.`);
                
                const userPreviousBidOnThisAuction = auction.bids?.[currentAuthUser.uid]?.bidAmount || 0;
                const amountToDeduct = newBidAmount - userPreviousBidOnThisAuction;

                if (user.balance < amountToDeduct) throw new Error(`ì”ì•¡ì´ ë¶€ì¡±í•©ë‹ˆë‹¤. (í•„ìš” ê¸ˆì•¡: ${formatCurrency(amountToDeduct)})`);

                // Update user balance
                transaction.update(userRef, { balance: increment(-amountToDeduct) });

                // Update auction item
                const newBidsMap = { ...auction.bids };
                newBidsMap[currentAuthUser.uid] = { 
                    bidAmount: newBidAmount, 
                    bidderName: currentUserData.name, 
                    timestamp: serverTimestamp() 
                };
                transaction.update(auctionRef, {
                    currentBid: newBidAmount,
                    highestBidderUid: currentAuthUser.uid,
                    highestBidderName: currentUserData.name,
                    bids: newBidsMap,
                    updatedAt: serverTimestamp()
                });
                
                // Log transaction for the user
                transaction.set(doc(collection(userRef, "transactions")), {
                    type: 'auction_bid',
                    description: `${auction.itemName}ì— ${formatCurrency(newBidAmount)} ì…ì°° (ì°¨ê°ì•¡: ${formatCurrency(amountToDeduct)})`,
                    amount: amountToDeduct, // Log the actual deducted amount
                    auctionId: auctionId,
                    itemName: auction.itemName,
                    date: serverTimestamp()
                });
            });
            showInfoModal("ì…ì°° ì„±ê³µ", `${formatCurrency(newBidAmount)}ìœ¼ë¡œ ì…ì°°í–ˆìŠµë‹ˆë‹¤.`);
            closePlaceBidModal();
        } catch (error) {
            console.error("Error placing bid:", error);
            showInfoModal("ì…ì°° ì‹¤íŒ¨", `ì…ì°° ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${error.message}`);
        }
    });

    async function handleCancelBid(auctionId) {
        if (!currentAuthUser || !currentUserData) { showInfoModal("ì˜¤ë¥˜", "ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤."); return; }
        if (!confirm("ì •ë§ë¡œ í˜„ì¬ ìµœê³  ì…ì°°ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

        const auctionRef = doc(db, "auctions", auctionId);
        const userRef = doc(db, "users", currentAuthUser.uid);

        try {
            await runTransaction(db, async (transaction) => {
                const auctionSnap = await transaction.get(auctionRef);
                const userSnap = await transaction.get(userRef);

                if (!auctionSnap.exists()) throw new Error("ê²½ë§¤ ë¬¼í’ˆì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                if (!userSnap.exists()) throw new Error("ì‚¬ìš©ì ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");

                const auction = auctionSnap.data();
                const user = userSnap.data();

                if (auction.status !== 'active') throw new Error("ì¢…ë£Œëœ ê²½ë§¤ì˜ ì…ì°°ì€ ì·¨ì†Œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                if (auction.highestBidderUid !== currentAuthUser.uid) throw new Error("ìµœê³  ì…ì°°ìë§Œ ì…ì°°ì„ ì·¨ì†Œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
                
                const bidToCancelAmount = auction.currentBid; // This is the amount to refund

                // Refund user
                transaction.update(userRef, { balance: increment(bidToCancelAmount) });

                // Update auction: remove this user's bid and find new highest bidder
                const updatedBidsMap = { ...auction.bids };
                delete updatedBidsMap[currentAuthUser.uid];

                let newHighestBid = auction.startPrice;
                let newHighestBidderUid = null;
                let newHighestBidderName = null;

                if (Object.keys(updatedBidsMap).length > 0) {
                    let tempHighest = 0;
                    for (const bidderUid in updatedBidsMap) {
                        if (updatedBidsMap[bidderUid].bidAmount > tempHighest) {
                            tempHighest = updatedBidsMap[bidderUid].bidAmount;
                            newHighestBidderUid = bidderUid;
                            newHighestBidderName = updatedBidsMap[bidderUid].bidderName;
                        }
                    }
                    newHighestBid = tempHighest;
                }
                
                transaction.update(auctionRef, {
                    currentBid: newHighestBid,
                    highestBidderUid: newHighestBidderUid,
                    highestBidderName: newHighestBidderName,
                    bids: updatedBidsMap,
                    updatedAt: serverTimestamp()
                });

                // Log transaction for user
                transaction.set(doc(collection(userRef, "transactions")), {
                    type: 'auction_bid_cancel',
                    description: `${auction.itemName} ì…ì°° ì·¨ì†Œ (í™˜ê¸‰: ${formatCurrency(bidToCancelAmount)})`,
                    amount: bidToCancelAmount,
                    auctionId: auctionId,
                    itemName: auction.itemName,
                    date: serverTimestamp()
                });
            });
            showInfoModal("ì…ì°° ì·¨ì†Œ ì„±ê³µ", `ì…ì°°ì´ ì·¨ì†Œë˜ì—ˆê³  ${formatCurrency(auction.currentBid)}ì´ í™˜ê¸‰ë˜ì—ˆìŠµë‹ˆë‹¤.`);
        } catch (error) {
            console.error("Error cancelling bid:", error);
            showInfoModal("ì…ì°° ì·¨ì†Œ ì‹¤íŒ¨", `ì·¨ì†Œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${error.message}`);
        }
    }
    
    async function checkAndProcessEndedAuctions() {
        console.log("Checking for ended auctions...");
        const now = Timestamp.now();
        const q = query(collection(db, "auctions"), where("status", "==", "active"), where("deadline", "<=", now));
        const snapshot = await getDocs(q);

        if (snapshot.empty) {
            console.log("No active auctions have ended right now.");
            return;
        }
        
        const batch = writeBatch(db); // Use a batch for multiple updates/refunds

        for (const docSnap of snapshot.docs) {
            const auctionId = docSnap.id;
            const auction = docSnap.data();
            const auctionRef = doc(db, "auctions", auctionId);
            console.log(`Processing ended auction: ${auction.itemName} (ID: ${auctionId})`);

            if (auction.highestBidderUid) { // There's a winner
                batch.update(auctionRef, { status: "ended_sold", updatedAt: serverTimestamp() });
                console.log(`Auction ${auctionId} sold to ${auction.highestBidderName}`);
                // Refund other bidders
                for (const bidderUid in auction.bids) {
                    if (bidderUid !== auction.highestBidderUid) {
                        const losingBid = auction.bids[bidderUid];
                        const userToRefundRef = doc(db, "users", bidderUid);
                        batch.update(userToRefundRef, { balance: increment(losingBid.bidAmount) });
                        
                        const transactionRef = doc(collection(db, "users", bidderUid, "transactions"));
                        batch.set(transactionRef, {
                            type: 'auction_refund_lost',
                            description: `${auction.itemName} ê²½ë§¤ ë‚™ì°° ì‹¤íŒ¨ í™˜ë¶ˆ`,
                            amount: losingBid.bidAmount,
                            auctionId: auctionId,
                            itemName: auction.itemName,
                            date: serverTimestamp()
                        });
                        console.log(`Refunding ${formatCurrency(losingBid.bidAmount)} to user ${bidderUid} for auction ${auctionId}`);
                    }
                }
            } else { // No winner
                batch.update(auctionRef, { status: "ended_unsold", updatedAt: serverTimestamp() });
                console.log(`Auction ${auctionId} ended unsold.`);
                // If there were any bids that were somehow not cleared (e.g. all cancelled, but map not empty)
                // This part is a safeguard; ideally, if no highestBidderUid, bids map should be empty or auction.currentBid = startPrice
                for (const bidderUid in auction.bids) {
                    const bidData = auction.bids[bidderUid];
                    const userToRefundRef = doc(db, "users", bidderUid);
                    batch.update(userToRefundRef, { balance: increment(bidData.bidAmount) });
                    
                    const transactionRef = doc(collection(db, "users", bidderUid, "transactions"));
                    batch.set(transactionRef, {
                        type: 'auction_refund_lost', // Or a specific 'auction_no_winner_refund'
                        description: `${auction.itemName} ê²½ë§¤ ìœ ì°°ë¡œ ì¸í•œ ì…ì°°ê¸ˆ í™˜ë¶ˆ`,
                        amount: bidData.bidAmount,
                        auctionId: auctionId,
                        itemName: auction.itemName,
                        date: serverTimestamp()
                    });
                    console.log(`Refunding ${formatCurrency(bidData.bidAmount)} to user ${bidderUid} for unsold auction ${auctionId}`);
                }
            }
        }
        try {
            await batch.commit();
            console.log("Successfully processed ended auctions and refunds.");
            // No need to manually call loadAndRenderAuctionItems here, onSnapshot will trigger it.
        } catch (error) {
            console.error("Error processing ended auctions with batch:", error);
            showInfoModal("ê²½ë§¤ ì¢…ë£Œ ì²˜ë¦¬ ì˜¤ë¥˜", "ì¼ë¶€ ê²½ë§¤ ì¢…ë£Œ ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
        }
    }


    // --- Mobile Sidebar Toggle ---
    const sidebar = document.getElementById('sidebar'); /* ... */
    const sidebarToggle = document.getElementById('sidebarToggle');
    const mainContentForSidebar = document.getElementById('mainContent');
    sidebarToggle.addEventListener('click', () => sidebar.classList.toggle('open'));
    mainContentForSidebar.addEventListener('click', () => { if (sidebar.classList.contains('open')) sidebar.classList.remove('open'); });

    // --- Initial Load ---
    function startManseungApp() { 
        showSection('login', true); 
        // Initial check for ended auctions when app loads (after auth)
        onAuthStateChanged(auth, (user) => {
            if (user) {
                setTimeout(checkAndProcessEndedAuctions, 3000); // Delay slightly to ensure other data might be ready
            }
        });
    }

    startManseungApp(); 

</script>
</body>
</html>
