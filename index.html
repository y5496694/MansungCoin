<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>만승 경제 교실</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Visualization & Content Choices:
        - Wallet: KRW Balance (Stat), Asset Summary (Stat), Asset Allocation (Chart.js Donut). Data from Firestore.
        - Transfers: Form. Transactions logged to Firestore.
        - Stock Market: Tabs per stock. Price/Change/Volume (Stats from Firestore), User's AvgBuyPrice & ROI, Price History (Chart.js Line with time filters), Buy/Sell Forms (updates Firestore). AI Stock Analysis (Gemini API).
        - SHOP: Users can view items listed by admin. Purchase involves manual bank transfer based on displayed info. Admin can manage shop items.
        - AUCTION: Users can bid on items. Admin can create and manage auctions. Bids deduct balance, refunds on outbid/loss/cancellation. Deadline based.
        - Good Deeds: Submission Form (once per day check), Status List (data from Firestore). AI Deed Story Expansion (Gemini API).
        - Transactions: Table/List with filters (data from Firestore).
        - Settings: User name change, Password change (requires re-authentication).
        - Board: Notice (Admin write, User read), Freeboard (User write/read/edit-own/delete-own). Posts stored in Firestore.
        - Admin: Student list with edit name/reset password/view details/reset stock buttons, stock fluctuation settings, stock price manual update, SHOP ITEM MANAGEMENT, AUCTION MANAGEMENT.
        - Ranking: ROI and Total Asset ranking implemented.
        - All interactions via vanilla JS. Data stored in Firestore. NO SVG/Mermaid. -->
    <style>
        body { font-family: 'Inter', sans-serif; }
        .font-display { font-family: 'GmarketSansMedium', sans-serif; /* 예시 폰트, 실제 사용 시 웹폰트 로드 필요 */ }
        @media (max-width: 768px) {
            .sidebar { transform: translateX(-100%); transition: transform 0.3s ease-in-out; }
            .sidebar.open { transform: translateX(0); }
            .main-content { margin-left: 0; }
            .sidebar-toggle { display: block; }
        }
        @media (min-width: 769px) {
            .sidebar { transform: translateX(0); }
            .main-content { margin-left: 16rem; /* 사이드바 너비만큼 */ }
            .sidebar-toggle { display: none; }
        }
        .chart-container { position: relative; width: 100%; max-width: 600px; margin-left: auto; margin-right: auto; height: 300px; max-height: 400px; }
        @media (min-width: 768px) { .chart-container { height: 350px; } }
        .tab-button.active, .board-tab-button.active, .ranking-tab-button.active, .auction-tab-button.active {
            border-bottom-color: #0d9488; /* teal-600 */
            color: #0d9488;
            font-weight: 600;
        }
        .time-filter-btn.active { background-color: #0d9488; color: white; }
        .modal, .ai-modal, .admin-modal, .post-modal, .shop-modal, .auction-modal { /* Added .auction-modal */
            display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); 
        }
        .modal-content, .ai-modal-content, .admin-modal-content, .post-modal-content, .shop-modal-content, .auction-modal-content { /* Added .auction-modal-content */
            background-color: #fefefe; margin: 10% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 600px; border-radius: 0.5rem; position: relative;
        }
        .post-modal-content { max-width: 700px; } 
        .close-button { color: #aaa; position: absolute; top: 10px; right: 15px; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close-button:hover, .close-button:focus { color: black; text-decoration: none; }
        .loading-spinner { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 10px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .post-content { white-space: pre-wrap; } 
        .shop-item-card, .auction-item-card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .shop-item-card:hover, .auction-item-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .countdown-timer { font-weight: bold; }
        .countdown-ended { color: #dc2626; /* red-600 */ } /* For ended timers */
        .countdown-soon { color: #f59e0b; /* amber-500 */ } /* For timers ending soon */
    </style>
</head>
<body class="bg-stone-100 text-stone-800">
    <div class="flex h-screen">
        <button id="sidebarToggle" class="sidebar-toggle fixed top-4 left-4 z-30 p-2 bg-teal-600 text-white rounded-md md:hidden">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
            </svg>
        </button>

        <aside id="sidebar" class="sidebar fixed inset-y-0 left-0 z-20 w-64 bg-teal-700 text-white p-6 space-y-2 shadow-lg md:translate-x-0 overflow-y-auto">
            <h1 class="text-3xl font-bold font-display">만승 경제 교실</h1>
            <nav class="space-y-1">
                <a href="#" data-section="dashboard" class="nav-link active-nav-link flex items-center space-x-2 px-3 py-2 rounded-md hover:bg-teal-600 transition-colors"><span>🏠</span><span>내 지갑</span></a>
                <a href="#" data-section="transfer" class="nav-link flex items-center space-x-2 px-3 py-2 rounded-md hover:bg-teal-600 transition-colors"><span>💸</span><span>계좌 이체</span></a>
                <a href="#" data-section="market" class="nav-link flex items-center space-x-2 px-3 py-2 rounded-md hover:bg-teal-600 transition-colors"><span>📈</span><span>주식 시장</span></a>
                <a href="#" data-section="shopPage" class="nav-link flex items-center space-x-2 px-3 py-2 rounded-md hover:bg-teal-600 transition-colors"><span>🛍️</span><span>상점</span></a>
                <a href="#" data-section="auctionPage" class="nav-link flex items-center space-x-2 px-3 py-2 rounded-md hover:bg-teal-600 transition-colors"><span>🏛️</span><span>경매</span></a>
                <a href="#" data-section="board" class="nav-link flex items-center space-x-2 px-3 py-2 rounded-md hover:bg-teal-600 transition-colors"><span>📢</span><span>게시판</span></a>
                <a href="#" data-section="deeds" class="nav-link flex items-center space-x-2 px-3 py-2 rounded-md hover:bg-teal-600 transition-colors"><span>🌟</span><span>나의 선행</span></a>
                <a href="#" data-section="transactions" class="nav-link flex items-center space-x-2 px-3 py-2 rounded-md hover:bg-teal-600 transition-colors"><span>🧾</span><span>거래 내역</span></a>
                <a href="#" data-section="ranking" class="nav-link flex items-center space-x-2 px-3 py-2 rounded-md hover:bg-teal-600 transition-colors"><span>🏆</span><span>랭킹</span></a>
                <a href="#" data-section="aiChat" class="nav-link flex items-center space-x-2 px-3 py-2 rounded-md hover:bg-teal-600 transition-colors"><span>💬</span><span>AI 챗</span></a>
                <hr class="border-teal-500">
                <a href="#" data-section="settings" class="nav-link flex items-center space-x-2 px-3 py-2 rounded-md hover:bg-teal-600 transition-colors"><span>🔧</span><span>환경 설정</span></a>
                <hr id="adminDivider" class="border-teal-500 hidden">
                <a href="#" id="adminNavLink" data-section="admin" class="nav-link flex items-center space-x-2 px-3 py-2 rounded-md hover:bg-teal-600 transition-colors hidden"><span>⚙️</span><span>관리자</span></a>
                <a href="#" id="loginLink" data-section="login" class="nav-link flex items-center space-x-2 px-3 py-2 rounded-md hover:bg-teal-600 transition-colors"><span>🔑</span><span id="loginLinkText">로그인</span></a>
            </nav>
            <div class="absolute bottom-4 left-4 text-sm"><p>로그인: <span id="loggedInUserDisplay">로그인 필요</span></p></div>
        </aside>

        <main id="mainContent" class="main-content flex-1 p-6 md:p-10 overflow-y-auto">
            <section id="login" class="hidden space-y-6 max-w-md mx-auto bg-white p-8 rounded-xl shadow-lg">
                <h2 class="text-3xl font-semibold text-teal-800 text-center">로그인</h2>
                <p class="text-stone-600 text-center">만승 경제 교실에 오신 것을 환영합니다!</p>
                <form id="loginForm" class="space-y-4">
                    <div><label for="email" class="block text-sm font-medium text-stone-700">이메일</label><input type="email" id="email" name="email" required class="mt-1 block w-full p-3 border border-stone-300 rounded-md shadow-sm focus:ring-teal-500 focus:border-teal-500 text-lg" placeholder="your@email.com"></div>
                    <div><label for="password" class="block text-sm font-medium text-stone-700">비밀번호</label><input type="password" id="password" name="password" required class="mt-1 block w-full p-3 border border-stone-300 rounded-md shadow-sm focus:ring-teal-500 focus:border-teal-500 text-lg" placeholder="********"></div>
                    <button type="submit" class="w-full bg-teal-500 hover:bg-teal-600 text-white font-bold py-3 px-4 rounded-lg shadow-md transition-transform hover:scale-105 text-lg">로그인</button>
                </form>
                <p class="text-sm text-center text-stone-500">계정이 없으신가요? <a href="#" id="switchToRegister" class="text-teal-600 hover:underline">회원가입</a></p>
                <p id="authError" class="text-sm text-center text-red-500 hidden"></p>
            </section>

            <section id="register" class="hidden space-y-6 max-w-md mx-auto bg-white p-8 rounded-xl shadow-lg">
                <h2 class="text-3xl font-semibold text-teal-800 text-center">회원가입</h2>
                <form id="registerForm" class="space-y-4">
                    <div><label for="registerName" class="block text-sm font-medium text-stone-700">이름</label><input type="text" id="registerName" name="name" required class="mt-1 block w-full p-3 border border-stone-300 rounded-md shadow-sm focus:ring-teal-500 focus:border-teal-500 text-lg" placeholder="김만승"></div>
                    <div><label for="registerEmail" class="block text-sm font-medium text-stone-700">이메일</label><input type="email" id="registerEmail" name="email" required class="mt-1 block w-full p-3 border border-stone-300 rounded-md shadow-sm focus:ring-teal-500 focus:border-teal-500 text-lg" placeholder="your@email.com"></div>
                    <div><label for="registerPassword" class="block text-sm font-medium text-stone-700">비밀번호</label><input type="password" id="registerPassword" name="password" required minlength="6" class="mt-1 block w-full p-3 border border-stone-300 rounded-md shadow-sm focus:ring-teal-500 focus:border-teal-500 text-lg" placeholder="6자 이상"></div>
                    <button type="submit" class="w-full bg-sky-500 hover:bg-sky-600 text-white font-bold py-3 px-4 rounded-lg shadow-md transition-transform hover:scale-105 text-lg">회원가입</button>
                </form>
                <p class="text-sm text-center text-stone-500">이미 계정이 있으신가요? <a href="#" id="switchToLogin" class="text-teal-600 hover:underline">로그인</a></p>
                <p id="registerAuthError" class="text-sm text-center text-red-500 hidden"></p>
            </section>

            <section id="dashboard" class="hidden space-y-6">
                <h2 class="text-3xl font-semibold text-teal-800">🏠 내 지갑 현황</h2>
                <p class="text-stone-600">나의 현재 자산 상태와 보유 현황을 한눈에 볼 수 있어요.</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-xl shadow-lg"><h3 class="text-xl font-semibold text-teal-700 mb-2">💰 현재 잔액 (KRW)</h3><p id="currentBalance" class="text-4xl font-bold text-sky-600">0 원</p></div>
                    <div class="bg-white p-6 rounded-xl shadow-lg"><h3 class="text-xl font-semibold text-teal-700 mb-2">📊 총 자산 가치</h3><p id="totalAssetValue" class="text-4xl font-bold text-emerald-600">0 원</p><p class="text-sm text-stone-500">(현금 + 주식 평가액)</p></div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-lg"><h3 class="text-xl font-semibold text-teal-700 mb-4">🎨 자산 구성</h3><div class="chart-container h-64 md:h-80"><canvas id="assetAllocationChart"></canvas></div></div>
                <div class="mt-8 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                    <button data-section="transfer" class="quick-action-button bg-sky-500 hover:bg-sky-600 text-white font-semibold py-3 px-4 rounded-lg shadow-md transition-transform hover:scale-105">💸 계좌 이체하기</button>
                    <button data-section="market" class="quick-action-button bg-emerald-500 hover:bg-emerald-600 text-white font-semibold py-3 px-4 rounded-lg shadow-md transition-transform hover:scale-105">📈 주식 거래하기</button>
                    <button data-section="shopPage" class="quick-action-button bg-orange-500 hover:bg-orange-600 text-white font-semibold py-3 px-4 rounded-lg shadow-md transition-transform hover:scale-105">🛍️ 상점 바로가기</button>
                    <button data-section="auctionPage" class="quick-action-button bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-3 px-4 rounded-lg shadow-md transition-transform hover:scale-105">🏛️ 경매 참여하기</button>
                    <button data-section="deeds" class="quick-action-button bg-amber-500 hover:bg-amber-600 text-white font-semibold py-3 px-4 rounded-lg shadow-md transition-transform hover:scale-105">🌟 선행 등록하기</button>
                </div>
            </section>

            <section id="transfer" class="hidden space-y-6">
                <h2 class="text-3xl font-semibold text-teal-800">💸 계좌 이체</h2>
                <p class="text-stone-600">친구에게 돈을 보낼 수 있어요. 정확한 정보를 입력해주세요.</p>
                <div class="bg-white p-8 rounded-xl shadow-lg max-w-lg mx-auto">
                    <form id="transferForm" class="space-y-4">
                        <div><label for="recipient" class="block text-sm font-medium text-stone-700">받는 사람 (이메일)</label><input type="email" id="recipient" name="recipient" required class="mt-1 block w-full p-3 border border-stone-300 rounded-md shadow-sm focus:ring-teal-500 focus:border-teal-500 text-lg" placeholder="friend@email.com"></div>
                        <div><label for="transferAmount" class="block text-sm font-medium text-stone-700">보낼 금액 (원)</label><input type="number" id="transferAmount" name="transferAmount" min="100" step="100" required class="mt-1 block w-full p-3 border border-stone-300 rounded-md shadow-sm focus:ring-teal-500 focus:border-teal-500 text-lg" placeholder="예: 5000"></div>
                        <div><label for="transferMemo" class="block text-sm font-medium text-stone-700">메모 (선택)</label><input type="text" id="transferMemo" name="transferMemo" class="mt-1 block w-full p-3 border border-stone-300 rounded-md shadow-sm focus:ring-teal-500 focus:border-teal-500 text-lg" placeholder="예: 생일 축하해!"></div>
                        <button type="submit" class="w-full bg-sky-500 hover:bg-sky-600 text-white font-bold py-3 px-4 rounded-lg shadow-md transition-transform hover:scale-105 text-lg">보내기</button>
                    </form>
                </div>
            </section>

            <section id="market" class="hidden space-y-6">
                <h2 class="text-3xl font-semibold text-teal-800">📈 주식 시장</h2>
                <p class="text-stone-600">다양한 주식을 사고 팔 수 있어요. 신중하게 투자하세요!</p>
                <div><div class="border-b border-stone-200 mb-4"><nav class="-mb-px flex space-x-8" aria-label="Tabs" id="marketTabsContainer"></nav></div><div id="marketContent" class="space-y-6"></div></div>
            </section>

            <section id="shopPage" class="hidden space-y-6">
                <h2 class="text-3xl font-semibold text-teal-800">🛍️ 만승 상점</h2>
                <p class="text-stone-600">선생님들이 준비한 특별한 물품들을 만나보세요!</p>
                <div id="shopItemList" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6"><p class="text-stone-500 col-span-full text-center">상점 물품을 불러오는 중입니다...</p></div>
            </section>

            <section id="auctionPage" class="hidden space-y-6">
                <h2 class="text-3xl font-semibold text-teal-800">🏛️ 만승 경매장</h2>
                <p class="text-stone-600">희귀한 물품을 얻을 수 있는 기회! 신중하게 입찰하세요.</p>
                <div class="border-b border-stone-200 mb-4">
                    <nav class="-mb-px flex space-x-8" aria-label="AuctionTabs">
                        <button data-auctiontype="active" class="auction-tab-button active py-3 px-1 border-b-2 border-teal-600 text-teal-600 whitespace-nowrap text-sm font-medium">진행중인 경매</button>
                        <button data-auctiontype="past" class="auction-tab-button py-3 px-1 border-b-2 border-transparent text-stone-500 hover:text-teal-600 hover:border-teal-600 whitespace-nowrap text-sm font-medium">지난 경매</button>
                    </nav>
                </div>
                <div id="auctionContentActive" class="auction-content-area grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                    <p class="text-stone-500 col-span-full text-center">진행중인 경매 물품을 불러오는 중입니다...</p>
                </div>
                <div id="auctionContentPast" class="auction-content-area hidden grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                    <p class="text-stone-500 col-span-full text-center">지난 경매 물품을 불러오는 중입니다...</p>
                </div>
            </section>

            <section id="board" class="hidden space-y-6">
                <h2 class="text-3xl font-semibold text-teal-800">📢 게시판</h2>
                <div class="border-b border-stone-200 mb-4">
                    <nav class="-mb-px flex space-x-8" aria-label="BoardTabs">
                        <button data-boardtype="notice" class="board-tab-button active py-3 px-1 border-b-2 border-teal-600 text-teal-600 whitespace-nowrap text-sm font-medium">공지사항</button>
                        <button data-boardtype="freeboard" class="board-tab-button py-3 px-1 border-b-2 border-transparent text-stone-500 hover:text-teal-600 hover:border-teal-600 whitespace-nowrap text-sm font-medium">자유게시판</button>
                    </nav>
                </div>
                <div id="boardContentNotice" class="board-content-area space-y-4">
                    <div class="flex justify-between items-center"><h3 class="text-xl font-semibold text-teal-700">공지사항 목록</h3><button id="newNoticePostBtn" class="bg-teal-500 hover:bg-teal-600 text-white font-semibold py-2 px-4 rounded-lg text-sm hidden">새 공지 작성</button></div>
                    <ul id="noticePostList" class="space-y-3"></ul>
                </div>
                <div id="boardContentFreeboard" class="board-content-area hidden space-y-4">
                    <div class="flex justify-between items-center"><h3 class="text-xl font-semibold text-teal-700">자유게시판 목록</h3><button id="newFreePostBtn" class="bg-sky-500 hover:bg-sky-600 text-white font-semibold py-2 px-4 rounded-lg text-sm">새 글 작성</button></div>
                    <ul id="freePostList" class="space-y-3"></ul>
                </div>
            </section>

            <section id="deeds" class="hidden space-y-6">
                <h2 class="text-3xl font-semibold text-teal-800">🌟 나의 선행</h2>
                <p class="text-stone-600">착한 일을 하고 내용을 기록하면 용돈을 받을 수 있어요! (1건당 1,000원, 하루 1번)</p>
                <div class="bg-white p-8 rounded-xl shadow-lg max-w-lg mx-auto">
                    <form id="deedForm" class="space-y-4">
                        <div><label for="deedDescription" class="block text-sm font-medium text-stone-700">선행 내용</label><textarea id="deedDescription" name="deedDescription" rows="4" required class="mt-1 block w-full p-3 border border-stone-300 rounded-md shadow-sm focus:ring-teal-500 focus:border-teal-500 text-lg" placeholder="예: 친구의 숙제를 도와주었습니다."></textarea></div>
                        <button type="submit" id="submitDeedBtn" class="w-full bg-amber-500 hover:bg-amber-600 text-white font-bold py-3 px-4 rounded-lg shadow-md transition-transform hover:scale-105 text-lg">선행 등록하기</button>
                    </form>
                </div>
                <div class="mt-8 bg-white p-6 rounded-xl shadow-lg"><h3 class="text-xl font-semibold text-teal-700 mb-4">나의 선행 기록</h3><ul id="deedList" class="space-y-3 max-h-96 overflow-y-auto"><li class="p-3 bg-stone-50 rounded-md border border-stone-200">등록된 선행이 없습니다.</li></ul></div>
            </section>

            <section id="transactions" class="hidden space-y-6">
                <h2 class="text-3xl font-semibold text-teal-800">🧾 거래 내역</h2>
                <p class="text-stone-600">모든 돈과 주식 거래 기록을 확인할 수 있어요.</p>
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-semibold text-teal-700">최근 거래</h3>
                        <select id="transactionFilter" class="p-2 border border-stone-300 rounded-md focus:ring-teal-500 focus:border-teal-500">
                            <option value="all">모든 내역</option><option value="transfer_in">입금</option><option value="transfer_out">출금</option>
                            <option value="buy">매수</option><option value="sell">매도</option><option value="deed">선행보상</option>
                            <option value="admin_credit">관리자 지급</option><option value="admin_debit">관리자 회수</option>
                            <option value="auction_bid">경매 입찰</option><option value="auction_bid_cancel">경매 입찰 취소</option><option value="auction_refund_lost">경매 낙찰실패 환불</option>
                        </select>
                    </div>
                    <div class="overflow-x-auto"><table class="min-w-full divide-y divide-stone-200"><thead class="bg-stone-50"><tr><th scope="col" class="px-6 py-3 text-left text-xs font-medium text-stone-500 uppercase tracking-wider">날짜/시간</th><th scope="col" class="px-6 py-3 text-left text-xs font-medium text-stone-500 uppercase tracking-wider">종류</th><th scope="col" class="px-6 py-3 text-left text-xs font-medium text-stone-500 uppercase tracking-wider">내용</th><th scope="col" class="px-6 py-3 text-right text-xs font-medium text-stone-500 uppercase tracking-wider">금액/수량</th><th scope="col" class="px-6 py-3 text-right text-xs font-medium text-stone-500 uppercase tracking-wider">잔액/보유량</th></tr></thead><tbody id="transactionList" class="bg-white divide-y divide-stone-200"><tr><td colspan="5" class="text-center py-4 text-stone-500">거래 내역이 없습니다.</td></tr></tbody></table></div>
                </div>
            </section>

            <section id="settings" class="hidden space-y-6 max-w-lg mx-auto">
                <h2 class="text-3xl font-semibold text-teal-800">🔧 환경 설정</h2>
                <div class="bg-white p-8 rounded-xl shadow-lg">
                    <form id="settingsForm" class="space-y-4"><div><label for="userName" class="block text-sm font-medium text-stone-700">이름 변경</label><input type="text" id="userName" name="userName" required class="mt-1 block w-full p-3 border border-stone-300 rounded-md shadow-sm focus:ring-teal-500 focus:border-teal-500 text-lg" placeholder="새로운 이름"></div><button type="submit" class="w-full bg-teal-500 hover:bg-teal-600 text-white font-bold py-3 px-4 rounded-lg shadow-md transition-transform hover:scale-105 text-lg">이름 저장</button></form>
                    <div class="mt-6"><h3 class="text-xl font-semibold text-teal-700 mb-2">비밀번호 변경</h3><form id="changePasswordForm" class="space-y-4"><div><label for="currentPassword" class="block text-sm font-medium text-stone-700">현재 비밀번호</label><input type="password" id="currentPassword" required class="mt-1 block w-full p-3 border border-stone-300 rounded-md shadow-sm"></div><div><label for="newPassword" class="block text-sm font-medium text-stone-700">새 비밀번호</label><input type="password" id="newPassword" required minlength="6" class="mt-1 block w-full p-3 border border-stone-300 rounded-md shadow-sm"></div><div><label for="confirmNewPassword" class="block text-sm font-medium text-stone-700">새 비밀번호 확인</label><input type="password" id="confirmNewPassword" required class="mt-1 block w-full p-3 border border-stone-300 rounded-md shadow-sm"></div><button type="submit" class="w-full bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 px-4 rounded-lg shadow-md">비밀번호 변경</button></form></div>
                </div>
            </section>

            <section id="ranking" class="hidden space-y-6">
                <h2 class="text-3xl font-semibold text-teal-800">🏆 랭킹</h2>
                <p class="text-stone-600">다른 친구들과 자산 및 수익률을 비교해보세요!</p>
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <div class="border-b border-stone-200 mb-4"><nav class="-mb-px flex space-x-8" aria-label="RankingTabs"><button data-rankingtype="totalAsset" class="ranking-tab-button active py-3 px-1 border-b-2 border-teal-600 text-teal-600 whitespace-nowrap text-sm font-medium">총 자산 랭킹</button><button data-rankingtype="roi" class="ranking-tab-button py-3 px-1 border-b-2 border-transparent text-stone-500 hover:text-teal-600 hover:border-teal-600 whitespace-nowrap text-sm font-medium">수익률 랭킹</button></nav></div>
                    <div id="rankingContentTotalAsset" class="ranking-content-area"><h3 class="text-xl font-semibold text-teal-700 mb-2">💰 총 자산 TOP 10</h3><ul id="totalAssetRankingList" class="space-y-2"><li class="text-center text-stone-500 py-4">랭킹 정보를 불러오는 중입니다...</li></ul></div>
                    <div id="rankingContentRoi" class="ranking-content-area hidden"><h3 class="text-xl font-semibold text-teal-700 mb-2">📈 수익률 TOP 10</h3><ul id="roiRankingList" class="space-y-2"><li class="text-center text-stone-500 py-4">수익률 랭킹을 불러오는 중입니다...</li></ul></div>
                </div>
            </section>

            <section id="aiChat" class="hidden space-y-6 max-w-lg mx-auto">
                <h2 class="text-3xl font-semibold text-purple-700">💬 AI 챗</h2>
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <div id="chatMessages" class="space-y-2 max-h-80 overflow-y-auto text-sm mb-4"></div>
                    <form id="chatForm" class="flex space-x-2">
                        <input type="text" id="chatInput" class="flex-grow border p-2 rounded-md" placeholder="고민이나 질문을 입력하세요" required>
                        <button type="submit" class="bg-teal-500 hover:bg-teal-600 text-white font-semibold px-4 rounded-md">전송</button>
                    </form>
                </div>
            </section>

            <section id="admin" class="hidden space-y-6">
                <h2 class="text-3xl font-semibold text-red-700">⚙️ 관리자 페이지 (교사용)</h2>
                <p class="text-stone-600">이 페이지는 교사만 접근할 수 있습니다. 학생 정보, 시장, 상점, 경매를 관리합니다.</p>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div class="bg-white p-6 rounded-xl shadow-lg"><h3 class="text-xl font-semibold text-red-600 mb-2">학생 관리</h3><ul id="adminStudentList" class="space-y-2 text-sm max-h-96 overflow-y-auto"><li>불러오는 중...</li></ul></div>
                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        <h3 class="text-xl font-semibold text-red-600 mb-2">시장 관리</h3><button id="randomizePricesBtn" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg text-sm">주가 임의 변경</button>
                        <div class="mt-4"><h4 class="text-md font-semibold text-red-500 mb-1">주식 가격 수동 변경</h4><select id="adminStockSelect" class="p-2 border rounded mb-2 w-full"></select><input type="number" id="adminNewPrice" placeholder="새 가격" class="p-2 border rounded w-full mb-2"><button id="adminUpdatePriceBtn" class="bg-orange-500 hover:bg-orange-600 text-white font-semibold py-2 px-4 rounded-lg text-sm w-full">가격 업데이트</button></div>
                        <div id="adminStockFluctuationSettings" class="mt-6"><h4 class="text-md font-semibold text-red-500 mb-1">주식 변동폭 설정</h4></div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-lg"><h3 class="text-xl font-semibold text-red-600 mb-2">선행 승인 관리</h3><div id="adminDeedApprovalList" class="space-y-3 max-h-96 overflow-y-auto"><p class="text-stone-500">선행 목록을 불러오는 중...</p></div></div>
                    <div class="bg-white p-6 rounded-xl shadow-lg md:col-span-1 lg:col-span-1">
                        <h3 class="text-xl font-semibold text-purple-600 mb-2">🛍️ 상점 물품 관리</h3><button id="adminAddNewShopItemBtn" class="bg-purple-500 hover:bg-purple-600 text-white font-semibold py-2 px-4 rounded-lg text-sm mb-4">새 상점물품 등록</button><div id="adminShopItemList" class="space-y-3 max-h-96 overflow-y-auto"><p class="text-stone-500">상점 물품 목록을 불러오는 중...</p></div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-lg md:col-span-2 lg:col-span-2">
                        <h3 class="text-xl font-semibold text-indigo-600 mb-2">🏛️ 경매 물품 관리</h3><button id="adminAddNewAuctionItemBtn" class="bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg text-sm mb-4">새 경매물품 등록</button><div id="adminAuctionItemList" class="space-y-3 max-h-96 overflow-y-auto"><p class="text-stone-500">경매 물품 목록을 불러오는 중...</p></div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-lg md:col-span-3">
                        <h3 class="text-xl font-semibold text-orange-600 mb-2">상점 구매 내역</h3>
                        <div id="adminPurchaseList" class="space-y-3 max-h-96 overflow-y-auto"><p class="text-stone-500">구매 내역을 불러오는 중...</p></div>
                    </div>
                </div>
            </section>
            
            <section id="adminUserDetail" class="hidden space-y-6">
                <button id="backToAdminListBtn" class="mb-4 bg-stone-500 hover:bg-stone-600 text-white font-semibold py-2 px-4 rounded-lg text-sm">← 학생 목록으로</button>
                <h2 id="adminUserDetailName" class="text-3xl font-semibold text-blue-700">학생 상세 정보</h2>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg"><h3 class="text-xl font-semibold text-blue-600 mb-2">보유 주식</h3><ul id="adminUserPortfolioList" class="space-y-1 text-sm"></ul></div>
                    <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-lg">
                        <h3 class="text-xl font-semibold text-blue-600 mb-2">거래 내역</h3><div class="overflow-x-auto max-h-96"><table class="min-w-full divide-y divide-stone-200 text-sm"><thead class="bg-stone-50 sticky top-0"><tr><th class="px-3 py-2 text-left">날짜</th><th class="px-3 py-2 text-left">종류</th><th class="px-3 py-2 text-left">내용</th><th class="px-3 py-2 text-right">금액/수량</th></tr></thead><tbody id="adminUserTransactionList" class="bg-white divide-y divide-stone-200"></tbody></table></div>
                    </div>
                    <div class="lg:col-span-3 bg-white p-6 rounded-xl shadow-lg"><h3 class="text-xl font-semibold text-blue-600 mb-2">선행 기록</h3><ul id="adminUserDeedList" class="space-y-2 text-sm max-h-60 overflow-y-auto"></ul></div>
                </div>
            </section>
        </main>
    </div>

    <div id="infoModal" class="modal"><div class="modal-content"><span id="closeInfoModalBtn" class="close-button">&times;</span><h3 id="modalTitle" class="text-xl font-semibold mb-2">알림</h3><p id="modalMessage" class="text-stone-700 whitespace-pre-wrap"></p><div class="mt-4 text-right"><button id="confirmInfoModalBtn" class="bg-teal-500 hover:bg-teal-600 text-white font-semibold py-2 px-4 rounded-lg">확인</button></div></div></div>
    <div id="aiContentModal" class="ai-modal"><div class="ai-modal-content"><span id="closeAiModalBtn" class="close-button">&times;</span><h3 id="aiModalTitle" class="text-2xl font-bold text-purple-600 mb-3">✨ AI 생성 내용</h3><div id="aiLoadingSpinner" class="loading-spinner hidden"></div><p id="aiModalMessage" class="text-stone-700 whitespace-pre-wrap text-lg leading-relaxed"></p><div class="mt-6 text-right"><button id="confirmAiModalBtn" class="bg-purple-500 hover:bg-purple-600 text-white font-semibold py-2 px-4 rounded-lg">닫기</button></div></div></div>
    <div id="adminAdjustBalanceModal" class="admin-modal"><div class="admin-modal-content"><span id="closeAdminAdjustBalanceModalBtn" class="close-button">&times;</span><h3 id="adminAdjustBalanceModalTitle" class="text-xl font-semibold text-red-600 mb-3">학생 잔액 조정</h3><p id="adminAdjustBalanceStudentInfo" class="text-sm text-stone-600 mb-3"></p><div><label for="adminAdjustmentAmount" class="block text-sm font-medium text-stone-700">조정 금액 (양수: 증가, 음수: 감소)</label><input type="number" id="adminAdjustmentAmount" class="mt-1 block w-full p-2 border border-stone-300 rounded-md shadow-sm focus:ring-red-500 focus:border-red-500"></div><div class="mt-2"><label for="adminAdjustmentReason" class="block text-sm font-medium text-stone-700">조정 사유</label><input type="text" id="adminAdjustmentReason" class="mt-1 block w-full p-2 border border-stone-300 rounded-md shadow-sm focus:ring-red-500 focus:border-red-500" placeholder="예: 특별 보상"></div><div class="mt-4 text-right space-x-2"><button id="cancelAdminAdjustBalanceBtn" class="bg-stone-500 hover:bg-stone-600 text-white font-semibold py-2 px-4 rounded-lg">취소</button><button id="adminConfirmAdjustBalanceBtn" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg">잔액 조정</button></div></div></div>
    <div id="adminEditNameModal" class="admin-modal"><div class="admin-modal-content"><span id="closeAdminEditNameModalBtn" class="close-button">&times;</span><h3 id="adminEditNameModalTitle" class="text-xl font-semibold text-red-600 mb-3">학생 이름 변경</h3><p id="adminEditNameStudentInfo" class="text-sm text-stone-600 mb-3"></p><div><label for="adminNewStudentName" class="block text-sm font-medium text-stone-700">새 이름</label><input type="text" id="adminNewStudentName" class="mt-1 block w-full p-2 border border-stone-300 rounded-md shadow-sm focus:ring-red-500 focus:border-red-500"></div><div class="mt-4 text-right space-x-2"><button id="cancelAdminEditNameBtn" class="bg-stone-500 hover:bg-stone-600 text-white font-semibold py-2 px-4 rounded-lg">취소</button><button id="adminConfirmEditNameBtn" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg">이름 저장</button></div></div></div>
    <div id="adminResetStockModal" class="admin-modal"><div class="admin-modal-content"><span id="closeAdminResetStockModalBtn" class="close-button">&times;</span><h3 id="adminResetStockModalTitle" class="text-xl font-semibold text-red-600 mb-3">보유 주식 초기화</h3><p id="adminResetStockInfo" class="text-sm text-stone-600 mb-3"></p><p class="text-sm text-red-500 mb-3">이 작업은 되돌릴 수 없습니다. 정말로 해당 주식의 보유량, 평단가 등을 초기화하시겠습니까?</p><div class="mt-4 text-right space-x-2"><button id="cancelAdminResetStockBtn" class="bg-stone-500 hover:bg-stone-600 text-white font-semibold py-2 px-4 rounded-lg">취소</button><button id="adminConfirmResetStockBtn" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg">초기화</button></div></div></div>
    <div id="adminResetPasswordModal" class="admin-modal"><div class="admin-modal-content"><span id="closeAdminResetPasswordModalBtn" class="close-button">&times;</span><h3 id="adminResetPasswordModalTitle" class="text-xl font-semibold text-red-600 mb-3">학생 비밀번호 초기화</h3><p id="adminResetPasswordStudentInfo" class="text-sm text-stone-600 mb-3"></p><div><label for="adminNewTemporaryPassword" class="block text-sm font-medium text-stone-700">새 임시 비밀번호</label><input type="text" id="adminNewTemporaryPassword" class="mt-1 block w-full p-2 border border-stone-300 rounded-md shadow-sm focus:ring-red-500 focus:border-red-500" value="mansung001"></div><p class="text-xs text-stone-500 mt-1">학생에게 이 임시 비밀번호를 전달하고, 로그인 후 즉시 변경하도록 안내해주세요.</p><div class="mt-4 text-right space-x-2"><button id="cancelAdminResetPasswordBtn" class="bg-stone-500 hover:bg-stone-600 text-white font-semibold py-2 px-4 rounded-lg">취소</button><button id="adminConfirmResetPasswordBtn" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg">임시 비밀번호로 초기화</button></div></div></div>
    <div id="postModal" class="post-modal"><div class="post-modal-content"><span id="closePostModalBtn" class="close-button">&times;</span><h3 id="postModalTitle" class="text-2xl font-bold text-teal-700 mb-4">글 작성/수정</h3><form id="postForm" class="space-y-4"><input type="hidden" id="postBoardType"><input type="hidden" id="postEditId"><div><label for="postTitleInput" class="block text-sm font-medium text-stone-700">제목</label><input type="text" id="postTitleInput" required class="mt-1 block w-full p-3 border border-stone-300 rounded-md shadow-sm focus:ring-teal-500 focus:border-teal-500 text-lg"></div><div><label for="postContentInput" class="block text-sm font-medium text-stone-700">내용</label><textarea id="postContentInput" rows="8" required class="mt-1 block w-full p-3 border border-stone-300 rounded-md shadow-sm focus:ring-teal-500 focus:border-teal-500 text-lg"></textarea></div><div class="text-right"><button type="submit" id="savePostBtn" class="bg-teal-500 hover:bg-teal-600 text-white font-bold py-2 px-4 rounded-lg">저장</button></div></form></div></div>
    <div id="shopItemFormModal" class="shop-modal"><div class="shop-modal-content"><span id="closeShopItemFormModalBtn" class="close-button">&times;</span><h3 id="shopItemFormModalTitle" class="text-2xl font-bold text-purple-700 mb-4">상점 물품 관리</h3><form id="shopItemForm" class="space-y-4"><input type="hidden" id="shopItemEditId"><div><label for="shopItemName" class="block text-sm font-medium text-stone-700">물품 이름</label><input type="text" id="shopItemName" required class="mt-1 block w-full p-3 border border-stone-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500 text-lg"></div><div><label for="shopItemPrice" class="block text-sm font-medium text-stone-700">가격 (원)</label><input type="number" id="shopItemPrice" min="0" step="100" required class="mt-1 block w-full p-3 border border-stone-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500 text-lg"></div><div><label for="shopItemDepositAccount" class="block text-sm font-medium text-stone-700">입금 계좌</label><input type="text" id="shopItemDepositAccount" required class="mt-1 block w-full p-3 border border-stone-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500 text-lg" placeholder="예: 만승은행 123-456-789 김만승"></div><div><label for="shopItemDescription" class="block text-sm font-medium text-stone-700">물품 설명 (선택)</label><textarea id="shopItemDescription" rows="3" class="mt-1 block w-full p-3 border border-stone-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500 text-lg"></textarea></div><div><label for="shopItemImageUrl" class="block text-sm font-medium text-stone-700">이미지 URL (선택)</label><input type="url" id="shopItemImageUrl" class="mt-1 block w-full p-3 border border-stone-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500 text-lg" placeholder="https://example.com/image.png"></div><div class="text-right"><button type="submit" id="saveShopItemBtn" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded-lg">저장</button></div></form></div></div>
    <div id="purchaseInfoModal" class="shop-modal"><div class="shop-modal-content"><span id="closePurchaseInfoModalBtn" class="close-button">&times;</span><h3 id="purchaseInfoModalTitle" class="text-2xl font-bold text-orange-600 mb-4">구매 정보</h3><div id="purchaseInfoDetails" class="space-y-3 text-stone-700"><p><strong>물품명:</strong> <span id="purchaseItemName"></span></p><p><strong>단가:</strong> <span id="purchaseItemPrice"></span></p><div><label for="purchaseQuantity" class="block text-sm font-medium text-stone-700">수량</label><input type="number" id="purchaseQuantity" min="1" value="1" class="mt-1 block w-full p-2 border border-stone-300 rounded-md"></div><p><strong>총액:</strong> <span id="purchaseItemTotal"></span></p><p><strong>입금 계좌:</strong> <span id="purchaseItemAccount" class="font-semibold text-blue-600"></span></p><p class="mt-4 text-sm text-stone-500">위 계좌로 정확한 금액을 입금하신 후, 선생님께 알려주시면 물품을 받을 수 있습니다.</p></div><div class="mt-6 text-right"><button id="confirmPurchaseInfoModalBtn" class="bg-orange-500 hover:bg-orange-600 text-white font-semibold py-2 px-4 rounded-lg">구매</button></div></div></div>
    <div id="auctionItemFormModal" class="auction-modal"><div class="auction-modal-content"><span id="closeAuctionItemFormModalBtn" class="close-button">&times;</span><h3 id="auctionItemFormModalTitle" class="text-2xl font-bold text-indigo-700 mb-4">경매 물품 관리</h3><form id="auctionItemForm" class="space-y-4"><input type="hidden" id="auctionItemEditId"><div><label for="auctionItemName" class="block text-sm font-medium text-stone-700">물품 이름</label><input type="text" id="auctionItemName" required class="mt-1 block w-full p-3 border border-stone-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-lg"></div><div><label for="auctionItemStartPrice" class="block text-sm font-medium text-stone-700">경매 시작가 (원)</label><input type="number" id="auctionItemStartPrice" min="0" step="100" required class="mt-1 block w-full p-3 border border-stone-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-lg"></div><div><label for="auctionItemDeadline" class="block text-sm font-medium text-stone-700">경매 마감 기한</label><input type="datetime-local" id="auctionItemDeadline" required class="mt-1 block w-full p-3 border border-stone-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-lg"></div><div><label for="auctionItemDescription" class="block text-sm font-medium text-stone-700">물품 설명 (선택)</label><textarea id="auctionItemDescription" rows="3" class="mt-1 block w-full p-3 border border-stone-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-lg"></textarea></div><div><label for="auctionItemImageUrl" class="block text-sm font-medium text-stone-700">이미지 URL (선택)</label><input type="url" id="auctionItemImageUrl" class="mt-1 block w-full p-3 border border-stone-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-lg" placeholder="https://example.com/image.png"></div><div class="text-right"><button type="submit" id="saveAuctionItemBtn" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg">저장</button></div></form></div></div>
    <div id="placeBidModal" class="auction-modal"><div class="auction-modal-content"><span id="closePlaceBidModalBtn" class="close-button">&times;</span><h3 id="placeBidModalTitle" class="text-2xl font-bold text-green-600 mb-4">입찰하기</h3><form id="placeBidForm" class="space-y-4"><input type="hidden" id="bidAuctionId"><p class="text-sm text-stone-600">물품명: <strong id="bidItemNameDisplay"></strong></p><p class="text-sm text-stone-600">현재 최고 입찰가: <strong id="currentHighestBidDisplay"></strong></p><div><label for="bidAmount" class="block text-sm font-medium text-stone-700">입찰 금액 (원)</label><input type="number" id="bidAmount" min="0" step="100" required class="mt-1 block w-full p-3 border border-stone-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500 text-lg"></div><p class="text-xs text-stone-500">입찰 금액은 현재 최고 입찰가보다 높아야 합니다.</p><div class="text-right"><button type="submit" id="confirmPlaceBidBtn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg">입찰</button></div></form></div></div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { 
        getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut,
        updateProfile, EmailAuthProvider, reauthenticateWithCredential, updatePassword
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { 
        getFirestore, collection, doc, setDoc, getDoc, updateDoc, deleteDoc, onSnapshot,
        query, where, addDoc, getDocs, serverTimestamp, increment, runTransaction,
        Timestamp, arrayUnion, orderBy, limit, deleteField, writeBatch, collectionGroup
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const firebaseConfig = { /* Firebase config object, AIzaSy... */
      apiKey: "AIzaSyDCeJPDQUNi-KmJ9DhkTRIu-9t2PGZCpt0", // Replace with your actual config
      authDomain: "mansungcoin-c6e06.firebaseapp.com",
      projectId: "mansungcoin-c6e06",
      storageBucket: "mansungcoin-c6e06.appspot.com",
      messagingSenderId: "704809284946",
      appId: "1:704809284946:web:3e71d98f38810577e1768b"
    };

    // Initialize Firebase
    const firebaseApp = initializeApp(firebaseConfig); 
    const auth = getAuth(firebaseApp);
    const db = getFirestore(firebaseApp);

    // --- Global Variables ---
    let currentUserData = null; 
    let currentAuthUser = null; 
    let stockDataCache = {}; 
    let unsubscribePortfolioListener = null;
    let unsubscribeTransactionsListener = null;
    let unsubscribeDeedsListener = null;
    let unsubscribeStockListeners = {};
    let unsubscribeNoticePostsListener = null;
    let unsubscribeFreeboardPostsListener = null;
    let unsubscribeShopItemsListener = null; 
    let unsubscribeAuctionsListener = null; // Listener for auctions
    let stockUpdateInterval = null;
    const MAX_HISTORY_LENGTH = 200; 
    let auctionCountdownIntervals = {};
    let shopItemToPurchase = null;
    let userNameCache = {};


    // --- Chart Instances ---
    let assetChartInstance = null;
    const stockChartInstances = {};

    // --- Utility Functions ---
    const formatCurrency = (amount) => new Intl.NumberFormat('ko-KR', { style: 'currency', currency: 'KRW' }).format(amount);
    const formatDate = (date) => {
        if (!date) return '날짜 정보 없음';
        const d = (date instanceof Timestamp) ? date.toDate() : new Date(date);
        return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')} ${String(d.getHours()).padStart(2, '0')}:${String(d.getMinutes()).padStart(2, '0')}`;
    };
    const isSameDay = (date1, date2) => { /* ... */ 
        if (!date1 || !date2) return false;
        const d1 = (date1 instanceof Timestamp) ? date1.toDate() : new Date(date1);
        const d2 = (date2 instanceof Timestamp) ? date2.toDate() : new Date(date2);
        return d1.getFullYear() === d2.getFullYear() && d1.getMonth() === d2.getMonth() && d1.getDate() === d2.getDate();
    };


    // --- Modal Elements & Functions ---
    const infoModal = document.getElementById('infoModal'); /* ... */
    const modalTitle = document.getElementById('modalTitle');
    const modalMessage = document.getElementById('modalMessage');
    const closeInfoModalBtn = document.getElementById('closeInfoModalBtn');
    const confirmInfoModalBtn = document.getElementById('confirmInfoModalBtn');
    const aiContentModal = document.getElementById('aiContentModal'); /* ... */
    const aiModalTitle = document.getElementById('aiModalTitle');
    const aiModalMessage = document.getElementById('aiModalMessage');
    const aiLoadingSpinner = document.getElementById('aiLoadingSpinner');
    const closeAiModalBtn = document.getElementById('closeAiModalBtn');
    const confirmAiModalBtn = document.getElementById('confirmAiModalBtn');
    const adminAdjustBalanceModal = document.getElementById('adminAdjustBalanceModal'); /* ... */
    const adminAdjustBalanceModalTitle = document.getElementById('adminAdjustBalanceModalTitle');
    const adminAdjustBalanceStudentInfo = document.getElementById('adminAdjustBalanceStudentInfo');
    const adminAdjustmentAmountInput = document.getElementById('adminAdjustmentAmount');
    const adminAdjustmentReasonInput = document.getElementById('adminAdjustmentReason');
    const adminConfirmAdjustBalanceBtn = document.getElementById('adminConfirmAdjustBalanceBtn');
    const closeAdminAdjustBalanceModalBtn = document.getElementById('closeAdminAdjustBalanceModalBtn');
    const cancelAdminAdjustBalanceBtn = document.getElementById('cancelAdminAdjustBalanceBtn');
    let studentIdToAdjust = null;
    const adminEditNameModal = document.getElementById('adminEditNameModal'); /* ... */
    const adminEditNameModalTitle = document.getElementById('adminEditNameModalTitle');
    const adminEditNameStudentInfo = document.getElementById('adminEditNameStudentInfo');
    const adminNewStudentNameInput = document.getElementById('adminNewStudentName');
    const adminConfirmEditNameBtn = document.getElementById('adminConfirmEditNameBtn');
    const closeAdminEditNameModalBtn = document.getElementById('closeAdminEditNameModalBtn');
    const cancelAdminEditNameBtn = document.getElementById('cancelAdminEditNameBtn');
    let studentIdToEditName = null;
    const adminResetStockModal = document.getElementById('adminResetStockModal'); /* ... */
    const adminResetStockModalTitle = document.getElementById('adminResetStockModalTitle');
    const adminResetStockInfo = document.getElementById('adminResetStockInfo');
    const adminConfirmResetStockBtn = document.getElementById('adminConfirmResetStockBtn');
    const closeAdminResetStockModalBtn = document.getElementById('closeAdminResetStockModalBtn');
    const cancelAdminResetStockBtn = document.getElementById('cancelAdminResetStockBtn');
    let studentIdToResetStock = null; let stockIdToReset = null;
    const adminResetPasswordModal = document.getElementById('adminResetPasswordModal'); /* ... */
    const adminResetPasswordModalTitle = document.getElementById('adminResetPasswordModalTitle');
    const adminResetPasswordStudentInfo = document.getElementById('adminResetPasswordStudentInfo');
    const adminNewTemporaryPasswordInput = document.getElementById('adminNewTemporaryPassword');
    const adminConfirmResetPasswordBtn = document.getElementById('adminConfirmResetPasswordBtn');
    const closeAdminResetPasswordModalBtn = document.getElementById('closeAdminResetPasswordModalBtn');
    const cancelAdminResetPasswordBtn = document.getElementById('cancelAdminResetPasswordBtn');
    let studentIdToResetPassword = null;
    const postModal = document.getElementById('postModal'); /* ... */
    const postModalTitleEl = document.getElementById('postModalTitle');
    const postForm = document.getElementById('postForm');
    const postBoardTypeInput = document.getElementById('postBoardType');
    const postEditIdInput = document.getElementById('postEditId');
    const postTitleInput = document.getElementById('postTitleInput');
    const postContentInput = document.getElementById('postContentInput');
    const closePostModalBtn = document.getElementById('closePostModalBtn');
    const shopItemFormModal = document.getElementById('shopItemFormModal'); /* ... */
    const shopItemFormModalTitle = document.getElementById('shopItemFormModalTitle');
    const shopItemForm = document.getElementById('shopItemForm');
    const shopItemEditIdInput = document.getElementById('shopItemEditId');
    const shopItemNameInput = document.getElementById('shopItemName');
    const shopItemPriceInput = document.getElementById('shopItemPrice');
    const shopItemDepositAccountInput = document.getElementById('shopItemDepositAccount');
    const shopItemDescriptionInput = document.getElementById('shopItemDescription');
    const shopItemImageUrlInput = document.getElementById('shopItemImageUrl');
    const closeShopItemFormModalBtn = document.getElementById('closeShopItemFormModalBtn');
    const purchaseInfoModal = document.getElementById('purchaseInfoModal'); /* ... */
    const purchaseInfoModalTitle = document.getElementById('purchaseInfoModalTitle');
    const purchaseItemNameEl = document.getElementById('purchaseItemName');
    const purchaseItemPriceEl = document.getElementById('purchaseItemPrice');
    const purchaseQuantityInput = document.getElementById('purchaseQuantity');
    const purchaseItemTotalEl = document.getElementById('purchaseItemTotal');
    const purchaseItemAccountEl = document.getElementById('purchaseItemAccount');
    const closePurchaseInfoModalBtn = document.getElementById('closePurchaseInfoModalBtn');
    const confirmPurchaseInfoModalBtn = document.getElementById('confirmPurchaseInfoModalBtn');
    // Auction Modals
    const auctionItemFormModal = document.getElementById('auctionItemFormModal');
    const auctionItemFormModalTitle = document.getElementById('auctionItemFormModalTitle');
    const auctionItemForm = document.getElementById('auctionItemForm');
    const auctionItemEditIdInput = document.getElementById('auctionItemEditId');
    const auctionItemNameInput = document.getElementById('auctionItemName');
    const auctionItemStartPriceInput = document.getElementById('auctionItemStartPrice');
    const auctionItemDeadlineInput = document.getElementById('auctionItemDeadline');
    const auctionItemDescriptionInput = document.getElementById('auctionItemDescription');
    const auctionItemImageUrlInput = document.getElementById('auctionItemImageUrl');
    const closeAuctionItemFormModalBtn = document.getElementById('closeAuctionItemFormModalBtn');
    const placeBidModal = document.getElementById('placeBidModal');
    const placeBidModalTitle = document.getElementById('placeBidModalTitle');
    const placeBidForm = document.getElementById('placeBidForm');
    const bidAuctionIdInput = document.getElementById('bidAuctionId');
    const bidItemNameDisplay = document.getElementById('bidItemNameDisplay');
    const currentHighestBidDisplay = document.getElementById('currentHighestBidDisplay');
    const bidAmountInput = document.getElementById('bidAmount');
    const closePlaceBidModalBtn = document.getElementById('closePlaceBidModalBtn');

    function showInfoModal(title, message) { /* ... */ modalTitle.textContent = title; modalMessage.textContent = message; infoModal.style.display = 'block'; }
    function closeInfoModal() { infoModal.style.display = 'none'; }
    function showAiModal(title) { /* ... */ aiModalTitle.textContent = title; aiModalMessage.textContent = ''; aiLoadingSpinner.classList.remove('hidden'); aiContentModal.style.display = 'block'; }
    function updateAiModalContent(content) { aiModalMessage.textContent = content; aiLoadingSpinner.classList.add('hidden'); }
    function closeAiModal() { aiContentModal.style.display = 'none'; aiLoadingSpinner.classList.add('hidden'); }
    function showAdminAdjustBalanceModal(studentId, studentName, currentBalance) { /* ... */ studentIdToAdjust = studentId; adminAdjustBalanceModalTitle.textContent = `${studentName} 학생 잔액 조정`; adminAdjustBalanceStudentInfo.textContent = `현재 잔액: ${formatCurrency(currentBalance)}`; adminAdjustmentAmountInput.value = ''; adminAdjustmentReasonInput.value = ''; adminAdjustBalanceModal.style.display = 'block'; }
    function closeAdminAdjustBalanceModal() { adminAdjustBalanceModal.style.display = 'none'; studentIdToAdjust = null; }
    function showAdminEditNameModal(studentId, currentName) { /* ... */ studentIdToEditName = studentId; adminEditNameModalTitle.textContent = `학생 이름 변경 (${currentName})`; adminEditNameStudentInfo.textContent = `현재 이름: ${currentName}`; adminNewStudentNameInput.value = currentName; adminEditNameModal.style.display = 'block'; }
    function closeAdminEditNameModal() { adminEditNameModal.style.display = 'none'; studentIdToEditName = null; }
    function showAdminResetStockModal(studentId, studentName, stockName, currentStockId) { /* ... */ studentIdToResetStock = studentId; stockIdToReset = currentStockId; adminResetStockModalTitle.textContent = `${studentName} 학생의 ${stockName} 보유량 초기화`; adminResetStockInfo.textContent = `${studentName} 학생의 ${stockName} 주식 보유 정보를 초기화합니다.`; adminResetStockModal.style.display = 'block'; }
    function closeAdminResetStockModal() { adminResetStockModal.style.display = 'none'; studentIdToResetStock = null; stockIdToReset = null; }
    function showAdminResetPasswordModal(studentId, studentName, studentEmail) { /* ... */ studentIdToResetPassword = studentId; adminResetPasswordModalTitle.textContent = `${studentName} (${studentEmail}) 비밀번호 초기화`; adminResetPasswordStudentInfo.textContent = `새로운 임시 비밀번호를 설정합니다.`; adminNewTemporaryPasswordInput.value = "mansung001"; adminResetPasswordModal.style.display = 'block'; }
    function closeAdminResetPasswordModal() { adminResetPasswordModal.style.display = 'none'; studentIdToResetPassword = null; }
    function showPostModal(boardType, post = null) { /* ... */ postBoardTypeInput.value = boardType; if (post) { postModalTitleEl.textContent = `${boardType === 'notice' ? '공지사항' : '자유게시글'} 수정`; postEditIdInput.value = post.id; postTitleInput.value = post.title; postContentInput.value = post.content; } else { postModalTitleEl.textContent = `새 ${boardType === 'notice' ? '공지사항' : '자유게시글'} 작성`; postEditIdInput.value = ''; postForm.reset(); } postModal.style.display = 'block'; }
    function closePostModal() { postModal.style.display = 'none'; postForm.reset(); postEditIdInput.value = ''; }
    function showShopItemFormModal(item = null) { /* ... */ if (item) { shopItemFormModalTitle.textContent = "상점 물품 수정"; shopItemEditIdInput.value = item.id; shopItemNameInput.value = item.itemName; shopItemPriceInput.value = item.price; shopItemDepositAccountInput.value = item.depositAccount; shopItemDescriptionInput.value = item.description || ""; shopItemImageUrlInput.value = item.imageUrl || ""; } else { shopItemFormModalTitle.textContent = "새 상점 물품 등록"; shopItemForm.reset(); shopItemEditIdInput.value = ""; } shopItemFormModal.style.display = 'block'; }
    function closeShopItemFormModal() { shopItemFormModal.style.display = 'none'; }
    function showPurchaseInfoModal(item) {
        shopItemToPurchase = item;
        purchaseItemNameEl.textContent = item.itemName;
        purchaseItemPriceEl.textContent = formatCurrency(item.price);
        purchaseQuantityInput.value = 1;
        purchaseItemTotalEl.textContent = formatCurrency(item.price);
        purchaseItemAccountEl.textContent = item.depositAccount;
        purchaseInfoModal.style.display = 'block';
    }
    function closePurchaseInfoModal() {
        purchaseInfoModal.style.display = 'none';
        shopItemToPurchase = null;
    }

    async function handleDirectPurchase(item, qty) {
        if (!currentAuthUser || !currentUserData) {
            showInfoModal('오류', '로그인이 필요합니다.');
            return;
        }
        if (qty <= 0) { showInfoModal('오류', '올바른 수량을 입력하세요.'); return; }
        const total = qty * item.price;
        if (total > currentUserData.balance) { showInfoModal('오류', '잔액이 부족합니다.'); return; }
        try {
            const buyerRef = doc(db, 'users', currentAuthUser.uid);
            const accountRef = doc(db, 'depositAccounts', item.depositAccount);
            await runTransaction(db, async (tx) => {
                const buyerSnap = await tx.get(buyerRef);
                const accountSnap = await tx.get(accountRef);
                const ownerUid = accountSnap.exists() ? accountSnap.data().ownerUid : null;
                let ownerRef = null;
                let ownerSnap = null;
                if (ownerUid) {
                    ownerRef = doc(db, 'users', ownerUid);
                    ownerSnap = await tx.get(ownerRef);
                }

                if (!buyerSnap.exists() || buyerSnap.data().balance < total) throw new Error('잔액이 부족합니다. (트랜잭션 확인)');

                tx.update(buyerRef, { balance: increment(-total) });
                tx.set(doc(collection(buyerRef, 'transactions')), {
                    type: 'shop_purchase',
                    description: `${item.itemName} ${qty}개 구입`,
                    amount: total,
                    date: serverTimestamp(),
                    depositAccount: item.depositAccount
                });

                tx.set(doc(collection(accountRef, 'transactions')), {
                    message: `${currentUserData.name}가 ${item.itemName}을 ${qty}개 구입하였습니다.`,
                    amount: total,
                    date: serverTimestamp(),
                    buyerUid: currentAuthUser.uid,
                    buyerName: currentUserData.name,
                    itemId: item.id
                });

                if (ownerRef && ownerSnap && ownerSnap.exists()) {
                    tx.update(ownerRef, { balance: increment(total) });
                    tx.set(doc(collection(ownerRef, 'transactions')), {
                        type: 'shop_sale',
                        description: `${item.itemName} ${qty}개 판매`,
                        amount: total,
                        date: serverTimestamp(),
                        buyerUid: currentAuthUser.uid,
                        buyerName: currentUserData.name,
                        itemId: item.id
                    });
                }
            });
            showInfoModal('구매 완료', `${item.itemName} ${qty}개를 ${formatCurrency(total)}에 구입했습니다.`);
        } catch (error) {
            showInfoModal('오류', `구매 처리 중 오류가 발생했습니다: ${error.message}`);
        }
    }

async function handleConfirmPurchase() {
        if (!currentAuthUser || !currentUserData || !shopItemToPurchase) {
            showInfoModal('오류', '구매 정보를 확인할 수 없습니다.');
            return;
        }
        const qty = parseInt(purchaseQuantityInput.value) || 1;
        await handleDirectPurchase(shopItemToPurchase, qty);
        closePurchaseInfoModal();
    }
    function showAuctionItemFormModal(item = null) {
        if (item) { // Edit mode
            auctionItemFormModalTitle.textContent = "경매 물품 수정";
            auctionItemEditIdInput.value = item.id;
            auctionItemNameInput.value = item.itemName;
            auctionItemStartPriceInput.value = item.startPrice;
            auctionItemDeadlineInput.value = item.deadline ? new Date(item.deadline.seconds * 1000).toISOString().substring(0, 16) : '';
            auctionItemDescriptionInput.value = item.description || "";
            auctionItemImageUrlInput.value = item.imageUrl || "";
        } else { // Create mode
            auctionItemFormModalTitle.textContent = "새 경매 물품 등록";
            auctionItemForm.reset();
            auctionItemEditIdInput.value = "";
        }
        auctionItemFormModal.style.display = 'block';
    }
    function closeAuctionItemFormModal() { auctionItemFormModal.style.display = 'none'; }
    function showPlaceBidModal(auctionId, itemName, currentBid) {
        bidAuctionIdInput.value = auctionId;
        bidItemNameDisplay.textContent = itemName;
        currentHighestBidDisplay.textContent = formatCurrency(currentBid);
        bidAmountInput.value = '';
        bidAmountInput.min = currentBid + 100; // Minimum bid must be higher
        placeBidModal.style.display = 'block';
    }
    function closePlaceBidModal() { placeBidModal.style.display = 'none'; }

    closeInfoModalBtn.addEventListener('click', closeInfoModal); /* ... */
    confirmInfoModalBtn.addEventListener('click', closeInfoModal);
    closeAiModalBtn.addEventListener('click', closeAiModal);
    confirmAiModalBtn.addEventListener('click', closeAiModal);
    closeAdminAdjustBalanceModalBtn.addEventListener('click', closeAdminAdjustBalanceModal);
    cancelAdminAdjustBalanceBtn.addEventListener('click', closeAdminAdjustBalanceModal);
    closeAdminEditNameModalBtn.addEventListener('click', closeAdminEditNameModal);
    cancelAdminEditNameBtn.addEventListener('click', closeAdminEditNameModal);
    closeAdminResetStockModalBtn.addEventListener('click', closeAdminResetStockModal);
    cancelAdminResetStockBtn.addEventListener('click', closeAdminResetStockModal);
    closeAdminResetPasswordModalBtn.addEventListener('click', closeAdminResetPasswordModal);
    cancelAdminResetPasswordBtn.addEventListener('click', closeAdminResetPasswordModal);
    closePostModalBtn.addEventListener('click', closePostModal);
    closeShopItemFormModalBtn.addEventListener('click', closeShopItemFormModal);
    closePurchaseInfoModalBtn.addEventListener('click', closePurchaseInfoModal);
    purchaseQuantityInput.addEventListener('input', () => {
        const qty = parseInt(purchaseQuantityInput.value) || 1;
        if (shopItemToPurchase) purchaseItemTotalEl.textContent = formatCurrency(qty * shopItemToPurchase.price);
    });
    confirmPurchaseInfoModalBtn.addEventListener('click', handleConfirmPurchase);
    closeAuctionItemFormModalBtn.addEventListener('click', closeAuctionItemFormModal);
    closePlaceBidModalBtn.addEventListener('click', closePlaceBidModal);

    window.onclick = function(event) {
        if (event.target == infoModal) closeInfoModal();
        if (event.target == aiContentModal) closeAiModal();
        if (event.target == adminAdjustBalanceModal) closeAdminAdjustBalanceModal();
        if (event.target == adminEditNameModal) closeAdminEditNameModal();
        if (event.target == adminResetStockModal) closeAdminResetStockModal();
        if (event.target == adminResetPasswordModal) closeAdminResetPasswordModal();
        if (event.target == postModal) closePostModal();
        if (event.target == shopItemFormModal) closeShopItemFormModal();
        if (event.target == purchaseInfoModal) closePurchaseInfoModal();
        if (event.target == auctionItemFormModal) closeAuctionItemFormModal();
        if (event.target == placeBidModal) closePlaceBidModal();
    }

    async function loadAdminDeeds() {
        if (!currentAuthUser || !currentUserData || currentUserData.role !== 'teacher') {
            adminDeedApprovalListEl.innerHTML = '<p class="text-stone-500">선행 관리는 관리자만 가능합니다.</p>'; return;
        }
        adminDeedApprovalListEl.innerHTML = '<p class="text-stone-500">선행 목록을 불러오는 중...</p>';
        try {
            const q = query(collectionGroup(db, 'deeds'), where('status', 'in', ['pending', 'rewrite']), orderBy('date', 'asc'));
            const snapshot = await getDocs(q);
            adminDeedApprovalListEl.innerHTML = '';
            if (snapshot.empty) { adminDeedApprovalListEl.innerHTML = '<p class="text-stone-500">검토할 선행이 없습니다.</p>'; return; }
            snapshot.forEach(docSnap => {
                const parentUid = docSnap.ref.parent.parent.id;
                const deed = { id: docSnap.id, userUid: parentUid, ...docSnap.data() };
                const div = document.createElement('div');
                div.className = 'bg-stone-50 p-3 rounded-md border border-stone-200 flex justify-between items-start';
                div.innerHTML = `
                    <div>
                        <p class="font-medium">${deed.authorName || deed.userUid}</p>
                        <p class="text-sm text-stone-700">${deed.description}</p>
                        <p class="text-xs text-stone-500">${formatDate(deed.date)} - 상태: ${deed.status === 'pending' ? '승인대기' : '재작성 필요'}</p>
                    </div>
                    <div class="space-x-2 flex-shrink-0">
                        <button data-userid="${deed.userUid}" data-deedid="${deed.id}" data-reward="${deed.reward}" data-desc="${deed.description}" class="admin-approve-deed-btn bg-teal-500 hover:bg-teal-600 text-white text-xs py-1 px-2 rounded">승인</button>
                        <button data-userid="${deed.userUid}" data-deedid="${deed.id}" class="admin-rewrite-deed-btn bg-yellow-500 hover:bg-yellow-600 text-white text-xs py-1 px-2 rounded">재작성</button>
                    </div>`;
                adminDeedApprovalListEl.appendChild(div);
            });
            document.querySelectorAll('.admin-approve-deed-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const deedId = e.target.dataset.deedid;
                    const userId = e.target.dataset.userid;
                    const reward = parseInt(e.target.dataset.reward);
                    const desc = e.target.dataset.desc;
                    try {
                        const userRef = doc(db, 'users', userId);
                        const deedRef = doc(db, 'users', userId, 'deeds', deedId);
                        await runTransaction(db, async (tx) => {
                            tx.update(userRef, { balance: increment(reward) });
                            tx.update(deedRef, { status: 'approved', updatedAt: serverTimestamp() });
                            tx.set(doc(collection(userRef, 'transactions')), {
                                type: 'deed',
                                description: `선행보상: ${desc.substring(0,20)}...`,
                                amount: reward,
                                date: serverTimestamp()
                            });
                        });
                        showInfoModal('성공', '선행을 승인했습니다.');
                        loadAdminDeeds();
                    } catch (error) {
                        console.error('Error approving deed:', error);
                        showInfoModal('오류', '선행 승인 중 오류가 발생했습니다.');
                    }
                });
            });
            document.querySelectorAll('.admin-rewrite-deed-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const deedId = e.target.dataset.deedid;
                    const userId = e.target.dataset.userid;
                    try {
                        await updateDoc(doc(db, 'users', userId, 'deeds', deedId), { status: 'rewrite', updatedAt: serverTimestamp() });
                        showInfoModal('요청 완료', '재작성을 요청했습니다.');
                        loadAdminDeeds();
                    } catch (error) {
                        console.error('Error requesting rewrite:', error);
                        showInfoModal('오류', '재작성 요청 중 오류가 발생했습니다.');
                    }
                });
            });
        } catch (error) {
            console.error('Error loading deeds for admin:', error);
            if (error.code === 'permission-denied') {
                adminDeedApprovalListEl.innerHTML =
                    '<p class="text-red-500">선행 목록 로드 실패: Firestore 규칙에서 teacher 권한의 읽기 권한을 확인하세요.</p>';
            } else if (error.code === 'failed-precondition' && /index/i.test(error.message)) {
                adminDeedApprovalListEl.innerHTML =
                    '<p class="text-red-500">선행 목록 로드 실패: Firestore 색인이 필요합니다. README의 "Firestore Index Setup" 절을 참고하세요.</p>';
            } else {
                adminDeedApprovalListEl.innerHTML = '<p class="text-red-500">선행 목록 로드 실패.</p>';
            }
        }
    }

    // --- DOM Elements ---
    const sections = document.querySelectorAll('main section'); /* ... */
    const navLinks = document.querySelectorAll('.nav-link');
    const adminNavLink = document.getElementById('adminNavLink');
    const adminDivider = document.getElementById('adminDivider');
    const quickActionButtons = document.querySelectorAll('.quick-action-button');
    const currentBalanceEl = document.getElementById('currentBalance');
    const totalAssetValueEl = document.getElementById('totalAssetValue');
    const recipientInput = document.getElementById('recipient'); 
    const transferForm = document.getElementById('transferForm');
    const deedForm = document.getElementById('deedForm');
    const deedDescriptionEl = document.getElementById('deedDescription');
    const deedListEl = document.getElementById('deedList');
    const transactionListEl = document.getElementById('transactionList');
    const transactionFilterEl = document.getElementById('transactionFilter');
    const marketTabsContainer = document.getElementById('marketTabsContainer');
    const marketContentContainer = document.getElementById('marketContent');
    const loggedInUserDisplay = document.getElementById('loggedInUserDisplay');
    const loginForm = document.getElementById('loginForm');
    const registerForm = document.getElementById('registerForm');
    const loginLink = document.getElementById('loginLink');
    const loginLinkText = document.getElementById('loginLinkText');
    const authErrorEl = document.getElementById('authError');
    const registerAuthErrorEl = document.getElementById('registerAuthError');
    const adminStudentListEl = document.getElementById('adminStudentList');
    const adminStockFluctuationSettingsEl = document.getElementById('adminStockFluctuationSettings');
    const settingsForm = document.getElementById('settingsForm');
    const userNameInput = document.getElementById('userName');
    const changePasswordForm = document.getElementById('changePasswordForm');
    const rankingContentTotalAsset = document.getElementById('rankingContentTotalAsset');
    const rankingContentRoi = document.getElementById('rankingContentRoi');
    const totalAssetRankingListEl = document.getElementById('totalAssetRankingList');
    const roiRankingListEl = document.getElementById('roiRankingList');
    const rankingTabButtons = document.querySelectorAll('.ranking-tab-button');
    const adminUserDetailSection = document.getElementById('adminUserDetail');
    const adminUserDetailNameEl = document.getElementById('adminUserDetailName');
    const adminUserPortfolioListEl = document.getElementById('adminUserPortfolioList');
    const adminUserTransactionListEl = document.getElementById('adminUserTransactionList');
    const adminUserDeedListEl = document.getElementById('adminUserDeedList');
    const backToAdminListBtn = document.getElementById('backToAdminListBtn');
    const boardTabButtons = document.querySelectorAll('.board-tab-button');
    const boardContentNoticeEl = document.getElementById('boardContentNotice');
    const boardContentFreeboardEl = document.getElementById('boardContentFreeboard');
    const noticePostListEl = document.getElementById('noticePostList');
    const freePostListEl = document.getElementById('freePostList');
    const newNoticePostBtn = document.getElementById('newNoticePostBtn');
    const newFreePostBtn = document.getElementById('newFreePostBtn');
    const shopItemListEl = document.getElementById('shopItemList');
    const adminShopItemListEl = document.getElementById('adminShopItemList');
    const adminAddNewShopItemBtn = document.getElementById('adminAddNewShopItemBtn');
    const adminDeedApprovalListEl = document.getElementById('adminDeedApprovalList');
    const adminPurchaseListEl = document.getElementById('adminPurchaseList');
    // AI Chat DOM Elements
    const chatMessagesEl = document.getElementById('chatMessages');
    const chatForm = document.getElementById('chatForm');
    const chatInput = document.getElementById('chatInput');
    // Auction DOM Elements
    const auctionTabButtons = document.querySelectorAll('.auction-tab-button');
    const auctionContentActiveEl = document.getElementById('auctionContentActive');
    const auctionContentPastEl = document.getElementById('auctionContentPast');
    const adminAddNewAuctionItemBtn = document.getElementById('adminAddNewAuctionItemBtn');
    const adminAuctionItemListEl = document.getElementById('adminAuctionItemList');


    // --- Navigation ---
    function showSection(sectionId, forceShow = false) { /* ... */ 
        console.log("Attempting to show section:", sectionId);
        if (!currentAuthUser && !forceShow && sectionId !== 'login' && sectionId !== 'register') { showSection('login', true); return; }
        if (sectionId === 'admin' && (!currentUserData || currentUserData.role !== 'teacher')) { showInfoModal("접근 불가", "관리자만 접근할 수 있는 페이지입니다."); showSection('dashboard'); return; }
        if (sectionId === 'adminUserDetail' && (!currentUserData || currentUserData.role !== 'teacher')) { showInfoModal("접근 불가", "관리자만 접근할 수 있는 페이지입니다."); showSection('admin'); return; }
        sections.forEach(section => section.classList.add('hidden'));
        const targetSection = document.getElementById(sectionId);
        if (targetSection) targetSection.classList.remove('hidden');
        else { console.error(`Section with id "${sectionId}" not found.`); if (currentAuthUser) showSection('dashboard'); else showSection('login', true); return; }
        navLinks.forEach(link => { link.classList.remove('bg-teal-600', 'font-semibold'); if (link.dataset.section === sectionId) link.classList.add('bg-teal-600', 'font-semibold'); });
        if (window.innerWidth < 768 && sidebar.classList.contains('open')) sidebar.classList.remove('open');
        if (currentAuthUser) { 
            if (sectionId === 'dashboard') updateDashboardDisplay();
            if (sectionId === 'market') loadAndRenderMarketTabs();
            if (sectionId === 'shopPage') loadAndRenderShopItems();
            if (sectionId === 'auctionPage') { loadAndRenderAuctionItems('active'); checkAndProcessEndedAuctions(); } // Load active auctions by default
            if (sectionId === 'board') loadAndRenderBoard('notice'); 
            if (sectionId === 'transactions') renderTransactions();
            if (sectionId === 'deeds') renderDeeds();
            if (sectionId === 'settings') loadUserSettings();
            if (sectionId === 'ranking') loadRankingData('totalAsset');
            if (sectionId === 'admin' && currentUserData && currentUserData.role === 'teacher') { loadAdminData(); loadAdminDeeds(); loadAdminShopItems(); loadAdminAuctionItems(); loadAdminPurchases(); }
        }
    }
    document.getElementById('switchToRegister').addEventListener('click', (e) => { e.preventDefault(); showSection('register', true); });
    document.getElementById('switchToLogin').addEventListener('click', (e) => { e.preventDefault(); showSection('login', true); });
    backToAdminListBtn.addEventListener('click', () => showSection('admin'));
    navLinks.forEach(link => { link.addEventListener('click', (e) => { e.preventDefault(); if (link.id === 'loginLink' && currentAuthUser) { signOut(auth).catch(error => showInfoModal("로그아웃 오류", `로그아웃 중 문제가 발생했습니다: ${error.message}`)); } else { showSection(link.dataset.section); } }); });
    quickActionButtons.forEach(button => { button.addEventListener('click', (e) => { e.preventDefault(); showSection(button.dataset.section); }); });

    // --- Firebase Auth State Change ---
    onAuthStateChanged(auth, async (user) => { /* ... */ 
        currentAuthUser = user;
        if (user) {
            loggedInUserDisplay.textContent = user.displayName || user.email; loginLinkText.textContent = '로그아웃';
            await loadCurrentUserData(user.uid); attachRealtimeListeners(user.uid); startStockUpdates(); 
            if (currentUserData && currentUserData.role === 'teacher') { adminNavLink.classList.remove('hidden'); adminDivider.classList.remove('hidden'); newNoticePostBtn.classList.remove('hidden'); } 
            else { adminNavLink.classList.add('hidden'); adminDivider.classList.add('hidden'); newNoticePostBtn.classList.add('hidden'); }
            showSection('dashboard'); 
        } else {
            loggedInUserDisplay.textContent = '로그인 필요'; loginLinkText.textContent = '로그인';
            adminNavLink.classList.add('hidden'); adminDivider.classList.add('hidden'); newNoticePostBtn.classList.add('hidden');
            currentUserData = null; detachRealtimeListeners(); stopStockUpdates(); clearDashboard(); 
            showSection('login', true); 
        }
    });
    function clearDashboard() { /* ... */ 
        currentBalanceEl.textContent = formatCurrency(0); totalAssetValueEl.textContent = formatCurrency(0);
        if (assetChartInstance) { assetChartInstance.destroy(); assetChartInstance = null; }
        transactionListEl.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-stone-500">로그인이 필요합니다.</td></tr>';
        deedListEl.innerHTML = '<li class="p-3 bg-stone-50 rounded-md border border-stone-200 text-center text-stone-500">로그인이 필요합니다.</li>';
        shopItemListEl.innerHTML = '<p class="text-stone-500 col-span-full text-center">로그인이 필요합니다.</p>';
        auctionContentActiveEl.innerHTML = '<p class="text-stone-500 col-span-full text-center">로그인이 필요합니다.</p>';
        auctionContentPastEl.innerHTML = '<p class="text-stone-500 col-span-full text-center">로그인이 필요합니다.</p>';
    }

    // --- Firebase Firestore Data Loading ---
    async function loadCurrentUserData(userId) { /* ... */ 
        const userDocRef = doc(db, "users", userId);
        try {
            const docSnap = await getDoc(userDocRef);
            if (docSnap.exists()) { currentUserData = { id: docSnap.id, ...docSnap.data() }; if (!currentUserData.portfolio) currentUserData.portfolio = {}; if (!currentUserData.deeds) currentUserData.deeds = []; } 
            else { currentUserData = { id: userId, name: currentAuthUser.displayName || "새 사용자", email: currentAuthUser.email, balance: 2000, portfolio: {}, deeds: [], role: 'student', createdAt: serverTimestamp() }; await setDoc(userDocRef, { uid: userId, name: currentUserData.name, email: currentUserData.email, balance: currentUserData.balance, portfolio: currentUserData.portfolio, role: currentUserData.role, createdAt: currentUserData.createdAt }); }
            updateDashboardDisplay();
        } catch (error) { console.error("Error loading user data:", error); showInfoModal("오류", "사용자 정보를 불러오는 데 실패했습니다."); }
    }
    function attachRealtimeListeners(userId) { /* ... */ 
        detachRealtimeListeners();
        const userDocRef = doc(db, "users", userId);
        unsubscribePortfolioListener = onSnapshot(userDocRef, (docSnap) => { if (docSnap.exists()) { currentUserData = { ...currentUserData, ...docSnap.data(), id: docSnap.id }; if (!currentUserData.portfolio) currentUserData.portfolio = {}; if (document.getElementById('dashboard').classList.contains('hidden') === false) updateDashboardDisplay(); const activeStockTab = document.querySelector('#market .tab-button.active'); if (activeStockTab && document.getElementById('market').classList.contains('hidden') === false) { const stockIdToRender = Object.keys(stockDataCache).find(id => stockDataCache[id].name === activeStockTab.textContent); if(stockIdToRender) renderStockDetails(stockIdToRender); } if (currentUserData && currentUserData.role === 'teacher') { adminNavLink.classList.remove('hidden'); adminDivider.classList.remove('hidden'); newNoticePostBtn.classList.remove('hidden'); } else { adminNavLink.classList.add('hidden'); adminDivider.classList.add('hidden'); newNoticePostBtn.classList.add('hidden'); }}}, (error) => console.error("Error in user data onSnapshot:", error));
        const transactionsQuery = query(collection(db, "users", userId, "transactions"), orderBy("date", "desc")); 
        unsubscribeTransactionsListener = onSnapshot(transactionsQuery, (querySnapshot) => { const transactions = []; querySnapshot.forEach((doc) => transactions.push({ id: doc.id, ...doc.data() })); if(currentUserData) currentUserData.transactions = transactions; if (document.getElementById('transactions').classList.contains('hidden') === false) renderTransactions(); }, (error) => console.error("Error in transactions onSnapshot:", error));
        const deedsQuery = query(collection(db, "users", userId, "deeds"), orderBy("date", "desc")); 
        unsubscribeDeedsListener = onSnapshot(deedsQuery, (querySnapshot) => { const deeds = []; querySnapshot.forEach((doc) => deeds.push({ id: doc.id, ...doc.data() })); if(currentUserData) currentUserData.deeds = deeds; if (document.getElementById('deeds').classList.contains('hidden') === false) renderDeeds(); }, (error) => console.error("Error in deeds onSnapshot:", error));
        const stocksQuery = query(collection(db, "stocks"));
        unsubscribeStockListeners['all'] = onSnapshot(stocksQuery, (querySnapshot) => { let updated = false; querySnapshot.forEach((docSnap) => { const stockId = docSnap.id; if (stockId === 'gold') return; const newStockData = { id: docSnap.id, ...docSnap.data() }; if (JSON.stringify(stockDataCache[stockId]) !== JSON.stringify(newStockData)) updated = true; stockDataCache[stockId] = newStockData; }); if (updated && document.getElementById('market').classList.contains('hidden') === false) loadAndRenderMarketTabs(); if (updated && document.getElementById('dashboard').classList.contains('hidden') === false) updateDashboardDisplay(); if (updated && document.getElementById('admin').classList.contains('hidden') === false && currentUserData?.role === 'teacher') loadAdminData(); }, (error) => console.error("Error in stocks onSnapshot:", error));
        const noticeQuery = query(collection(db, "boards", "notice", "posts"), orderBy("createdAt", "desc"));
        unsubscribeNoticePostsListener = onSnapshot(noticeQuery, (snapshot) => { if (document.getElementById('board').classList.contains('hidden') === false && !boardContentNoticeEl.classList.contains('hidden')) renderPosts('notice', snapshot); });
        const freeboardQuery = query(collection(db, "boards", "freeboard", "posts"), orderBy("createdAt", "desc"));
        unsubscribeFreeboardPostsListener = onSnapshot(freeboardQuery, (snapshot) => { if (document.getElementById('board').classList.contains('hidden') === false && !boardContentFreeboardEl.classList.contains('hidden')) renderPosts('freeboard', snapshot); });
        const shopItemsQuery = query(collection(db, "shopItems"), orderBy("createdAt", "desc"));
        unsubscribeShopItemsListener = onSnapshot(shopItemsQuery, (snapshot) => { if (document.getElementById('shopPage').classList.contains('hidden') === false) loadAndRenderShopItems(); if (document.getElementById('admin').classList.contains('hidden') === false && currentUserData?.role === 'teacher') loadAdminShopItems(); }, (error) => console.error("Error in shopItems onSnapshot:", error));
        // Realtime listener for auctions
        const auctionsQuery = query(collection(db, "auctions"), orderBy("deadline", "asc")); // Order by deadline to process older ones first
        unsubscribeAuctionsListener = onSnapshot(auctionsQuery, (snapshot) => {
            checkAndProcessEndedAuctions(); // Check whenever auction data changes
            const activeAuctionTab = document.querySelector('#auctionPage .auction-tab-button.active');
            if (document.getElementById('auctionPage').classList.contains('hidden') === false && activeAuctionTab) {
                loadAndRenderAuctionItems(activeAuctionTab.dataset.auctiontype);
            }
            if (document.getElementById('admin').classList.contains('hidden') === false && currentUserData?.role === 'teacher') {
                loadAdminAuctionItems();
            }
        }, (error) => console.error("Error in auctions onSnapshot:", error));
    }
    function detachRealtimeListeners() { /* ... */ 
        if (unsubscribePortfolioListener) unsubscribePortfolioListener(); if (unsubscribeTransactionsListener) unsubscribeTransactionsListener();
        if (unsubscribeDeedsListener) unsubscribeDeedsListener(); Object.values(unsubscribeStockListeners).forEach(unsub => unsub()); unsubscribeStockListeners = {};
        if (unsubscribeNoticePostsListener) unsubscribeNoticePostsListener(); if (unsubscribeFreeboardPostsListener) unsubscribeFreeboardPostsListener();
        if (unsubscribeShopItemsListener) unsubscribeShopItemsListener(); if (unsubscribeAuctionsListener) unsubscribeAuctionsListener();
        Object.values(auctionCountdownIntervals).forEach(clearInterval); auctionCountdownIntervals = {};
    }

    // --- Gemini API Call Function ---
    async function generateTextViaGemini(prompt) { /* ... */
        showAiModal("✨ AI가 열심히 생각하고 있어요..."); const apiKey = "AIzaSyC7_Gq4LIVVMv0hMD6qSwcTlGJcDSt-KgI"; const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`; const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
        try { const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) }); if (!response.ok) { let errorDetails = `API 요청 실패 (상태 코드: ${response.status})`; try { const errorResult = await response.json(); if (errorResult.error?.message) errorDetails += ` - ${errorResult.error.message}`; } catch (e) { /* Ignore */ } throw new Error(errorDetails); } const result = await response.json(); if (result.candidates?.[0]?.content?.parts?.[0]?.text) { updateAiModalContent(result.candidates[0].content.parts[0].text); } else { updateAiModalContent("AI가 응답을 생성하는 데 실패했어요. 응답 형식이 올바르지 않아요."); }} catch (error) { updateAiModalContent(`AI와 연결하는 데 문제가 발생했어요: ${error.message}.`); }
    }

    // --- Authentication Logic ---
    loginForm.addEventListener('submit', async (e) => { /* ... */ e.preventDefault(); const email = loginForm.email.value; const password = loginForm.password.value; authErrorEl.classList.add('hidden'); try { await signInWithEmailAndPassword(auth, email, password); } catch (error) { if (['auth/wrong-password', 'auth/user-not-found', 'auth/invalid-credential'].includes(error.code)) { try { const q = query(collection(db, "users"), where("email", "==", email)); const querySnapshot = await getDocs(q); if (!querySnapshot.empty) { const userDoc = querySnapshot.docs[0]; const userData = userDoc.data(); if (userData.temporaryPassword === password) { currentAuthUser = { uid: userDoc.id, email: userData.email, displayName: userData.name }; await loadCurrentUserData(userDoc.id); attachRealtimeListeners(userDoc.id); startStockUpdates(); if (currentUserData?.role === 'teacher') adminNavLink.classList.remove('hidden'); showSection('dashboard'); showInfoModal("임시 비밀번호 로그인 성공", "보안을 위해 즉시 '환경 설정'에서 새 비밀번호로 변경해주세요!"); loginForm.reset(); return; }}} catch (dbError) { console.error("Error checking temporary password:", dbError); }} authErrorEl.textContent = `로그인 실패: ${mapAuthErrorCodeToMessage(error.code)}`; authErrorEl.classList.remove('hidden'); }});
    registerForm.addEventListener('submit', async (e) => { /* ... */ e.preventDefault(); const name = registerForm.name.value; const email = registerForm.email.value; const password = registerForm.password.value; registerAuthErrorEl.classList.add('hidden'); try { const userCredential = await createUserWithEmailAndPassword(auth, email, password); const user = userCredential.user; await updateProfile(user, { displayName: name }); await setDoc(doc(db, "users", user.uid), { uid: user.uid, name: name, email: user.email, balance: 2000, portfolio: {}, role: 'student', createdAt: serverTimestamp() }); showInfoModal("회원가입 성공!", "만승 경제 교실에 오신 것을 환영합니다!"); } catch (error) { registerAuthErrorEl.textContent = `회원가입 실패: ${mapAuthErrorCodeToMessage(error.code)}`; registerAuthErrorEl.classList.remove('hidden'); }});
    function mapAuthErrorCodeToMessage(errorCode) { /* ... */ switch (errorCode) { case 'auth/invalid-email': return '유효하지 않은 이메일 주소입니다.'; case 'auth/user-disabled': return '사용 중지된 계정입니다.'; case 'auth/user-not-found': return '사용자를 찾을 수 없습니다.'; case 'auth/wrong-password': return '잘못된 비밀번호입니다.'; case 'auth/invalid-credential': return '이메일 또는 비밀번호가 잘못되었습니다.'; case 'auth/email-already-in-use': return '이미 사용 중인 이메일 주소입니다.'; case 'auth/weak-password': return '비밀번호는 6자 이상이어야 합니다.'; case 'auth/operation-not-allowed': return '이메일/비밀번호 로그인이 활성화되지 않았습니다.'; default: return errorCode; }}

    // --- Dashboard Logic ---
    function updateDashboardDisplay() { /* ... */ if (!currentUserData) return; currentBalanceEl.textContent = formatCurrency(currentUserData.balance || 0); let stockValue = 0; if (currentUserData.portfolio) { for (const stockId in currentUserData.portfolio) { const portfolioItem = currentUserData.portfolio[stockId]; const quantity = portfolioItem?.quantity || 0; const stockPrice = stockDataCache[stockId]?.price || 0; stockValue += quantity * stockPrice; }} totalAssetValueEl.textContent = formatCurrency((currentUserData.balance || 0) + stockValue); renderAssetAllocationChart(); }
    function renderAssetAllocationChart() { /* ... */ if (!currentUserData || !stockDataCache) return; const ctx = document.getElementById('assetAllocationChart').getContext('2d'); const labels = ['현금']; const data = [currentUserData.balance || 0]; const backgroundColors = ['rgba(54, 162, 235, 0.7)']; if (currentUserData.portfolio) { for (const stockId in currentUserData.portfolio) { const portfolioItem = currentUserData.portfolio[stockId]; const quantity = portfolioItem?.quantity || 0; if (quantity > 0 && stockDataCache[stockId]) { labels.push(stockDataCache[stockId].name); data.push(quantity * stockDataCache[stockId].price); backgroundColors.push(stockDataCache[stockId].color || getRandomColor()); }}} if (assetChartInstance) assetChartInstance.destroy(); if (data.every(val => val === 0) && data.length > 1 && data[0] === 0) { assetChartInstance = new Chart(ctx, {type: 'doughnut', data: {labels: ['자산 없음'], datasets: [{ data: [1], backgroundColor: ['rgba(200, 200, 200, 0.7)'] }]}, options: {responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' }, tooltip: { callbacks: { label: function(context) { return ' 자산을 늘려보세요!'; }}}}}}); } else { assetChartInstance = new Chart(ctx, {type: 'doughnut', data: {labels: labels, datasets: [{label: '자산 구성', data: data, backgroundColor: backgroundColors, borderColor: backgroundColors.map(color => color.replace('0.7', '1')), borderWidth: 1}]}, options: {responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' }, tooltip: { callbacks: {label: function(context) {let label = context.label || ''; if (label) { label += ': '; } if (context.parsed !== null) { label += formatCurrency(context.parsed); } return label;}}}}}}); }}
    function getRandomColor() { const r = Math.floor(Math.random() * 200); const g = Math.floor(Math.random() * 200); const b = Math.floor(Math.random() * 200); return `rgba(${r}, ${g}, ${b}, 0.7)`; }

    // --- Transfer Logic ---
    transferForm.addEventListener('submit', async (e) => { /* ... */ e.preventDefault(); if (!currentAuthUser || !currentUserData) { showInfoModal('오류', '로그인이 필요합니다.'); return; } const recipientEmail = recipientInput.value.trim(); const amount = parseInt(transferAmount.value); const memo = transferMemo.value || '계좌이체'; if (!recipientEmail) { showInfoModal('오류', '받는 사람 이메일을 입력해주세요.'); return; } if (recipientEmail === currentAuthUser.email) { showInfoModal('오류', '자기 자신에게 이체할 수 없습니다.'); return; } if (isNaN(amount) || amount <= 0) { showInfoModal('오류', '올바른 금액을 입력해주세요.'); return; } if (amount > currentUserData.balance) { showInfoModal('오류', '잔액이 부족합니다.'); return; } try { const q = query(collection(db, "users"), where("email", "==", recipientEmail)); const querySnapshot = await getDocs(q); if (querySnapshot.empty) { showInfoModal('오류', '받는 사람을 찾을 수 없습니다. 이메일을 확인해주세요.'); return; } const recipientDoc = querySnapshot.docs[0]; const recipientId = recipientDoc.id; const recipientData = recipientDoc.data(); await runTransaction(db, async (transaction) => { const senderDocRef = doc(db, "users", currentAuthUser.uid); const recipientDocRef = doc(db, "users", recipientId); const senderSnap = await transaction.get(senderDocRef); if (!senderSnap.exists() || senderSnap.data().balance < amount) throw new Error("잔액이 부족합니다."); transaction.update(senderDocRef, { balance: increment(-amount) }); transaction.update(recipientDocRef, { balance: increment(amount) }); transaction.set(doc(collection(db, "users", currentAuthUser.uid, "transactions")), {type: 'transfer_out', description: `${recipientData.name}(${recipientEmail})에게 송금 (${memo})`, amount: amount, date: serverTimestamp(), counterpartyName: recipientData.name, counterpartyEmail: recipientEmail}); transaction.set(doc(collection(db, "users", recipientId, "transactions")), {type: 'transfer_in', description: `${currentUserData.name}(${currentAuthUser.email})으로부터 입금 (${memo})`, amount: amount, date: serverTimestamp(), counterpartyName: currentUserData.name, counterpartyEmail: currentAuthUser.email}); }); showInfoModal('성공', `${recipientData.name}님에게 ${formatCurrency(amount)}을 보냈습니다.`); transferForm.reset(); } catch (error) { showInfoModal('이체 실패', `이체 중 오류가 발생했습니다: ${error.message}`); }});

    // --- Market Logic ---
    async function initializeStockData() { /* ... */ const initialStocks = { 'hanul': { name: '한울반 주식', price: 1000, history: [1000], color: 'rgba(59, 130, 246, 0.7)', minFluctuation: -50, maxFluctuation: 100, type: 'normal' }, 'usan': { name: '우산 주식', price: 1000, history: [1000], color: 'rgba(16, 185, 129, 0.7)', minFluctuation: -50, maxFluctuation: 100, type: 'normal' }, 'haetsal': { name: '햇살 주식', price: 1000, history: [1000], color: 'rgba(245, 158, 11, 0.7)', minFluctuation: -50, maxFluctuation: 100, type: 'normal' }}; for (const stockId in initialStocks) { const stockDocRef = doc(db, "stocks", stockId); const docSnap = await getDoc(stockDocRef); if (!docSnap.exists()) { await setDoc(stockDocRef, initialStocks[stockId]); } else { const existingData = docSnap.data(); if (initialStocks[stockId].type === 'normal' && (existingData.minFluctuation === undefined || existingData.maxFluctuation === undefined)) { await updateDoc(stockDocRef, {minFluctuation: existingData.minFluctuation || initialStocks[stockId].minFluctuation, maxFluctuation: existingData.maxFluctuation || initialStocks[stockId].maxFluctuation, type: existingData.type || initialStocks[stockId].type});}}} try { const goldSnap = await getDoc(doc(db, "stocks", "gold")); if (goldSnap.exists()) await deleteDoc(doc(db, "stocks", "gold")); } catch (error) { console.warn("Could not remove 'gold' stock doc:", error); }}
    async function updateNormalStockPrices() { /* ... */ for (const stockId in stockDataCache) { const stock = stockDataCache[stockId]; if (stock.type === 'normal') { const minFluctuation = stock.minFluctuation || -50; const maxFluctuation = stock.maxFluctuation || 100; const change = Math.floor(Math.random() * (maxFluctuation - minFluctuation + 1)) + minFluctuation; let newPrice = stock.price + change; if (newPrice < 100) newPrice = 100; const newHistory = [...(stock.history || [])]; newHistory.push(newPrice); if (newHistory.length > MAX_HISTORY_LENGTH) newHistory.shift(); try { await updateDoc(doc(db, "stocks", stockId), { price: newPrice, history: newHistory }); } catch (error) { console.error(`Error updating ${stock.name}:`, error); }}}}
    function startStockUpdates() { /* ... */ initializeStockData().then(() => { if (stockUpdateInterval) clearInterval(stockUpdateInterval); updateNormalStockPrices(); stockUpdateInterval = setInterval(updateNormalStockPrices, 60000); });}
    function stopStockUpdates() { if (stockUpdateInterval) clearInterval(stockUpdateInterval); stockUpdateInterval = null; }
    async function loadAndRenderMarketTabs() { /* ... */ if (!currentAuthUser) return; marketTabsContainer.innerHTML = '<p class="text-sm text-stone-500">주식 정보 로딩 중...</p>'; if (Object.keys(stockDataCache).filter(id => id !== 'gold').length === 0) { try { const querySnapshot = await getDocs(query(collection(db, "stocks"))); querySnapshot.forEach((docSnap) => { if (docSnap.id !== 'gold') stockDataCache[docSnap.id] = { id: docSnap.id, ...docSnap.data() }; }); } catch (error) { marketTabsContainer.innerHTML = '<p class="text-sm text-red-500">주식 정보를 불러오는데 실패했습니다.</p>'; return; }} marketTabsContainer.innerHTML = ''; const stockIds = Object.keys(stockDataCache).filter(id => id !== 'gold'); if (stockIds.length === 0) { marketTabsContainer.innerHTML = '<p class="text-sm text-stone-500">거래 가능한 주식이 없습니다.</p>'; marketContentContainer.innerHTML = ''; return; } stockIds.sort((a,b) => (stockDataCache[a].name > stockDataCache[b].name) ? 1 : -1); stockIds.forEach((stockId, index) => { const stock = stockDataCache[stockId]; const tabButton = document.createElement('button'); tabButton.className = `tab-button py-3 px-1 border-b-2 border-transparent text-stone-500 hover:text-teal-600 hover:border-teal-600 whitespace-nowrap text-sm font-medium`; tabButton.textContent = stock.name; tabButton.onclick = () => { document.querySelectorAll('#market .tab-button').forEach(btn => btn.classList.remove('active')); tabButton.classList.add('active'); renderStockDetails(stockId); }; marketTabsContainer.appendChild(tabButton); if (index === 0) { tabButton.classList.add('active'); renderStockDetails(stockId); }});}
    function renderStockDetails(stockId, filterType = 'day') { /* ... */ if (!currentUserData || !stockDataCache[stockId]) { marketContentContainer.innerHTML = '<p class="text-center text-stone-500">주식 정보를 불러올 수 없습니다.</p>'; return; } const stock = stockDataCache[stockId]; const portfolioItem = currentUserData.portfolio?.[stockId]; const userHoldings = portfolioItem?.quantity || 0; const avgBuyPrice = portfolioItem?.avgBuyPrice || 0; const holdingValue = userHoldings * stock.price; let roiDisplay = 'N/A'; if (userHoldings > 0 && avgBuyPrice > 0) { const roi = ((stock.price - avgBuyPrice) / avgBuyPrice) * 100; roiDisplay = `${roi.toFixed(2)}%`; } marketContentContainer.innerHTML = `<div class="bg-white p-6 rounded-xl shadow-lg"><div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4"><div><h3 class="text-2xl font-bold text-teal-700">${stock.name}</h3><p class="text-4xl font-bold" style="color: ${stock.color || getRandomColor()}">${formatCurrency(stock.price)}</p></div><div class="text-right mt-2 md:mt-0"><p class="text-sm text-stone-500">나의 보유량: <span class="font-semibold">${userHoldings} 주</span></p><p class="text-sm text-stone-500">평가액: <span class="font-semibold">${formatCurrency(holdingValue)}</span></p><p class="text-sm text-stone-500">평균 매수가: <span class="font-semibold">${userHoldings > 0 ? formatCurrency(avgBuyPrice) : 'N/A'}</span></p><p class="text-sm text-stone-500">평가 수익률: <span class="font-semibold ${roiDisplay !== 'N/A' && parseFloat(roiDisplay) >= 0 ? 'text-green-600' : 'text-red-600'}">${roiDisplay}</span></p><button id="aiStockAnalysisBtn-${stockId}" data-stock-id="${stockId}" class="mt-2 bg-purple-500 hover:bg-purple-600 text-white font-semibold py-2 px-3 rounded-lg text-sm transition-transform hover:scale-105">✨ AI 종목 분석</button></div></div><div class="mb-4 flex justify-center space-x-2"><button data-stock-id="${stockId}" data-filter="day" class="time-filter-btn ${filterType === 'day' ? 'active' : ''} bg-stone-200 hover:bg-stone-300 text-stone-700 text-xs py-1 px-3 rounded">1시간</button><button data-stock-id="${stockId}" data-filter="week" class="time-filter-btn ${filterType === 'week' ? 'active' : ''} bg-stone-200 hover:bg-stone-300 text-stone-700 text-xs py-1 px-3 rounded">1일</button><button data-stock-id="${stockId}" data-filter="month" class="time-filter-btn ${filterType === 'month' ? 'active' : ''} bg-stone-200 hover:bg-stone-300 text-stone-700 text-xs py-1 px-3 rounded">전체</button></div><div class="chart-container h-64 md:h-80 mb-6"><canvas id="stockChart-${stockId}"></canvas></div><div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div><h4 class="text-lg font-semibold text-teal-600 mb-2">매수 (사기)</h4><form id="buyForm-${stockId}" class="space-y-3"><input type="hidden" name="stockId" value="${stockId}"><div><label for="buyQuantity-${stockId}" class="block text-sm font-medium text-stone-700">수량</label><input type="number" id="buyQuantity-${stockId}" name="quantity" min="1" required class="mt-1 block w-full p-2 border border-stone-300 rounded-md shadow-sm focus:ring-teal-500 focus:border-teal-500"></div><p class="text-sm">예상 금액: <span id="buyEstimate-${stockId}">0 원</span></p><button type="submit" class="w-full bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-2 px-3 rounded-lg">매수</button></form></div><div><h4 class="text-lg font-semibold text-red-600 mb-2">매도 (팔기)</h4><form id="sellForm-${stockId}" class="space-y-3"><input type="hidden" name="stockId" value="${stockId}"><div><label for="sellQuantity-${stockId}" class="block text-sm font-medium text-stone-700">수량</label><input type="number" id="sellQuantity-${stockId}" name="quantity" min="1" max="${userHoldings}" ${userHoldings === 0 ? 'disabled' : ''} required class="mt-1 block w-full p-2 border border-stone-300 rounded-md shadow-sm focus:ring-red-500 focus:border-red-500"></div><p class="text-sm">예상 금액: <span id="sellEstimate-${stockId}">0 원</span></p><button type="submit" class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-3 rounded-lg" ${userHoldings === 0 ? 'disabled' : ''}>매도</button></form></div></div></div>`; let historyToDisplay = stock.history || []; if (filterType === 'day') historyToDisplay = historyToDisplay.slice(-60); else if (filterType === 'week') historyToDisplay = historyToDisplay.slice(- (60 * 24) > MAX_HISTORY_LENGTH ? -MAX_HISTORY_LENGTH : -(60*24) ); else if (filterType === 'month') historyToDisplay = historyToDisplay.slice(-MAX_HISTORY_LENGTH); renderStockChart(stockId, historyToDisplay, stock.color || getRandomColor()); const buyQuantityInput = document.getElementById(`buyQuantity-${stockId}`); const buyEstimateEl = document.getElementById(`buyEstimate-${stockId}`); buyQuantityInput.addEventListener('input', () => { const quantity = parseInt(buyQuantityInput.value) || 0; buyEstimateEl.textContent = formatCurrency(quantity * stock.price); }); const sellQuantityInput = document.getElementById(`sellQuantity-${stockId}`); const sellEstimateEl = document.getElementById(`sellEstimate-${stockId}`); if (sellQuantityInput) sellQuantityInput.addEventListener('input', () => { const quantity = parseInt(sellQuantityInput.value) || 0; sellEstimateEl.textContent = formatCurrency(quantity * stock.price); }); document.getElementById(`buyForm-${stockId}`).addEventListener('submit', handleBuyStock); const sellForm = document.getElementById(`sellForm-${stockId}`); if (sellForm) sellForm.addEventListener('submit', handleSellStock); document.getElementById(`aiStockAnalysisBtn-${stockId}`).addEventListener('click', handleAiStockAnalysis); document.querySelectorAll(`#marketContent .time-filter-btn`).forEach(button => button.addEventListener('click', (e) => renderStockDetails(e.target.dataset.stockId, e.target.dataset.filter)));}
    async function handleAiStockAnalysis(e) { /* ... */ const stockId = e.target.dataset.stockId; const stockName = stockDataCache[stockId].name; const prompt = `초등학생을 위한 ${stockName}에 대한 짧고 재미있는 이야기를 만들어줘. 예를 들어, ${stockName}이 왜 오르거나 내릴 수 있는지, 또는 ${stockName}과 관련된 재미있는 상상을 덧붙여서 이야기해줘. 긍정적이고 희망찬 내용으로 작성해줘. 100자 이내로 짧게 부탁해.`; generateTextViaGemini(prompt); }
    function renderStockChart(stockId, historyData, color) { /* ... */ const ctx = document.getElementById(`stockChart-${stockId}`).getContext('2d'); if (stockChartInstances[stockId]) stockChartInstances[stockId].destroy(); if (!historyData || historyData.length === 0) { ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height); ctx.textAlign = "center"; ctx.fillStyle = "#888"; ctx.fillText("가격 기록이 없습니다.", ctx.canvas.width / 2, ctx.canvas.height / 2); return; } const labels = historyData.map((_, index) => `${index + 1}`); stockChartInstances[stockId] = new Chart(ctx, {type: 'line', data: {labels: labels, datasets: [{label: `${stockDataCache[stockId].name} 가격 변동`, data: historyData, borderColor: color.replace('0.7', '1'), backgroundColor: color, tension: 0.1, fill: true,}]}, options: {responsive: true, maintainAspectRatio: false, scales: {y: { beginAtZero: false, ticks: { callback: function(value) { return formatCurrency(value); }}}, x: { ticks: { maxRotation: 0, minRotation: 0, autoSkip: true, maxTicksLimit: 10 }}}, plugins: { legend: { display: false }, tooltip: { callbacks: {label: function(context) { return formatCurrency(context.parsed.y); }, title: function(context) { return `시점 ${context[0].label}`; }}}}}});}
    async function handleBuyStock(e) { /* ... */ e.preventDefault(); if (!currentAuthUser || !currentUserData) { showInfoModal('오류', '로그인이 필요합니다.'); return; } const stockId = e.target.stockId.value; const quantityToBuy = parseInt(e.target.quantity.value); const stock = stockDataCache[stockId]; if (!stock || typeof stock.price !== 'number') { showInfoModal('오류', '주식 가격 정보를 가져올 수 없습니다.'); return; } const cost = quantityToBuy * stock.price; if (isNaN(quantityToBuy) || quantityToBuy <= 0) { showInfoModal('오류', '올바른 수량을 입력해주세요.'); return; } if (cost > currentUserData.balance) { showInfoModal('오류', '잔액이 부족합니다.'); return; } try { const userDocRef = doc(db, "users", currentAuthUser.uid); await runTransaction(db, async (transaction) => { const userSnap = await transaction.get(userDocRef); if (!userSnap.exists()) throw new Error("사용자 정보를 찾을 수 없습니다."); const userData = userSnap.data(); if (userData.balance < cost) throw new Error("잔액이 부족합니다. (트랜잭션 확인)"); const currentPortfolio = userData.portfolio || {}; const currentStockInfo = currentPortfolio[stockId] || { quantity: 0, avgBuyPrice: 0, totalInvested: 0, totalShares: 0 }; const newTotalShares = (currentStockInfo.totalShares || 0) + quantityToBuy; const newTotalInvested = (currentStockInfo.totalInvested || 0) + cost; const newAvgBuyPrice = newTotalShares > 0 ? parseFloat((newTotalInvested / newTotalShares).toFixed(2)) : 0; const updatedStockData = {quantity: (currentStockInfo.quantity || 0) + quantityToBuy, avgBuyPrice: newAvgBuyPrice, totalInvested: newTotalInvested, totalShares: newTotalShares}; const updates = { balance: increment(-cost), [`portfolio.${stockId}`]: updatedStockData }; transaction.update(userDocRef, updates); transaction.set(doc(collection(db, "users", currentAuthUser.uid, "transactions")), {type: 'buy', description: `${stock.name} ${quantityToBuy}주 매수`, amount: cost, stockId: stockId, quantity: quantityToBuy, pricePerStock: stock.price, date: serverTimestamp()}); }); showInfoModal('매수 성공', `${stock.name} ${quantityToBuy}주를 ${formatCurrency(cost)}에 매수했습니다.`); e.target.reset(); document.getElementById(`buyEstimate-${stockId}`).textContent = '0 원'; } catch (error) { showInfoModal('매수 실패', `매수 중 오류 발생: ${error.message}`); }}
    async function handleSellStock(e) { /* ... */ e.preventDefault(); if (!currentAuthUser || !currentUserData) { showInfoModal('오류', '로그인이 필요합니다.'); return; } const stockId = e.target.stockId.value; const quantityToSell = parseInt(e.target.quantity.value); const stock = stockDataCache[stockId]; if (!stock || typeof stock.price !== 'number') { showInfoModal('오류', '주식 가격 정보를 가져올 수 없습니다.'); return; } const portfolioItem = currentUserData.portfolio?.[stockId]; const currentHoldings = portfolioItem?.quantity || 0; const avgBuyPrice = portfolioItem?.avgBuyPrice || 0; if (isNaN(quantityToSell) || quantityToSell <= 0) { showInfoModal('오류', '올바른 수량을 입력해주세요.'); return; } if (quantityToSell > currentHoldings) { showInfoModal('오류', '보유 수량이 부족합니다.'); return; } const income = quantityToSell * stock.price; const profitOrLoss = (stock.price - avgBuyPrice) * quantityToSell; try { const userDocRef = doc(db, "users", currentAuthUser.uid); await runTransaction(db, async (transaction) => { const userSnap = await transaction.get(userDocRef); if (!userSnap.exists()) throw new Error("사용자 정보를 찾을 수 없습니다."); const currentPortfolio = userSnap.data().portfolio || {}; const currentStockInfo = currentPortfolio[stockId]; if (!currentStockInfo || currentStockInfo.quantity < quantityToSell) throw new Error("보유 수량이 부족합니다. (트랜잭션 확인)"); const newQuantity = currentStockInfo.quantity - quantityToSell; const updates = { balance: increment(income) }; if (newQuantity === 0) updates[`portfolio.${stockId}`] = deleteField(); else updates[`portfolio.${stockId}`] = { ...currentStockInfo, quantity: newQuantity }; transaction.update(userDocRef, updates); transaction.set(doc(collection(db, "users", currentAuthUser.uid, "transactions")), {type: 'sell', description: `${stock.name} ${quantityToSell}주 매도 (손익: ${formatCurrency(profitOrLoss)})`, amount: income, stockId: stockId, quantity: quantityToSell, pricePerStock: stock.price, profitOrLoss: profitOrLoss, date: serverTimestamp()}); }); showInfoModal('매도 성공', `${stock.name} ${quantityToSell}주를 ${formatCurrency(income)}에 매도했습니다. (손익: ${formatCurrency(profitOrLoss)})`); e.target.reset(); document.getElementById(`sellEstimate-${stockId}`).textContent = '0 원'; } catch (error) { showInfoModal('매도 실패', `매도 중 오류 발생: ${error.message}`); }}

    // --- Deeds Logic ---
    deedForm.addEventListener('submit', async (e) => { /* ... */
        e.preventDefault();
        if (!currentAuthUser || !currentUserData) { showInfoModal('오류', '로그인이 필요합니다.'); return; }
        const description = deedDescriptionEl.value.trim();
        if (!description) { showInfoModal('오류', '선행 내용을 입력해주세요.'); return; }
        const deedsColRefQuery = query(collection(db, "users", currentAuthUser.uid, "deeds"), orderBy("date", "desc"), limit(1));
        const lastDeedSnapshot = await getDocs(deedsColRefQuery);
        if (!lastDeedSnapshot.empty) {
            const lastDeedData = lastDeedSnapshot.docs[0].data();
            if (lastDeedData.date && isSameDay(lastDeedData.date, new Date()) && lastDeedData.status !== 'rewrite') {
                showInfoModal('알림', '오늘은 이미 선행을 등록했어요! 내일 다시 시도해주세요.');
                return;
            }
        }
        const reward = 1000;
        try {
            await addDoc(collection(db, "users", currentAuthUser.uid, "deeds"), {
                description: description,
                reward: reward,
                status: 'pending',
                authorUid: currentAuthUser.uid,
                authorName: currentUserData.name,
                date: serverTimestamp()
            });
            showInfoModal('선행 등록 완료', '관리자 승인 후 보상이 지급됩니다.');
            deedForm.reset();
        } catch (error) {
            showInfoModal('선행 등록 실패', '선행 등록 중 오류가 발생했습니다.');
        }
    });
    function renderDeeds() { /* ... */
        if (!currentUserData || !currentUserData.deeds) { deedListEl.innerHTML = '<li class="p-3 bg-stone-50 rounded-md border border-stone-200 text-center text-stone-500">선행 기록을 불러오는 중...</li>'; return; }
        deedListEl.innerHTML = '';
        if (currentUserData.deeds.length === 0) { deedListEl.innerHTML = '<li class="p-3 bg-stone-50 rounded-md border border-stone-200 text-center text-stone-500">등록된 선행이 없습니다.</li>'; return; }
        currentUserData.deeds.forEach(deed => {
            const li = document.createElement('li');
            li.className = 'p-4 bg-white rounded-lg shadow-sm border border-stone-200 flex justify-between items-center';
            const deedTextDiv = document.createElement('div');
            deedTextDiv.innerHTML = `<p class="font-medium text-stone-700">${deed.description}</p><p class="text-xs text-stone-500">${formatDate(deed.date)} - ${formatCurrency(deed.reward)}</p>`;
            const buttonsDiv = document.createElement('div');
            buttonsDiv.className = 'flex flex-col sm:flex-row items-end space-y-2 sm:space-y-0 sm:space-x-2';
            const statusSpan = document.createElement('span');
            let statusClass = 'text-amber-600 bg-amber-100';
            let statusText = '승인대기';
            if (deed.status === 'approved') { statusClass = 'text-green-600 bg-green-100'; statusText = '보상완료'; }
            else if (deed.status === 'rewrite') { statusClass = 'text-red-600 bg-red-100'; statusText = '재작성 필요'; }
            statusSpan.className = `text-xs font-semibold ${statusClass} px-2 py-1 rounded-full mb-2 sm:mb-0`;
            statusSpan.textContent = statusText;
            const aiButton = document.createElement('button');
            aiButton.className = 'bg-purple-500 hover:bg-purple-600 text-white font-semibold py-1 px-2 rounded-lg text-xs transition-transform hover:scale-105';
            aiButton.innerHTML = '✨ 이야기 확장';
            aiButton.onclick = () => handleAiDeedStory(deed.description);
            buttonsDiv.appendChild(statusSpan);
            if (deed.status === 'rewrite') {
                const editBtn = document.createElement('button');
                editBtn.className = 'bg-yellow-500 hover:bg-yellow-600 text-white font-semibold py-1 px-2 rounded-lg text-xs';
                editBtn.textContent = '수정';
                editBtn.onclick = () => editDeed(deed);
                buttonsDiv.appendChild(editBtn);
            }
            buttonsDiv.appendChild(aiButton);
            li.appendChild(deedTextDiv);
            li.appendChild(buttonsDiv);
            deedListEl.appendChild(li);
        });
    }
    async function handleAiDeedStory(deedDescription) { /* ... */ const prompt = `초등학생이 작성한 "${deedDescription}"라는 선행 내용이 있습니다. 이 선행을 바탕으로, 어린이가 이해하기 쉽고 긍정적인 칭찬과 함께 이야기를 조금 더 구체적이고 재미있게 확장해주세요. 예를 들어, 그 선행이 다른 사람에게 어떤 좋은 영향을 주었는지, 또는 그 선행을 통해 무엇을 배웠는지 등을 포함할 수 있습니다. 150자 이내로 작성해주세요.`; generateTextViaGemini(prompt); }
    async function editDeed(deed) {
        const newDesc = prompt('새 선행 내용을 입력하세요', deed.description);
        if (!newDesc) return;
        try {
            await updateDoc(doc(db, 'users', currentAuthUser.uid, 'deeds', deed.id), {
                description: newDesc,
                status: 'pending',
                updatedAt: serverTimestamp()
            });
            showInfoModal('수정 완료', '선행 내용이 수정되었습니다. 다시 승인을 기다려주세요.');
        } catch (error) {
            showInfoModal('오류', '선행 수정 중 오류가 발생했습니다.');
        }
    }

    // --- AI Chat Logic ---
    function appendChatMessage(role, text) {
        const div = document.createElement('div');
        div.className = role === 'user'
            ? 'self-end bg-blue-100 text-sm p-2 rounded-lg max-w-xs'
            : 'self-start bg-purple-100 text-sm p-2 rounded-lg max-w-xs';
        div.textContent = text;
        chatMessagesEl.appendChild(div);
        chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight;
    }

    async function generateChatReply(message) {
        const apiKey = "AIzaSyC7_Gq4LIVVMv0hMD6qSwcTlGJcDSt-KgI";
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
        const payload = { contents: [{ role: 'user', parts: [{ text: message }] }] };
        try {
            const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            if (!response.ok) throw new Error(`API 요청 실패 (상태 코드: ${response.status})`);
            const result = await response.json();
            return result.candidates?.[0]?.content?.parts?.[0]?.text || 'AI 응답을 생성하지 못했어요.';
        } catch (error) {
            return `AI 오류: ${error.message}`;
        }
    }

    if (chatForm) {
        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const userMsg = chatInput.value.trim();
            if (!userMsg) return;
            appendChatMessage('user', userMsg);
            chatInput.value = '';
            const prompt = `너는 고민을 들어주고 힘을 주는 친구야. 다음 사용자의 고민이나 질문에 대해 따뜻하게 응원하며 답변해 줘. 사용자의 내용: "${userMsg}"`;
            const reply = await generateChatReply(prompt);
            appendChatMessage('ai', reply);
        });
    }

    // --- Transactions Logic ---
    function renderTransactions() { /* ... */ if (!currentUserData || !currentUserData.transactions) { transactionListEl.innerHTML = '<tr><td colspan="5" class="text-center py-10 text-stone-500">거래 내역을 불러오는 중...</td></tr>'; return; } transactionListEl.innerHTML = ''; const filterValue = transactionFilterEl.value; const filteredTransactions = currentUserData.transactions.filter(tx => (filterValue === 'all' || tx.type === filterValue)); if (filteredTransactions.length === 0) { transactionListEl.innerHTML = '<tr><td colspan="5" class="text-center py-10 text-stone-500">해당 종류의 거래 내역이 없습니다.</td></tr>'; return; } filteredTransactions.forEach(tx => { const tr = document.createElement('tr'); let amountDisplay = ''; let balanceAfterTxDisplay = 'N/A'; switch (tx.type) { case 'transfer_in': amountDisplay = `<span class="text-sky-600 font-semibold">+${formatCurrency(tx.amount)}</span>`; break; case 'transfer_out': amountDisplay = `<span class="text-red-600 font-semibold">-${formatCurrency(tx.amount)}</span>`; break; case 'buy': amountDisplay = `<span class="text-red-600">${formatCurrency(tx.amount)} (${tx.quantity}주)</span>`; break; case 'sell': amountDisplay = `<span class="text-sky-600">+${formatCurrency(tx.amount)} (${tx.quantity}주)</span>`; if (tx.profitOrLoss !== undefined) amountDisplay += ` (손익: ${formatCurrency(tx.profitOrLoss)})`; break; case 'deed': amountDisplay = `<span class="text-amber-600 font-semibold">+${formatCurrency(tx.amount)}</span>`; break; case 'admin_credit': amountDisplay = `<span class="text-blue-600 font-semibold">+${formatCurrency(tx.amount)}</span>`; break; case 'admin_debit': amountDisplay = `<span class="text-orange-600 font-semibold">-${formatCurrency(tx.amount)}</span>`; break; case 'auction_bid': amountDisplay = `<span class="text-red-700 font-semibold">-${formatCurrency(tx.amount)}</span>`; break; case 'auction_bid_cancel': amountDisplay = `<span class="text-green-700 font-semibold">+${formatCurrency(tx.amount)}</span>`; break; case 'auction_refund_lost': amountDisplay = `<span class="text-sky-700 font-semibold">+${formatCurrency(tx.amount)}</span>`; break; default: amountDisplay = formatCurrency(tx.amount); } tr.innerHTML = `<td class="px-6 py-4 whitespace-nowrap text-sm text-stone-500">${formatDate(tx.date)}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-stone-900">${getTransactionTypeKorean(tx.type)}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-stone-500">${tx.description}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-right">${amountDisplay}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-right text-stone-500">${balanceAfterTxDisplay}</td>`; transactionListEl.appendChild(tr); });}
    function getTransactionTypeKorean(type) { /* ... */ switch (type) { case 'transfer_in': return '입금'; case 'transfer_out': return '출금'; case 'buy': return '주식매수'; case 'sell': return '주식매도'; case 'deed': return '선행보상'; case 'admin_credit': return '관리자 지급'; case 'admin_debit': return '관리자 회수'; case 'auction_bid': return '경매 입찰'; case 'auction_bid_cancel': return '경매 입찰 취소'; case 'auction_refund_lost': return '경매 낙찰실패 환불'; default: return type; }}
    transactionFilterEl.addEventListener('change', renderTransactions);

    // --- Settings Logic ---
    function loadUserSettings() { if (currentUserData) userNameInput.value = currentUserData.name || ''; }
    settingsForm.addEventListener('submit', async (e) => { /* ... */ e.preventDefault(); if (!currentAuthUser) { showInfoModal("오류", "로그인이 필요합니다."); return; } const newName = userNameInput.value.trim(); if (!newName) { showInfoModal("오류", "이름을 입력해주세요."); return; } try { await updateProfile(currentAuthUser, { displayName: newName }); await updateDoc(doc(db, "users", currentAuthUser.uid), { name: newName }); showInfoModal("성공", "이름이 성공적으로 변경되었습니다."); loggedInUserDisplay.textContent = newName; } catch (error) { showInfoModal("오류", `이름 변경 중 오류 발생: ${error.message}`); }});
    changePasswordForm.addEventListener('submit', async (e) => { /* ... */ e.preventDefault(); if (!currentAuthUser) { showInfoModal("오류", "로그인이 필요합니다."); return; } const currentPasswordVal = document.getElementById('currentPassword').value; const newPasswordVal = document.getElementById('newPassword').value; const confirmNewPasswordVal = document.getElementById('confirmNewPassword').value; if (!currentPasswordVal || !newPasswordVal || !confirmNewPasswordVal) { showInfoModal("오류", "모든 비밀번호 필드를 입력해주세요."); return; } if (newPasswordVal !== confirmNewPasswordVal) { showInfoModal("오류", "새 비밀번호와 확인 비밀번호가 일치하지 않습니다."); return; } if (newPasswordVal.length < 6) { showInfoModal("오류", "새 비밀번호는 6자 이상이어야 합니다."); return; } try { const credential = EmailAuthProvider.credential(currentAuthUser.email, currentPasswordVal); await reauthenticateWithCredential(currentAuthUser, credential); await updatePassword(currentAuthUser, newPasswordVal); await updateDoc(doc(db, "users", currentAuthUser.uid), { temporaryPassword: deleteField() }); showInfoModal("성공", "비밀번호가 성공적으로 변경되었습니다."); changePasswordForm.reset(); } catch (error) { showInfoModal("오류", `비밀번호 변경 중 오류 발생: ${mapAuthErrorCodeToMessage(error.code)}`); }});

    // --- Admin Logic ---
    async function loadAdminData() { /* ... */ if (!currentAuthUser || !currentUserData || currentUserData.role !== 'teacher') { adminStudentListEl.innerHTML = '<li>관리자 권한이 필요합니다.</li>'; return; } adminStudentListEl.innerHTML = '<li>학생 정보 로딩 중...</li>'; try { const usersSnapshot = await getDocs(collection(db, "users")); adminStudentListEl.innerHTML = ''; usersSnapshot.forEach(docSnap => { const student = docSnap.data(); const studentId = docSnap.id; const li = document.createElement('li'); li.className = "flex justify-between items-center py-1"; li.innerHTML = `<div class="flex-grow"><span class="font-medium">${student.name}</span> (${student.email})<br><span class="text-xs text-stone-500">UID: ${studentId.substring(0,8)}... - 잔액: ${formatCurrency(student.balance)}</span></div><div class="flex space-x-1"><button data-studentid="${studentId}" data-studentname="${student.name}" class="admin-edit-name-btn bg-yellow-500 hover:bg-yellow-600 text-white text-xs py-1 px-2 rounded">이름변경</button><button data-studentid="${studentId}" data-studentname="${student.name}" data-studentemail="${student.email}" class="admin-reset-password-btn bg-pink-500 hover:bg-pink-600 text-white text-xs py-1 px-2 rounded">비번초기화</button><button data-studentid="${studentId}" data-studentname="${student.name}" data-currentbalance="${student.balance}" class="admin-adjust-balance-btn bg-blue-500 hover:bg-blue-600 text-white text-xs py-1 px-2 rounded">잔액조정</button><button data-studentid="${studentId}" data-studentname="${student.name}" class="admin-view-details-btn bg-purple-500 hover:bg-purple-600 text-white text-xs py-1 px-2 rounded">상세보기</button></div>`; adminStudentListEl.appendChild(li); }); document.querySelectorAll('.admin-adjust-balance-btn').forEach(b => b.addEventListener('click', (e) => showAdminAdjustBalanceModal(e.target.dataset.studentid, e.target.dataset.studentname, parseFloat(e.target.dataset.currentbalance)))); document.querySelectorAll('.admin-edit-name-btn').forEach(b => b.addEventListener('click', (e) => showAdminEditNameModal(e.target.dataset.studentid, e.target.dataset.studentname))); document.querySelectorAll('.admin-reset-password-btn').forEach(b => b.addEventListener('click', (e) => showAdminResetPasswordModal(e.target.dataset.studentid, e.target.dataset.studentname, e.target.dataset.studentemail))); document.querySelectorAll('.admin-view-details-btn').forEach(b => b.addEventListener('click', (e) => loadAndShowAdminUserDetail(e.target.dataset.studentid, e.target.dataset.studentname))); } catch (error) { adminStudentListEl.innerHTML = '<li>학생 정보 로드 실패</li>'; } const adminStockSelect = document.getElementById('adminStockSelect'); adminStockSelect.innerHTML = '<option value="">-- 주식 선택 --</option>'; adminStockFluctuationSettingsEl.innerHTML = ''; Object.keys(stockDataCache).filter(id => id !== 'gold').sort((a,b) => (stockDataCache[a].name > stockDataCache[b].name) ? 1 : -1).forEach(stockId => { const stock = stockDataCache[stockId]; const option = document.createElement('option'); option.value = stockId; option.textContent = stock.name; adminStockSelect.appendChild(option); if (stock.type === 'normal') { const settingDiv = document.createElement('div'); settingDiv.className = 'mt-2 p-2 border rounded border-stone-300'; settingDiv.innerHTML = `<p class="text-sm font-medium text-stone-700">${stock.name} 변동폭:</p><div class="flex space-x-2 mt-1"><input type="number" id="minFluctuation-${stockId}" value="${stock.minFluctuation || -50}" placeholder="최소" class="w-1/2 p-1 border rounded text-sm"><input type="number" id="maxFluctuation-${stockId}" value="${stock.maxFluctuation || 100}" placeholder="최대" class="w-1/2 p-1 border rounded text-sm"></div><button data-stockid="${stockId}" class="save-fluctuation-btn mt-2 bg-green-500 hover:bg-green-600 text-white text-xs py-1 px-2 rounded w-full">변동폭 저장 (${stock.name})</button>`; adminStockFluctuationSettingsEl.appendChild(settingDiv); }}); document.querySelectorAll('.save-fluctuation-btn').forEach(b => b.addEventListener('click', async (e) => { const stockId = e.target.dataset.stockid; const minFluctuation = parseInt(document.getElementById(`minFluctuation-${stockId}`).value); const maxFluctuation = parseInt(document.getElementById(`maxFluctuation-${stockId}`).value); if (isNaN(minFluctuation) || isNaN(maxFluctuation) || minFluctuation >= maxFluctuation) { showInfoModal("오류", "유효한 변동폭을 입력하세요 (최소 < 최대)."); return; } try { await updateDoc(doc(db, "stocks", stockId), { minFluctuation, maxFluctuation }); showInfoModal("성공", `${stockDataCache[stockId].name} 변동폭이 저장되었습니다.`); } catch (error) { showInfoModal("오류", "변동폭 저장 중 오류 발생."); }}));}
    adminConfirmAdjustBalanceBtn.addEventListener('click', async () => { /* ... */ if (!studentIdToAdjust) return; const amount = parseInt(adminAdjustmentAmountInput.value); const reason = adminAdjustmentReasonInput.value.trim() || "관리자 잔액 조정"; if (isNaN(amount)) { showInfoModal("오류", "유효한 조정 금액을 입력하세요."); return; } try { await updateDoc(doc(db, "users", studentIdToAdjust), { balance: increment(amount) }); await addDoc(collection(db, "users", studentIdToAdjust, "transactions"), {type: amount >= 0 ? 'admin_credit' : 'admin_debit', description: reason, amount: Math.abs(amount), date: serverTimestamp()}); showInfoModal("성공", "학생 잔액이 성공적으로 조정되었습니다."); closeAdminAdjustBalanceModal(); } catch (error) { showInfoModal("오류", `잔액 조정 중 오류 발생: ${error.message}`); }});
    adminConfirmEditNameBtn.addEventListener('click', async () => { /* ... */ if (!studentIdToEditName) return; const newName = adminNewStudentNameInput.value.trim(); if (!newName) { showInfoModal("오류", "새로운 이름을 입력하세요."); return; } try { await updateDoc(doc(db, "users", studentIdToEditName), { name: newName }); if (currentAuthUser && studentIdToEditName === currentAuthUser.uid) { await updateProfile(currentAuthUser, { displayName: newName }); loggedInUserDisplay.textContent = newName; } showInfoModal("성공", "학생 이름이 성공적으로 변경되었습니다."); closeAdminEditNameModal(); loadAdminData(); } catch (error) { showInfoModal("오류", `이름 변경 중 오류 발생: ${error.message}`); }});
    adminConfirmResetPasswordBtn.addEventListener('click', async () => { /* ... */ if (!studentIdToResetPassword) return; const newTemporaryPassword = adminNewTemporaryPasswordInput.value.trim(); if (!newTemporaryPassword || newTemporaryPassword.length < 6) { showInfoModal("오류", "임시 비밀번호는 6자 이상이어야 합니다."); return; } try { await updateDoc(doc(db, "users", studentIdToResetPassword), { temporaryPassword: newTemporaryPassword }); showInfoModal("성공", `학생의 임시 비밀번호가 "${newTemporaryPassword}"로 설정되었습니다. 학생에게 전달해주세요.`); closeAdminResetPasswordModal(); } catch (error) { showInfoModal("오류", `임시 비밀번호 설정 중 오류 발생: ${error.message}`); }});
    async function loadAndShowAdminUserDetail(studentId, studentName) { /* ... */ adminUserDetailNameEl.textContent = `${studentName} 학생 상세 정보`; adminUserPortfolioListEl.innerHTML = '<li>포트폴리오 정보 로딩 중...</li>'; adminUserTransactionListEl.innerHTML = '<tr><td colspan="4" class="text-center py-4">거래 내역 로딩 중...</td></tr>'; adminUserDeedListEl.innerHTML = '<li>선행 기록 로딩 중...</li>'; showSection('adminUserDetail'); try { const userDocSnap = await getDoc(doc(db, "users", studentId)); if (userDocSnap.exists()) { const userData = userDocSnap.data(); adminUserPortfolioListEl.innerHTML = ''; if (userData.portfolio && Object.keys(userData.portfolio).length > 0) { for (const stockId in userData.portfolio) { const item = userData.portfolio[stockId]; const stockInfo = stockDataCache[stockId]; if (!stockInfo) continue; const li = document.createElement('li'); li.className = "flex justify-between items-center"; li.innerHTML = `<span>${stockInfo.name}: ${item.quantity}주 (평단가: ${formatCurrency(item.avgBuyPrice || 0)})</span><button data-studentid="${studentId}" data-stockid="${stockId}" data-stockname="${stockInfo.name}" class="admin-reset-stock-btn bg-red-500 hover:bg-red-600 text-white text-xs py-0.5 px-1.5 rounded ml-2">초기화</button>`; adminUserPortfolioListEl.appendChild(li); } document.querySelectorAll('.admin-reset-stock-btn').forEach(b => b.addEventListener('click', (e) => showAdminResetStockModal(e.target.dataset.studentid, studentName, e.target.dataset.stockname, e.target.dataset.stockid))); } else adminUserPortfolioListEl.innerHTML = '<li>보유 주식 없음</li>'; } else adminUserPortfolioListEl.innerHTML = '<li>사용자 정보 없음</li>'; const transactionsSnapshot = await getDocs(query(collection(db, "users", studentId, "transactions"), orderBy("date", "desc"))); adminUserTransactionListEl.innerHTML = ''; if (transactionsSnapshot.empty) adminUserTransactionListEl.innerHTML = '<tr><td colspan="4" class="text-center py-4">거래 내역 없음</td></tr>'; else transactionsSnapshot.forEach(docSnap => { const tx = docSnap.data(); const tr = document.createElement('tr'); tr.innerHTML = `<td class="px-3 py-2 whitespace-nowrap">${formatDate(tx.date)}</td><td class="px-3 py-2">${getTransactionTypeKorean(tx.type)}</td><td class="px-3 py-2">${tx.description}</td><td class="px-3 py-2 text-right">${formatCurrency(tx.amount)} ${tx.quantity ? `(${tx.quantity}주)`: ''}</td>`; adminUserTransactionListEl.appendChild(tr); }); const deedsSnapshot = await getDocs(query(collection(db, "users", studentId, "deeds"), orderBy("date", "desc"))); adminUserDeedListEl.innerHTML = ''; if (deedsSnapshot.empty) adminUserDeedListEl.innerHTML = '<li>선행 기록 없음</li>'; else deedsSnapshot.forEach(docSnap => { const deed = docSnap.data(); const li = document.createElement('li'); li.innerHTML = `<strong>${formatDate(deed.date)}:</strong> ${deed.description} (+${formatCurrency(deed.reward)})`; adminUserDeedListEl.appendChild(li); }); } catch (error) { showInfoModal("오류", "학생 상세 정보 로드 실패"); }}
    adminConfirmResetStockBtn.addEventListener('click', async () => { /* ... */ if (!studentIdToResetStock || !stockIdToReset) return; try { await updateDoc(doc(db, "users", studentIdToResetStock), { [`portfolio.${stockIdToReset}`]: deleteField() }); showInfoModal("성공", "해당 주식 보유 정보가 초기화되었습니다."); closeAdminResetStockModal(); const studentName = adminUserDetailNameEl.textContent.split(" ")[0]; loadAndShowAdminUserDetail(studentIdToResetStock, studentName); } catch (error) { showInfoModal("오류", "주식 정보 초기화 중 오류 발생"); }});
    document.getElementById('randomizePricesBtn').addEventListener('click', async () => { /* ... */ if (!currentAuthUser || !currentUserData || currentUserData.role !== 'teacher') { showInfoModal("오류", "관리자 권한이 필요합니다."); return; } showInfoModal("진행 중", "주가 변경 중..."); try { for (const stockId in stockDataCache) { const stock = stockDataCache[stockId]; if (stock.type === 'normal') { const minFluctuation = stock.minFluctuation || -50; const maxFluctuation = stock.maxFluctuation || 100; const change = Math.floor(Math.random() * (maxFluctuation - minFluctuation + 1)) + minFluctuation; let newPrice = stock.price + change; if (newPrice < 100) newPrice = 100; const newHistory = [...(stock.history || [])]; newHistory.push(newPrice); if (newHistory.length > MAX_HISTORY_LENGTH) newHistory.shift(); await updateDoc(doc(db, "stocks", stockId), { price: newPrice, history: newHistory }); }} showInfoModal('알림', '일반 주식 가격이 임의로 변경되었습니다.'); } catch (error) { showInfoModal("오류", "주가 변경 중 오류 발생"); }});
    document.getElementById('adminUpdatePriceBtn').addEventListener('click', async () => { /* ... */ if (!currentAuthUser || !currentUserData || currentUserData.role !== 'teacher') { showInfoModal("오류", "관리자 권한이 필요합니다."); return; } const stockId = document.getElementById('adminStockSelect').value; const newPriceStr = document.getElementById('adminNewPrice').value; if (!stockId) { showInfoModal("오류", "가격을 변경할 주식을 선택하세요."); return; } if (!newPriceStr) { showInfoModal("오류", "새로운 가격을 입력하세요."); return; } const newPrice = parseInt(newPriceStr); if (isNaN(newPrice) || newPrice < 0) { showInfoModal("오류", "유효한 가격을 입력하세요."); return; } try { const stock = stockDataCache[stockId]; if (!stock) { showInfoModal("오류", "선택한 주식 정보를 찾을 수 없습니다."); return; } const newHistory = [...(stock.history || [])]; newHistory.push(newPrice); if (newHistory.length > MAX_HISTORY_LENGTH) newHistory.shift(); await updateDoc(doc(db, "stocks", stockId), { price: newPrice, history: newHistory }); showInfoModal('성공', `${stock.name}의 가격이 ${formatCurrency(newPrice)}으로 변경되었습니다.`); document.getElementById('adminNewPrice').value = ''; } catch (error) { showInfoModal("오류", "주가 변경 중 오류 발생"); }});

    // --- Ranking Logic ---
    rankingTabButtons.forEach(button => { /* ... */ button.addEventListener('click', (e) => { rankingTabButtons.forEach(btn => {btn.classList.remove('active', 'border-teal-600', 'text-teal-600'); btn.classList.add('border-transparent', 'text-stone-500');}); e.target.classList.add('active', 'border-teal-600', 'text-teal-600'); e.target.classList.remove('border-transparent', 'text-stone-500'); const rankingType = e.target.dataset.rankingtype; document.querySelectorAll('.ranking-content-area').forEach(area => area.classList.add('hidden')); document.getElementById(`rankingContent${rankingType.charAt(0).toUpperCase() + rankingType.slice(1)}`).classList.remove('hidden'); loadRankingData(rankingType); });});
    async function loadRankingData(type) { /* ... */ if (!currentAuthUser) return; if (type === 'totalAsset') { totalAssetRankingListEl.innerHTML = '<li class="text-center text-stone-500 py-4">총 자산 랭킹 불러오는 중...</li>'; try { const usersSnapshot = await getDocs(collection(db, "users")); const userAssets = []; usersSnapshot.forEach(docSnap => { const user = docSnap.data(); let totalStockValue = 0; if (user.portfolio) for (const stockId in user.portfolio) { const portfolioItem = user.portfolio[stockId]; const stockInfo = stockDataCache[stockId]; if (portfolioItem && stockInfo) totalStockValue += (portfolioItem.quantity || 0) * (stockInfo.price || 0); } userAssets.push({ name: user.name, totalAsset: (user.balance || 0) + totalStockValue }); }); userAssets.sort((a, b) => b.totalAsset - a.totalAsset); totalAssetRankingListEl.innerHTML = ''; userAssets.slice(0, 10).forEach((user, index) => { const li = document.createElement('li'); li.className = "flex justify-between items-center p-2 border-b"; li.innerHTML = `<span>${index + 1}. ${user.name}</span> <span class="font-semibold">${formatCurrency(user.totalAsset)}</span>`; totalAssetRankingListEl.appendChild(li); }); if (userAssets.length === 0) totalAssetRankingListEl.innerHTML = '<li class="text-center text-stone-500 py-4">랭킹 정보가 없습니다.</li>'; } catch (error) { totalAssetRankingListEl.innerHTML = '<li class="text-center text-red-500 py-4">랭킹 정보를 불러오는데 실패했습니다.</li>'; }} else if (type === 'roi') { roiRankingListEl.innerHTML = '<li class="text-center text-stone-500 py-4">수익률 랭킹 불러오는 중...</li>'; try { const usersSnapshot = await getDocs(collection(db, "users")); const userRois = []; usersSnapshot.forEach(docSnap => { const user = docSnap.data(); let totalPortfolioCurrentValue = 0; let totalPortfolioCostBasis = 0; if (user.portfolio) for (const stockId in user.portfolio) { const portfolioItem = user.portfolio[stockId]; const stockInfo = stockDataCache[stockId]; if (portfolioItem && stockInfo && portfolioItem.quantity > 0 && portfolioItem.avgBuyPrice > 0) { totalPortfolioCostBasis += portfolioItem.avgBuyPrice * portfolioItem.quantity; totalPortfolioCurrentValue += stockInfo.price * portfolioItem.quantity; }} let roi = 0; if (totalPortfolioCostBasis > 0) roi = ((totalPortfolioCurrentValue - totalPortfolioCostBasis) / totalPortfolioCostBasis) * 100; userRois.push({ name: user.name, roi: roi }); }); userRois.sort((a, b) => b.roi - a.roi); roiRankingListEl.innerHTML = ''; userRois.slice(0, 10).forEach((user, index) => { const li = document.createElement('li'); li.className = "flex justify-between items-center p-2 border-b"; li.innerHTML = `<span>${index + 1}. ${user.name}</span> <span class="font-semibold ${user.roi >= 0 ? 'text-green-600' : 'text-red-600'}">${user.roi.toFixed(2)}%</span>`; roiRankingListEl.appendChild(li); }); if (userRois.length === 0) roiRankingListEl.innerHTML = '<li class="text-center text-stone-500 py-4">랭킹 정보가 없습니다.</li>'; } catch (error) { roiRankingListEl.innerHTML = '<li class="text-center text-red-500 py-4">수익률 랭킹을 불러오는데 실패했습니다.</li>'; }}}
    
    // --- Board Logic ---
    boardTabButtons.forEach(button => { /* ... */ button.addEventListener('click', (e) => { boardTabButtons.forEach(btn => {btn.classList.remove('active', 'border-teal-600', 'text-teal-600'); btn.classList.add('border-transparent', 'text-stone-500');}); e.target.classList.add('active', 'border-teal-600', 'text-teal-600'); e.target.classList.remove('border-transparent', 'text-stone-500'); const boardType = e.target.dataset.boardtype; document.querySelectorAll('.board-content-area').forEach(area => area.classList.add('hidden')); document.getElementById(`boardContent${boardType.charAt(0).toUpperCase() + boardType.slice(1)}`).classList.remove('hidden'); loadAndRenderBoard(boardType); });});
    newNoticePostBtn.addEventListener('click', () => showPostModal('notice'));
    newFreePostBtn.addEventListener('click', () => showPostModal('freeboard'));
    postForm.addEventListener('submit', async (e) => { /* ... */ e.preventDefault(); if (!currentAuthUser) { showInfoModal("오류", "글을 작성하려면 로그인이 필요합니다."); return; } const boardType = postBoardTypeInput.value; const postId = postEditIdInput.value; const title = postTitleInput.value.trim(); const content = postContentInput.value.trim(); if (!title || !content) { showInfoModal("오류", "제목과 내용을 모두 입력해주세요."); return; } const postData = { title: title, content: content, authorUid: currentAuthUser.uid, authorName: currentUserData.name || currentAuthUser.email, updatedAt: serverTimestamp() }; try { if (postId) { await updateDoc(doc(db, "boards", boardType, "posts", postId), postData); showInfoModal("성공", "글이 수정되었습니다."); } else { postData.createdAt = serverTimestamp(); await addDoc(collection(db, "boards", boardType, "posts"), postData); showInfoModal("성공", "글이 작성되었습니다."); } closePostModal(); } catch (error) { showInfoModal("오류", "글을 저장하는 중 오류가 발생했습니다."); }});
    async function loadAndRenderBoard(boardType) { /* ... */ const listEl = boardType === 'notice' ? noticePostListEl : freePostListEl; listEl.innerHTML = `<li class="text-center text-stone-500 py-4">${boardType === 'notice' ? '공지사항' : '게시글'}을 불러오는 중...</li>`; const querySnapshot = await getDocs(query(collection(db, "boards", boardType, "posts"), orderBy("createdAt", "desc"))); renderPosts(boardType, querySnapshot);}
    function renderPosts(boardType, snapshot) { /* ... */ const listEl = boardType === 'notice' ? noticePostListEl : freePostListEl; listEl.innerHTML = ''; if (snapshot.empty) { listEl.innerHTML = `<li class="text-center text-stone-500 py-4">${boardType === 'notice' ? '공지사항이' : '게시글이'} 없습니다.</li>`; return; } snapshot.forEach(docSnap => { const post = { id: docSnap.id, ...docSnap.data() }; const li = document.createElement('li'); li.className = "bg-white p-4 rounded-lg shadow-sm border border-stone-200"; li.innerHTML = `<div class="flex justify-between items-start"><div><h4 class="text-lg font-semibold text-teal-700">${post.title}</h4><p class="text-xs text-stone-500">작성자: ${post.authorName} | 날짜: ${formatDate(post.createdAt)}</p></div>${ (currentUserData && (currentUserData.role === 'teacher' || post.authorUid === currentAuthUser.uid)) ? `<div class="flex space-x-2"><button data-boardtype="${boardType}" data-postid="${post.id}" class="edit-post-btn text-xs bg-yellow-500 hover:bg-yellow-600 text-white py-1 px-2 rounded">수정</button><button data-boardtype="${boardType}" data-postid="${post.id}" class="delete-post-btn text-xs bg-red-500 hover:bg-red-600 text-white py-1 px-2 rounded">삭제</button></div>` : '' }</div><p class="mt-2 text-stone-700 post-content">${post.content.substring(0, 100)}${post.content.length > 100 ? '...' : ''}</p>${post.content.length > 100 ? `<button data-boardtype="${boardType}" data-postid="${post.id}" class="view-full-post-btn text-xs text-blue-500 hover:underline mt-1">더보기</button>` : ''}`; listEl.appendChild(li); }); listEl.addEventListener('click', async (e) => { const target = e.target; const boardType = target.dataset.boardtype; const postId = target.dataset.postid; if (target.classList.contains('edit-post-btn')) { const postDoc = await getDoc(doc(db, "boards", boardType, "posts", postId)); if (postDoc.exists()) showPostModal(boardType, { id: postDoc.id, ...postDoc.data() }); } else if (target.classList.contains('delete-post-btn')) { if (confirm("정말로 이 글을 삭제하시겠습니까?")) { try { await deleteDoc(doc(db, "boards", boardType, "posts", postId)); showInfoModal("성공", "글이 삭제되었습니다."); } catch (error) { showInfoModal("오류", "글 삭제 중 오류 발생"); }}} else if (target.classList.contains('view-full-post-btn')) { const postDoc = await getDoc(doc(db, "boards", boardType, "posts", postId)); if (postDoc.exists()) { const postData = postDoc.data(); showInfoModal(postData.title, postData.content); }}}); }

    // --- Shop Logic ---
    async function loadAndRenderShopItems() {
        if (!currentAuthUser) {
            shopItemListEl.innerHTML = '<p class="text-stone-500 col-span-full text-center">상점 물품을 보려면 로그인이 필요합니다.</p>';
            return;
        }
        shopItemListEl.innerHTML = '<p class="text-stone-500 col-span-full text-center">상점 물품을 불러오는 중입니다...</p>';
        try {
            const q = query(collection(db, "shopItems"), orderBy("createdAt", "desc"));
            const querySnapshot = await getDocs(q);
            shopItemListEl.innerHTML = '';
            if (querySnapshot.empty) {
                shopItemListEl.innerHTML = '<p class="text-stone-500 col-span-full text-center">판매 중인 물품이 아직 없습니다.</p>';
                return;
            }
            querySnapshot.forEach(docSnap => {
                const item = { id: docSnap.id, ...docSnap.data() };
                const itemCard = document.createElement('div');
                itemCard.className = 'shop-item-card bg-white p-5 rounded-xl shadow-lg flex flex-col justify-between';
                let imageHtml = `<div class="w-full h-40 bg-stone-200 rounded-md flex items-center justify-center mb-3"><span class="text-stone-400 text-sm">이미지 없음</span></div>`;
                if (item.imageUrl) {
                    imageHtml = `<img src="${item.imageUrl}" alt="${item.itemName}" class="w-full h-40 object-cover rounded-md mb-3" onerror="this.parentElement.innerHTML='<div class=\'w-full h-40 bg-stone-200 rounded-md flex items-center justify-center mb-3\'><span class=\'text-stone-400 text-sm\'>이미지 로드 실패</span></div>';">`;
                }
                itemCard.innerHTML = `
                    <div>
                        ${imageHtml}
                        <h4 class="text-xl font-semibold text-purple-700 mb-1">${item.itemName}</h4>
                        <p class="text-2xl font-bold text-orange-600 mb-2">${formatCurrency(item.price)}</p>
                        <p class="text-sm text-stone-600 mb-3 h-12 overflow-hidden">${item.description || '특별한 설명이 없어요.'}</p>
                    </div>
                    <div class="mt-auto flex items-center space-x-2">
                        <input type="number" min="1" value="1" class="purchase-qty w-20 p-2 border rounded-md">
                        <button data-itemid="${item.id}" data-itemname="${item.itemName}" data-price="${item.price}" data-deposit="${item.depositAccount}" class="direct-purchase-btn flex-1 bg-orange-500 hover:bg-orange-600 text-white font-bold py-2 px-4 rounded-lg transition-transform hover:scale-105">구매</button>
                    </div>
                `;
                shopItemListEl.appendChild(itemCard);
            });
            document.querySelectorAll('.direct-purchase-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const btn = e.target;
                    const qtyInput = btn.closest('.shop-item-card').querySelector('.purchase-qty');
                    const qty = parseInt(qtyInput.value) || 1;
                    const item = {
                        id: btn.dataset.itemid,
                        itemName: btn.dataset.itemname,
                        price: parseFloat(btn.dataset.price),
                        depositAccount: btn.dataset.deposit
                    };
                    handleDirectPurchase(item, qty);
                });
            });
        } catch (error) {
            console.error("Error loading shop items for user:", error);
            shopItemListEl.innerHTML = '<p class="text-red-500 col-span-full text-center">상점 물품을 불러오는 데 실패했습니다.</p>';
        }
    }
    adminAddNewShopItemBtn.addEventListener('click', () => showShopItemFormModal());
    shopItemForm.addEventListener('submit', async (e) => { /* ... */ e.preventDefault(); if (!currentAuthUser || !currentUserData || currentUserData.role !== 'teacher') { showInfoModal("오류", "물품을 등록/수정할 권한이 없습니다."); return; } const itemId = shopItemEditIdInput.value; const itemName = shopItemNameInput.value.trim(); const price = parseFloat(shopItemPriceInput.value); const depositAccount = shopItemDepositAccountInput.value.trim(); const description = shopItemDescriptionInput.value.trim(); const imageUrl = shopItemImageUrlInput.value.trim(); if (!itemName || isNaN(price) || price < 0 || !depositAccount) { showInfoModal("오류", "물품 이름, 가격, 입금 계좌는 필수 항목입니다."); return; } const itemData = { itemName, price, depositAccount, description: description || "", imageUrl: imageUrl || "", updatedAt: serverTimestamp(), sellerUid: currentAuthUser.uid, sellerName: currentUserData.name }; try { if (itemId) { const itemRef = doc(db, "shopItems", itemId); await updateDoc(itemRef, itemData); showInfoModal("성공", "상점 물품이 수정되었습니다."); } else { itemData.createdAt = serverTimestamp(); await addDoc(collection(db, "shopItems"), itemData); showInfoModal("성공", "새 상점 물품이 등록되었습니다."); } closeShopItemFormModal(); loadAdminShopItems(); } catch (error) { console.error("Error saving shop item:", error); showInfoModal("오류", "상점 물품 저장 중 오류가 발생했습니다."); }});

    async function loadAdminPurchases() {
        if (!currentAuthUser || !currentUserData || currentUserData.role !== 'teacher') {
            adminPurchaseListEl.innerHTML = '<p class="text-stone-500">구매 내역은 관리자만 볼 수 있습니다.</p>';
            return;
        }
        adminPurchaseListEl.innerHTML = '<p class="text-stone-500">구매 내역을 불러오는 중...</p>';
        try {
            const q = query(collectionGroup(db, 'transactions'), where('type', '==', 'shop_purchase'), orderBy('date', 'desc'));
            const snapshot = await getDocs(q);
            adminPurchaseListEl.innerHTML = '';
            if (snapshot.empty) {
                adminPurchaseListEl.innerHTML = '<p class="text-stone-500">최근 구매가 없습니다.</p>';
                return;
            }
            const transactions = [];
            snapshot.forEach(docSnap => {
                const parentUid = docSnap.ref.parent.parent.id;
                transactions.push({ id: docSnap.id, userUid: parentUid, ...docSnap.data() });
            });
            for (const txn of transactions) {
                if (!txn.buyerName) {
                    if (userNameCache[txn.userUid]) {
                        txn.buyerName = userNameCache[txn.userUid];
                    } else {
                        try {
                            const userDoc = await getDoc(doc(db, 'users', txn.userUid));
                            txn.buyerName = userDoc.exists() ? (userDoc.data().name || txn.userUid) : txn.userUid;
                        } catch (e) {
                            txn.buyerName = txn.userUid;
                        }
                        userNameCache[txn.userUid] = txn.buyerName;
                    }
                }
                const div = document.createElement('div');
                div.className = 'bg-stone-50 p-3 rounded-md border border-stone-200 flex justify-between items-start';
                div.innerHTML = `<div><p class="font-medium">${txn.buyerName}</p><p class="text-sm text-stone-700">${txn.description}</p><p class="text-xs text-stone-500">${formatDate(txn.date)} - ${formatCurrency(txn.amount)}</p></div>`;
                adminPurchaseListEl.appendChild(div);
            }
        } catch (error) {
            console.error('Error loading purchases for admin:', error);
            adminPurchaseListEl.innerHTML = '<p class="text-red-500">구매 내역 로드 실패.</p>';
        }
    }
    async function loadAdminShopItems() { /* ... */ if (!currentAuthUser || !currentUserData || currentUserData.role !== 'teacher') { adminShopItemListEl.innerHTML = '<p class="text-stone-500">상점 물품 관리는 관리자만 가능합니다.</p>'; return; } adminShopItemListEl.innerHTML = '<p class="text-stone-500">상점 물품 목록을 불러오는 중...</p>'; try { const q = query(collection(db, "shopItems"), orderBy("createdAt", "desc")); const querySnapshot = await getDocs(q); adminShopItemListEl.innerHTML = ''; if (querySnapshot.empty) { adminShopItemListEl.innerHTML = '<p class="text-stone-500">등록된 상점 물품이 없습니다.</p>'; return; } querySnapshot.forEach(docSnap => { const item = { id: docSnap.id, ...docSnap.data() }; const itemDiv = document.createElement('div'); itemDiv.className = "bg-stone-50 p-3 rounded-md border border-stone-200 flex justify-between items-center"; itemDiv.innerHTML = `<div><p class="font-medium text-purple-600">${item.itemName} - ${formatCurrency(item.price)}</p><p class="text-xs text-stone-500">계좌: ${item.depositAccount}</p><p class="text-xs text-stone-400">등록자: ${item.sellerName || item.sellerUid.substring(0,8)}</p></div><div class="space-x-2"><button data-itemid="${item.id}" class="admin-edit-shop-item-btn bg-yellow-500 hover:bg-yellow-600 text-white text-xs py-1 px-2 rounded">수정</button><button data-itemid="${item.id}" class="admin-delete-shop-item-btn bg-red-500 hover:bg-red-600 text-white text-xs py-1 px-2 rounded">삭제</button></div>`; adminShopItemListEl.appendChild(itemDiv); }); document.querySelectorAll('.admin-edit-shop-item-btn').forEach(button => { button.addEventListener('click', async (e) => { const itemId = e.target.dataset.itemid; const itemDoc = await getDoc(doc(db, "shopItems", itemId)); if (itemDoc.exists()) { showShopItemFormModal({ id: itemDoc.id, ...itemDoc.data() }); }}); }); document.querySelectorAll('.admin-delete-shop-item-btn').forEach(button => { button.addEventListener('click', async (e) => { const itemId = e.target.dataset.itemid; if (confirm("정말로 이 물품을 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다.")) { try { await deleteDoc(doc(db, "shopItems", itemId)); showInfoModal("성공", "상점 물품이 삭제되었습니다."); loadAdminShopItems(); } catch (error) { console.error("Error deleting shop item:", error); showInfoModal("오류", "물품 삭제 중 오류 발생."); }}}); }); } catch (error) { console.error("Error loading shop items for admin:", error); adminShopItemListEl.innerHTML = '<p class="text-red-500">상점 물품 목록 로드 실패.</p>'; }}

    // --- Auction Logic ---
    auctionTabButtons.forEach(button => {
        button.addEventListener('click', (e) => {
            auctionTabButtons.forEach(btn => { btn.classList.remove('active', 'border-teal-600', 'text-teal-600'); btn.classList.add('border-transparent', 'text-stone-500'); });
            e.target.classList.add('active', 'border-teal-600', 'text-teal-600'); e.target.classList.remove('border-transparent', 'text-stone-500');
            const auctionType = e.target.dataset.auctiontype;
            document.querySelectorAll('.auction-content-area').forEach(area => area.classList.add('hidden'));
            document.getElementById(`auctionContent${auctionType.charAt(0).toUpperCase() + auctionType.slice(1)}`).classList.remove('hidden');
            loadAndRenderAuctionItems(auctionType);
        });
    });

    function getCountdownText(deadline, status) {
        if (status !== 'active') {
            switch(status) {
                case 'ended_sold': return '<span class="text-green-600 font-semibold">낙찰됨</span>';
                case 'ended_unsold': return '<span class="text-red-600 font-semibold">유찰됨</span>';
                case 'cancelled': return '<span class="text-stone-600 font-semibold">취소됨</span>';
                default: return '<span class="text-stone-500 font-semibold">종료됨</span>';
            }
        }
        const now = new Date().getTime();
        const deadlineTime = deadline.toDate().getTime();
        const distance = deadlineTime - now;

        if (distance < 0) return '<span class="countdown-ended">경매 종료</span>';
        
        const days = Math.floor(distance / (1000 * 60 * 60 * 24));
        const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((distance % (1000 * 60)) / 1000);

        let text = "";
        if (days > 0) text += `${days}일 `;
        if (hours > 0 || days > 0) text += `${hours}시간 `;
        if (minutes > 0 || hours > 0 || days > 0) text += `${minutes}분 `;
        text += `${seconds}초 남음`;
        
        let colorClass = 'countdown-timer';
        if (distance < 60 * 60 * 1000) colorClass = 'countdown-soon'; // Less than 1 hour
        return `<span class="${colorClass}">${text}</span>`;
    }

    async function loadAndRenderAuctionItems(type = 'active') {
        if (!currentAuthUser) {
            const targetEl = type === 'active' ? auctionContentActiveEl : auctionContentPastEl;
            targetEl.innerHTML = '<p class="text-stone-500 col-span-full text-center">경매 물품을 보려면 로그인이 필요합니다.</p>';
            return;
        }
        const targetEl = type === 'active' ? auctionContentActiveEl : auctionContentPastEl;
        targetEl.innerHTML = `<p class="text-stone-500 col-span-full text-center">${type === 'active' ? '진행중인' : '지난'} 경매 물품을 불러오는 중입니다...</p>`;
        
        try {
            const q = query(collection(db, "auctions"), orderBy("deadline", "asc"));
            const querySnapshot = await getDocs(q);
            targetEl.innerHTML = '';

            const items = [];
            querySnapshot.forEach(docSnap => {
                const item = { id: docSnap.id, ...docSnap.data() };
                if ((type === 'active' && item.status === 'active') || (type !== 'active' && item.status !== 'active')) {
                    items.push(item);
                }
            });

            if (items.length === 0) {
                targetEl.innerHTML = `<p class="text-stone-500 col-span-full text-center">${type === 'active' ? '진행중인' : '지난'} 경매 물품이 없습니다.</p>`;
                return;
            }

            if (type !== 'active') {
                items.sort((a, b) => b.deadline.toDate() - a.deadline.toDate());
            }

            items.forEach(item => {
                const itemCard = document.createElement('div');
                itemCard.className = 'auction-item-card bg-white p-5 rounded-xl shadow-lg flex flex-col justify-between';
                
                let imageHtml = `<div class="w-full h-48 bg-stone-200 rounded-md flex items-center justify-center mb-3"><span class="text-stone-400 text-sm">이미지 없음</span></div>`;
                if (item.imageUrl) {
                    imageHtml = `<img src="${item.imageUrl}" alt="${item.itemName}" class="w-full h-48 object-cover rounded-md mb-3" onerror="this.parentElement.innerHTML='<div class=\\'w-full h-48 bg-stone-200 rounded-md flex items-center justify-center mb-3\\'><span class=\\'text-stone-400 text-sm\\'>이미지 로드 실패</span></div>';">`;
                }

                const countdownId = `countdown-${item.id}`;
                if (auctionCountdownIntervals[item.id]) clearInterval(auctionCountdownIntervals[item.id]);

                itemCard.innerHTML = `
                    <div>
                        ${imageHtml}
                        <h4 class="text-xl font-semibold text-indigo-700 mb-1">${item.itemName}</h4>
                        <p class="text-sm text-stone-500 mb-1">시작가: ${formatCurrency(item.startPrice)}</p>
                        <p class="text-lg font-bold text-green-600 mb-1">현재가: ${formatCurrency(item.currentBid)}</p>
                        <p class="text-sm text-stone-500 mb-2">최고 입찰자: <span class="font-medium">${item.highestBidderName || '없음'}</span></p>
                        <p class="text-sm text-stone-500 mb-3">마감까지: <span id="${countdownId}">${getCountdownText(item.deadline, item.status)}</span></p>
                        <p class="text-xs text-stone-600 mb-3 h-10 overflow-hidden">${item.description || '물품 설명이 없습니다.'}</p>
                    </div>
                    <div class="mt-auto space-y-2">
                        ${item.status === 'active' ? `
                            <button data-auctionid="${item.id}" data-itemname="${item.itemName}" data-currentbid="${item.currentBid}" class="place-bid-btn w-full bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg">입찰하기</button>
                            ${item.highestBidderUid === currentAuthUser.uid ? `<button data-auctionid="${item.id}" class="cancel-bid-btn w-full bg-yellow-500 hover:bg-yellow-600 text-white font-semibold py-2 px-3 rounded-lg text-sm">내 입찰 취소</button>` : ''}
                        ` : `<p class="text-center font-semibold ${item.status === 'ended_sold' ? 'text-green-700' : item.status === 'cancelled' ? 'text-stone-700' : 'text-red-700'}">${item.status === 'ended_sold' ? `낙찰자: ${item.highestBidderName || '정보 없음'}` : item.status === 'cancelled' ? '취소됨' : '유찰됨'}</p>`}
                    </div>
                `;
                targetEl.appendChild(itemCard);

                if (item.status === 'active') {
                    const countdownEl = document.getElementById(countdownId);
                    auctionCountdownIntervals[item.id] = setInterval(() => {
                        const text = getCountdownText(item.deadline, item.status);
                        countdownEl.innerHTML = text;
                        if (text.includes("경매 종료")) {
                            clearInterval(auctionCountdownIntervals[item.id]);
                            checkAndProcessEndedAuctions(); // Re-check and process if this one just ended
                        }
                    }, 1000);
                }
            });

            document.querySelectorAll('.place-bid-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const auctionId = e.target.dataset.auctionid;
                    const itemName = e.target.dataset.itemname;
                    const currentBid = parseFloat(e.target.dataset.currentbid);
                    showPlaceBidModal(auctionId, itemName, currentBid);
                });
            });
            document.querySelectorAll('.cancel-bid-btn').forEach(button => {
                button.addEventListener('click', (e) => handleCancelBid(e.target.dataset.auctionid));
            });

        } catch (error) {
            console.error(`Error loading ${type} auction items:`, error);
            targetEl.innerHTML = `<p class="text-red-500 col-span-full text-center">${type === 'active' ? '진행중인' : '지난'} 경매 물품을 불러오는 데 실패했습니다.</p>`;
        }
    }
    
    adminAddNewAuctionItemBtn.addEventListener('click', () => showAuctionItemFormModal());

    auctionItemForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        if (!currentAuthUser || !currentUserData || currentUserData.role !== 'teacher') {
            showInfoModal("오류", "경매 물품을 등록/수정할 권한이 없습니다."); return;
        }
        const itemId = auctionItemEditIdInput.value;
        const itemName = auctionItemNameInput.value.trim();
        const startPrice = parseFloat(auctionItemStartPriceInput.value);
        const deadlineStr = auctionItemDeadlineInput.value;
        const description = auctionItemDescriptionInput.value.trim();
        const imageUrl = auctionItemImageUrlInput.value.trim();

        if (!itemName || isNaN(startPrice) || startPrice < 0 || !deadlineStr) {
            showInfoModal("오류", "물품 이름, 시작가, 마감 기한은 필수 항목입니다."); return;
        }
        const deadline = Timestamp.fromDate(new Date(deadlineStr));
        if (deadline.toDate() <= new Date()) {
            showInfoModal("오류", "마감 기한은 현재 시간 이후여야 합니다."); return;
        }

        const itemData = {
            itemName, startPrice, currentBid: startPrice, deadline, description: description || "", imageUrl: imageUrl || "",
            status: 'active', highestBidderUid: null, highestBidderName: null, bids: {}, // bids is a map
            updatedAt: serverTimestamp(), sellerUid: currentAuthUser.uid, sellerName: currentUserData.name
        };
        try {
            if (itemId) {
                const itemRef = doc(db, "auctions", itemId);
                // When editing, we generally don't reset currentBid or bidders if auction is live.
                // For simplicity here, editing an active auction might be restricted or only allow description/image changes.
                // This example will update all fields, potentially resetting bids if startPrice changes.
                // A more robust edit would check item.status and only allow certain fields to change.
                await updateDoc(itemRef, { itemName, startPrice, deadline, description, imageUrl, updatedAt: serverTimestamp() }); // Not resetting bids/status on edit
                showInfoModal("성공", "경매 물품이 수정되었습니다.");
            } else {
                itemData.createdAt = serverTimestamp();
                await addDoc(collection(db, "auctions"), itemData);
                showInfoModal("성공", "새 경매 물품이 등록되었습니다.");
            }
            closeAuctionItemFormModal();
            loadAdminAuctionItems();
        } catch (error) { console.error("Error saving auction item:", error); showInfoModal("오류", "경매 물품 저장 중 오류가 발생했습니다."); }
    });

    async function loadAdminAuctionItems() {
        if (!currentAuthUser || !currentUserData || currentUserData.role !== 'teacher') {
            adminAuctionItemListEl.innerHTML = '<p class="text-stone-500">경매 물품 관리는 관리자만 가능합니다.</p>'; return;
        }
        adminAuctionItemListEl.innerHTML = '<p class="text-stone-500">경매 물품 목록을 불러오는 중...</p>';
        try {
            const q = query(collection(db, "auctions"), orderBy("createdAt", "desc"));
            const querySnapshot = await getDocs(q);
            adminAuctionItemListEl.innerHTML = '';
            if (querySnapshot.empty) { adminAuctionItemListEl.innerHTML = '<p class="text-stone-500">등록된 경매 물품이 없습니다.</p>'; return; }
            
            querySnapshot.forEach(docSnap => {
                const item = { id: docSnap.id, ...docSnap.data() };
                const itemDiv = document.createElement('div');
                itemDiv.className = "bg-stone-50 p-3 rounded-md border border-stone-200 flex justify-between items-center";
                itemDiv.innerHTML = `
                    <div>
                        <p class="font-medium text-indigo-600">${item.itemName} (현재가: ${formatCurrency(item.currentBid)})</p>
                        <p class="text-xs text-stone-500">판매자: ${item.sellerName || "알 수 없음"} | 마감: ${formatDate(item.deadline)} - 상태: ${item.status}</p>
                    </div>
                    <div class="space-x-2">
                        <button data-itemid="${item.id}" class="admin-edit-auction-item-btn bg-yellow-500 hover:bg-yellow-600 text-white text-xs py-1 px-2 rounded ${item.status !== 'active' ? 'opacity-50 cursor-not-allowed' : ''}" ${item.status !== 'active' ? 'disabled' : ''}>수정</button>
                        <button data-itemid="${item.id}" class="admin-cancel-auction-item-btn bg-stone-500 hover:bg-stone-600 text-white text-xs py-1 px-2 rounded ${item.status !== 'active' ? 'opacity-50 cursor-not-allowed' : ''}" ${item.status !== 'active' ? 'disabled' : ''}>취소</button>
                        <button data-itemid="${item.id}" class="admin-delete-auction-item-btn bg-red-500 hover:bg-red-600 text-white text-xs py-1 px-2 rounded">삭제</button>
                    </div>
                `;
                adminAuctionItemListEl.appendChild(itemDiv);
            });

            document.querySelectorAll('.admin-edit-auction-item-btn').forEach(button => {
                button.addEventListener('click', async (e) => {
                    const itemId = e.target.dataset.itemid;
                    const itemDoc = await getDoc(doc(db, "auctions", itemId));
                    if (itemDoc.exists()) showAuctionItemFormModal({ id: itemDoc.id, ...itemDoc.data() });
                });
            });
            document.querySelectorAll('.admin-cancel-auction-item-btn').forEach(button => {
                button.addEventListener('click', async (e) => {
                    const itemId = e.target.dataset.itemid;
                    if (!confirm('정말로 이 경매를 취소하시겠습니까? 모든 입찰금이 환불됩니다.')) return;

                    try {
                        const itemRef = doc(db, 'auctions', itemId);
                        const itemSnap = await getDoc(itemRef);
                        if (!itemSnap.exists()) { showInfoModal('오류', '경매 정보를 찾을 수 없습니다.'); return; }
                        const auction = itemSnap.data();
                        if (auction.status !== 'active') { showInfoModal('오류', '이미 종료되었거나 취소된 경매입니다.'); return; }

                        const batch = writeBatch(db);
                        const bids = auction.bids || {};
                        for (const bidderUid in bids) {
                            const bidData = bids[bidderUid];
                            const userRef = doc(db, 'users', bidderUid);
                            batch.update(userRef, { balance: increment(bidData.bidAmount) });
                            batch.set(doc(collection(userRef, 'transactions')), {
                                type: 'auction_cancel_refund',
                                description: `${auction.itemName} 경매 취소 환불`,
                                amount: bidData.bidAmount,
                                auctionId: itemId,
                                itemName: auction.itemName,
                                date: serverTimestamp()
                            });
                        }
                        batch.update(itemRef, { status: 'cancelled', updatedAt: serverTimestamp() });
                        await batch.commit();
                        showInfoModal('성공', '경매가 취소되었습니다.');
                        loadAdminAuctionItems();
                    } catch (error) {
                        console.error('Error cancelling auction:', error);
                        showInfoModal('오류', '경매 취소 중 오류가 발생했습니다.');
                    }
                });
            });

            document.querySelectorAll('.admin-delete-auction-item-btn').forEach(button => {
                button.addEventListener('click', async (e) => {
                    const itemId = e.target.dataset.itemid;
                    const itemDoc = await getDoc(doc(db, "auctions", itemId));
                    if (itemDoc.exists() && itemDoc.data().status === 'active' && Object.keys(itemDoc.data().bids || {}).length > 0) {
                         if (!confirm("이 경매는 현재 입찰이 진행 중입니다. 정말로 삭제하시겠습니까? 모든 입찰금은 환불되지 않습니다.")) return;
                    } else if (!confirm("정말로 이 경매 물품을 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다.")) return;
                    
                    try { await deleteDoc(doc(db, "auctions", itemId)); showInfoModal("성공", "경매 물품이 삭제되었습니다."); loadAdminAuctionItems(); } 
                    catch (error) { console.error("Error deleting auction item:", error); showInfoModal("오류", "경매 물품 삭제 중 오류 발생."); }
                });
            });
        } catch (error) { console.error("Error loading admin auction items:", error); adminAuctionItemListEl.innerHTML = '<p class="text-red-500">경매 물품 목록 로드 실패.</p>'; }
    }

    placeBidForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        if (!currentAuthUser || !currentUserData) { showInfoModal("오류", "입찰하려면 로그인이 필요합니다."); return; }
        
        const auctionId = bidAuctionIdInput.value;
        const newBidAmount = parseInt(bidAmountInput.value);

        if (isNaN(newBidAmount) || newBidAmount <= 0) { showInfoModal("오류", "유효한 입찰 금액을 입력하세요."); return; }

        const auctionRef = doc(db, "auctions", auctionId);
        const userRef = doc(db, "users", currentAuthUser.uid);

        try {
            await runTransaction(db, async (transaction) => {
                const auctionSnap = await transaction.get(auctionRef);
                const userSnap = await transaction.get(userRef);

                if (!auctionSnap.exists()) throw new Error("경매 물품을 찾을 수 없습니다.");
                if (!userSnap.exists()) throw new Error("사용자 정보를 찾을 수 없습니다.");

                const auction = auctionSnap.data();
                const user = userSnap.data();

                if (auction.status !== 'active') throw new Error("이미 종료된 경매입니다.");
                if (auction.deadline.toDate() <= new Date()) throw new Error("경매 시간이 종료되었습니다.");
                if (newBidAmount <= auction.currentBid) throw new Error(`입찰 금액은 현재 최고가(${formatCurrency(auction.currentBid)})보다 높아야 합니다.`);
                
                const userPreviousBidOnThisAuction = auction.bids?.[currentAuthUser.uid]?.bidAmount || 0;
                const amountToDeduct = newBidAmount - userPreviousBidOnThisAuction;

                if (user.balance < amountToDeduct) throw new Error(`잔액이 부족합니다. (필요 금액: ${formatCurrency(amountToDeduct)})`);

                // Update user balance
                transaction.update(userRef, { balance: increment(-amountToDeduct) });

                // Update auction item
                const newBidsMap = { ...auction.bids };
                newBidsMap[currentAuthUser.uid] = { 
                    bidAmount: newBidAmount, 
                    bidderName: currentUserData.name, 
                    timestamp: serverTimestamp() 
                };
                transaction.update(auctionRef, {
                    currentBid: newBidAmount,
                    highestBidderUid: currentAuthUser.uid,
                    highestBidderName: currentUserData.name,
                    bids: newBidsMap,
                    updatedAt: serverTimestamp()
                });
                
                // Log transaction for the user
                transaction.set(doc(collection(userRef, "transactions")), {
                    type: 'auction_bid',
                    description: `${auction.itemName}에 ${formatCurrency(newBidAmount)} 입찰 (차감액: ${formatCurrency(amountToDeduct)})`,
                    amount: amountToDeduct, // Log the actual deducted amount
                    auctionId: auctionId,
                    itemName: auction.itemName,
                    date: serverTimestamp()
                });
            });
            showInfoModal("입찰 성공", `${formatCurrency(newBidAmount)}으로 입찰했습니다.`);
            closePlaceBidModal();
        } catch (error) {
            console.error("Error placing bid:", error);
            showInfoModal("입찰 실패", `입찰 중 오류 발생: ${error.message}`);
        }
    });

    async function handleCancelBid(auctionId) {
        if (!currentAuthUser || !currentUserData) { showInfoModal("오류", "로그인이 필요합니다."); return; }
        if (!confirm("정말로 현재 최고 입찰을 취소하시겠습니까?")) return;

        const auctionRef = doc(db, "auctions", auctionId);
        const userRef = doc(db, "users", currentAuthUser.uid);

        try {
            await runTransaction(db, async (transaction) => {
                const auctionSnap = await transaction.get(auctionRef);
                const userSnap = await transaction.get(userRef);

                if (!auctionSnap.exists()) throw new Error("경매 물품을 찾을 수 없습니다.");
                if (!userSnap.exists()) throw new Error("사용자 정보를 찾을 수 없습니다.");

                const auction = auctionSnap.data();
                const user = userSnap.data();

                if (auction.status !== 'active') throw new Error("종료된 경매의 입찰은 취소할 수 없습니다.");
                if (auction.highestBidderUid !== currentAuthUser.uid) throw new Error("최고 입찰자만 입찰을 취소할 수 있습니다.");
                
                const bidToCancelAmount = auction.currentBid; // This is the amount to refund

                // Refund user
                transaction.update(userRef, { balance: increment(bidToCancelAmount) });

                // Update auction: remove this user's bid and find new highest bidder
                const updatedBidsMap = { ...auction.bids };
                delete updatedBidsMap[currentAuthUser.uid];

                let newHighestBid = auction.startPrice;
                let newHighestBidderUid = null;
                let newHighestBidderName = null;

                if (Object.keys(updatedBidsMap).length > 0) {
                    let tempHighest = 0;
                    for (const bidderUid in updatedBidsMap) {
                        if (updatedBidsMap[bidderUid].bidAmount > tempHighest) {
                            tempHighest = updatedBidsMap[bidderUid].bidAmount;
                            newHighestBidderUid = bidderUid;
                            newHighestBidderName = updatedBidsMap[bidderUid].bidderName;
                        }
                    }
                    newHighestBid = tempHighest;
                }
                
                transaction.update(auctionRef, {
                    currentBid: newHighestBid,
                    highestBidderUid: newHighestBidderUid,
                    highestBidderName: newHighestBidderName,
                    bids: updatedBidsMap,
                    updatedAt: serverTimestamp()
                });

                // Log transaction for user
                transaction.set(doc(collection(userRef, "transactions")), {
                    type: 'auction_bid_cancel',
                    description: `${auction.itemName} 입찰 취소 (환급: ${formatCurrency(bidToCancelAmount)})`,
                    amount: bidToCancelAmount,
                    auctionId: auctionId,
                    itemName: auction.itemName,
                    date: serverTimestamp()
                });
            });
            showInfoModal("입찰 취소 성공", `입찰이 취소되었고 ${formatCurrency(auction.currentBid)}이 환급되었습니다.`);
        } catch (error) {
            console.error("Error cancelling bid:", error);
            showInfoModal("입찰 취소 실패", `취소 중 오류 발생: ${error.message}`);
        }
    }
    
    async function checkAndProcessEndedAuctions() {
        console.log("Checking for ended auctions...");
        const now = Timestamp.now();
        const q = query(collection(db, "auctions"), where("status", "==", "active"), where("deadline", "<=", now));
        const snapshot = await getDocs(q);

        if (snapshot.empty) {
            console.log("No active auctions have ended right now.");
            return;
        }
        
        const batch = writeBatch(db); // Use a batch for multiple updates/refunds

        for (const docSnap of snapshot.docs) {
            const auctionId = docSnap.id;
            const auction = docSnap.data();
            const auctionRef = doc(db, "auctions", auctionId);
            console.log(`Processing ended auction: ${auction.itemName} (ID: ${auctionId})`);

            if (auction.highestBidderUid) { // There's a winner
                batch.update(auctionRef, { status: "ended_sold", updatedAt: serverTimestamp() });
                console.log(`Auction ${auctionId} sold to ${auction.highestBidderName}`);
                // Refund other bidders
                for (const bidderUid in auction.bids) {
                    if (bidderUid !== auction.highestBidderUid) {
                        const losingBid = auction.bids[bidderUid];
                        const userToRefundRef = doc(db, "users", bidderUid);
                        batch.update(userToRefundRef, { balance: increment(losingBid.bidAmount) });
                        
                        const transactionRef = doc(collection(db, "users", bidderUid, "transactions"));
                        batch.set(transactionRef, {
                            type: 'auction_refund_lost',
                            description: `${auction.itemName} 경매 낙찰 실패 환불`,
                            amount: losingBid.bidAmount,
                            auctionId: auctionId,
                            itemName: auction.itemName,
                            date: serverTimestamp()
                        });
                        console.log(`Refunding ${formatCurrency(losingBid.bidAmount)} to user ${bidderUid} for auction ${auctionId}`);
                    }
                }
            } else { // No winner
                batch.update(auctionRef, { status: "ended_unsold", updatedAt: serverTimestamp() });
                console.log(`Auction ${auctionId} ended unsold.`);
                // If there were any bids that were somehow not cleared (e.g. all cancelled, but map not empty)
                // This part is a safeguard; ideally, if no highestBidderUid, bids map should be empty or auction.currentBid = startPrice
                for (const bidderUid in auction.bids) {
                    const bidData = auction.bids[bidderUid];
                    const userToRefundRef = doc(db, "users", bidderUid);
                    batch.update(userToRefundRef, { balance: increment(bidData.bidAmount) });
                    
                    const transactionRef = doc(collection(db, "users", bidderUid, "transactions"));
                    batch.set(transactionRef, {
                        type: 'auction_refund_lost', // Or a specific 'auction_no_winner_refund'
                        description: `${auction.itemName} 경매 유찰로 인한 입찰금 환불`,
                        amount: bidData.bidAmount,
                        auctionId: auctionId,
                        itemName: auction.itemName,
                        date: serverTimestamp()
                    });
                    console.log(`Refunding ${formatCurrency(bidData.bidAmount)} to user ${bidderUid} for unsold auction ${auctionId}`);
                }
            }
        }
        try {
            await batch.commit();
            console.log("Successfully processed ended auctions and refunds.");
            // No need to manually call loadAndRenderAuctionItems here, onSnapshot will trigger it.
        } catch (error) {
            console.error("Error processing ended auctions with batch:", error);
            showInfoModal("경매 종료 처리 오류", "일부 경매 종료 처리에 실패했습니다.");
        }
    }


    // --- Mobile Sidebar Toggle ---
    const sidebar = document.getElementById('sidebar'); /* ... */
    const sidebarToggle = document.getElementById('sidebarToggle');
    const mainContentForSidebar = document.getElementById('mainContent');
    sidebarToggle.addEventListener('click', () => sidebar.classList.toggle('open'));
    mainContentForSidebar.addEventListener('click', () => { if (sidebar.classList.contains('open')) sidebar.classList.remove('open'); });

    // --- Initial Load ---
    function startManseungApp() { 
        showSection('login', true); 
        // Initial check for ended auctions when app loads (after auth)
        onAuthStateChanged(auth, (user) => {
            if (user) {
                setTimeout(checkAndProcessEndedAuctions, 3000); // Delay slightly to ensure other data might be ready
            }
        });
    }

    startManseungApp(); 

</script>
</body>
</html>
